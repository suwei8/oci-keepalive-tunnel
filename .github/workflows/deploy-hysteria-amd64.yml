name: Deploy Hysteria v2 (AMD64)

on:
  schedule:
    - cron: "0 3 * * 1"
  workflow_dispatch:
    inputs:
      force_redeploy:
        description: 'å¼ºåˆ¶é‡æ–°éƒ¨ç½² (å³ä½¿å®¹å™¨å·²å­˜åœ¨)'
        required: false
        default: 'false'
        type: choice
        options:
          - 'false'
          - 'true'
      update_image:
        description: 'æ›´æ–° Docker é•œåƒ (æ‹‰å–æœ€æ–°ç‰ˆ)'
        required: false
        default: 'false'
        type: choice
        options:
          - 'false'
          - 'true'
      target_host:
        description: 'æŒ‡å®šéƒ¨ç½²ä¸»æœº (ç•™ç©º=å…¨éƒ¨)'
        required: false
        default: ''

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false

jobs:
  deploy:
    name: "Deploy Hysteria"
    runs-on: ubuntu-latest
    timeout-minutes: 60
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install cloudflared
        run: |
          sudo cp bin/cloudflared /usr/local/bin/cloudflared
          cloudflared --version

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          cat >> ~/.ssh/config << 'EOF'
          Host *
            StrictHostKeyChecking no
            UserKnownHostsFile /dev/null
            LogLevel ERROR
          EOF
          sudo apt-get update -qq && sudo apt-get install -y -qq sshpass jq

      - name: Deploy to all hosts
        id: deploy
        env:
          HOSTS_CONFIG: ${{ secrets.HOSTS_CONFIG }}
          SSH_USERNAME: ${{ secrets.SSH_USERNAME }}
          SSH_PASSWORD: ${{ secrets.SSH_PASSWORD }}
          CF_API_EMAIL: ${{ secrets.CF_API_EMAIL }}
          CF_API_KEY: ${{ secrets.CF_API_KEY }}
          CF_ZONE_ID: ${{ secrets.CF_ZONE_ID }}
          HYSTERIA_PASSWORD: ${{ secrets.HYSTERIA_PASSWORD }}
          FORCE_REDEPLOY: ${{ github.event.inputs.force_redeploy }}
          UPDATE_IMAGE: ${{ github.event.inputs.update_image }}
          TARGET_HOST: ${{ github.event.inputs.target_host }}
        run: |
          SSH_OPTS="-o ConnectTimeout=30 -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR -o ServerAliveInterval=30"
          
          NODES_INFO=""
          DEPLOYED_COUNT=0
          SKIPPED_COUNT=0
          UPDATED_COUNT=0
          
          HOST_COUNT=$(echo "$HOSTS_CONFIG" | jq '. | length')
          echo "Total hosts: $HOST_COUNT"
          
          # å®šæ—¶ä»»åŠ¡æ—¶è‡ªåŠ¨æ›´æ–°é•œåƒ
          if [ "${{ github.event_name }}" = "schedule" ]; then
            UPDATE_IMAGE="true"
          fi
          
          for INDEX in $(seq 0 $((HOST_COUNT - 1))); do
            host_item=$(echo "$HOSTS_CONFIG" | jq -c ".[$INDEX]")
            HOST_NAME=$(echo "$host_item" | jq -r '.name')
            SSH_HOST=$(echo "$host_item" | jq -r '.ssh_host')
            PROXY_DOMAIN=$(echo "$host_item" | jq -r '.proxy_domains')
            CPU_TYPE=$(echo "$host_item" | jq -r '.cpu_type')
            
            # éšè—æ•æ„Ÿä¿¡æ¯
            echo "::add-mask::$SSH_HOST"
            echo "::add-mask::$PROXY_DOMAIN"
            
            if [ "$HOST_NAME" = "null" ] || [ -z "$HOST_NAME" ]; then
              continue
            fi
            
            # åªå¤„ç† amd64 ç±»å‹çš„ä¸»æœº
            if [ "$CPU_TYPE" != "amd64" ]; then
              continue
            fi
            
            if [ -n "$TARGET_HOST" ] && [ "$HOST_NAME" != "$TARGET_HOST" ]; then
              continue
            fi
            
            echo ""
            echo "==========================================="
            echo "Processing: $HOST_NAME"
            echo "==========================================="
            
            pkill -f "cloudflared.*2222" 2>/dev/null || true
            sleep 2
            cloudflared access ssh --hostname "$SSH_HOST" --url "ssh://127.0.0.1:2222" &
            TUNNEL_PID=$!
            sleep 5
            
            if ! kill -0 $TUNNEL_PID 2>/dev/null; then
              echo "âŒ Tunnel è¿æ¥å¤±è´¥"
              continue
            fi
            
            # è·å–å…¬ç½‘ IP (ç”¨äº DNS é…ç½®)
            PUBLIC_IP=$(sshpass -p "$SSH_PASSWORD" ssh $SSH_OPTS -n -p 2222 "${SSH_USERNAME}@127.0.0.1" 'curl -4 -s ip.sb' 2>&1) || true
            if [ -z "$PUBLIC_IP" ]; then
              echo "âŒ æ— æ³•è·å–å…¬ç½‘ IP"
              kill $TUNNEL_PID 2>/dev/null || true
              continue
            fi
            echo "::add-mask::$PUBLIC_IP"
            MASKED_IP=$(echo "$PUBLIC_IP" | awk -F. '{print $1"."$2".*.*"}')
            echo "âœ… å…¬ç½‘ IP: $MASKED_IP"
            
            # DNS é…ç½® (æ¯æ¬¡éƒ½æ£€æŸ¥ï¼Œç¡®ä¿ DNS è®°å½•å­˜åœ¨)
            echo ">>> æ£€æŸ¥ DNS..."
            DNS_RECORD=$(curl -s "https://api.cloudflare.com/client/v4/zones/${CF_ZONE_ID}/dns_records?name=${PROXY_DOMAIN}" -H "X-Auth-Email: ${CF_API_EMAIL}" -H "X-Auth-Key: ${CF_API_KEY}" | jq -r '.result[0].content // empty')
            
            if [ -z "$DNS_RECORD" ]; then
              echo ">>> åˆ›å»º DNS A è®°å½•: ${PROXY_DOMAIN} -> ${MASKED_IP}"
              DNS_RESULT=$(curl -s -X POST "https://api.cloudflare.com/client/v4/zones/${CF_ZONE_ID}/dns_records" -H "X-Auth-Email: ${CF_API_EMAIL}" -H "X-Auth-Key: ${CF_API_KEY}" -H "Content-Type: application/json" -d "{\"type\":\"A\",\"name\":\"${PROXY_DOMAIN}\",\"content\":\"${PUBLIC_IP}\",\"proxied\":false,\"ttl\":1}")
              if echo "$DNS_RESULT" | jq -e '.success' > /dev/null; then
                echo "âœ… DNS è®°å½•å·²åˆ›å»º"
              else
                echo "âŒ DNS åˆ›å»ºå¤±è´¥"
                echo "$DNS_RESULT" | jq '.errors'
              fi
            elif [ "$DNS_RECORD" != "$PUBLIC_IP" ]; then
              echo ">>> æ›´æ–° DNS A è®°å½•: ${PROXY_DOMAIN} -> ${MASKED_IP}"
              RECORD_ID=$(curl -s "https://api.cloudflare.com/client/v4/zones/${CF_ZONE_ID}/dns_records?name=${PROXY_DOMAIN}" -H "X-Auth-Email: ${CF_API_EMAIL}" -H "X-Auth-Key: ${CF_API_KEY}" | jq -r '.result[0].id')
              curl -s -X PUT "https://api.cloudflare.com/client/v4/zones/${CF_ZONE_ID}/dns_records/${RECORD_ID}" -H "X-Auth-Email: ${CF_API_EMAIL}" -H "X-Auth-Key: ${CF_API_KEY}" -H "Content-Type: application/json" -d "{\"type\":\"A\",\"name\":\"${PROXY_DOMAIN}\",\"content\":\"${PUBLIC_IP}\",\"proxied\":false,\"ttl\":1}" > /dev/null
              echo "âœ… DNS è®°å½•å·²æ›´æ–°"
            else
              echo "âœ… DNS è®°å½•å·²å­˜åœ¨ä¸”æ­£ç¡®"
            fi
            
            # æ¯æ¬¡è¿æ¥éƒ½æ£€æŸ¥å¹¶å¼€æ”¾ iptables ç«¯å£
            echo ">>> æ£€æŸ¥ iptables ç«¯å£..."
            sshpass -p "$SSH_PASSWORD" ssh $SSH_OPTS -n -p 2222 "${SSH_USERNAME}@127.0.0.1" "
              # æ£€æŸ¥å¹¶å¼€æ”¾ 80 ç«¯å£ (SSL è¯ä¹¦éªŒè¯)
              if ! sudo iptables -C INPUT -p tcp --dport 80 -j ACCEPT 2>/dev/null; then
                sudo iptables -I INPUT -p tcp --dport 80 -j ACCEPT
                echo 'å·²å¼€æ”¾ 80 ç«¯å£'
              fi
              # æ£€æŸ¥å¹¶å¼€æ”¾ 2443 ç«¯å£ (Hysteria)
              if ! sudo iptables -C INPUT -p tcp --dport 2443 -j ACCEPT 2>/dev/null; then
                sudo iptables -I INPUT -p tcp --dport 2443 -j ACCEPT
                echo 'å·²å¼€æ”¾ 2443 TCP ç«¯å£'
              fi
              if ! sudo iptables -C INPUT -p udp --dport 2443 -j ACCEPT 2>/dev/null; then
                sudo iptables -I INPUT -p udp --dport 2443 -j ACCEPT
                echo 'å·²å¼€æ”¾ 2443 UDP ç«¯å£'
              fi
              # ä¿å­˜è§„åˆ™
              sudo netfilter-persistent save 2>/dev/null || true
            " 2>&1 || true
            echo "âœ… iptables ç«¯å£æ£€æŸ¥å®Œæˆ"
            
            # æ£€æŸ¥å®¹å™¨çŠ¶æ€
            CONTAINER_EXISTS=$(sshpass -p "$SSH_PASSWORD" ssh $SSH_OPTS -n -p 2222 "${SSH_USERNAME}@127.0.0.1" 'docker ps -a --format "{{.Names}}" | grep -q "^hysteria-server$" && echo "yes" || echo "no"' 2>&1) || true
            
            # å¦‚æœå®¹å™¨å­˜åœ¨ï¼ŒéªŒè¯é…ç½®æ˜¯å¦æ­£ç¡®
            CONFIG_VALID="yes"
            if [ "$CONTAINER_EXISTS" = "yes" ]; then
              echo ">>> éªŒè¯é…ç½®æ–‡ä»¶..."
              CONFIG_DOMAIN=$(sshpass -p "$SSH_PASSWORD" ssh $SSH_OPTS -n -p 2222 "${SSH_USERNAME}@127.0.0.1" "grep -oP 'cert: /etc/letsencrypt/live/\K[^/]+' /home/sw/docker_root/hy/hy.yaml 2>/dev/null || echo 'UNKNOWN'" 2>&1 | tail -1) || true
              if [ "$CONFIG_DOMAIN" != "$PROXY_DOMAIN" ]; then
                echo "âš ï¸ é…ç½®åŸŸåä¸åŒ¹é…: å½“å‰='$CONFIG_DOMAIN', åº”ä¸º='$PROXY_DOMAIN'"
                CONFIG_VALID="no"
              else
                echo "âœ… é…ç½®åŸŸåæ­£ç¡®"
              fi
            fi
            
            # å¦‚æœæ˜¯æ›´æ–°æ¨¡å¼ä¸”å®¹å™¨å­˜åœ¨ï¼Œæ‰§è¡Œæ›´æ–°ï¼ˆåŒæ—¶ä¿®å¤é…ç½®ï¼‰
            if [ "$CONTAINER_EXISTS" = "yes" ] && [ "$UPDATE_IMAGE" = "true" ]; then
              echo ">>> æ›´æ–° Hysteria é•œåƒ..."
              # å¦‚æœé…ç½®æ— æ•ˆï¼Œå…ˆä¿®å¤é…ç½®
              if [ "$CONFIG_VALID" = "no" ]; then
                echo ">>> ä¿®å¤é…ç½®æ–‡ä»¶..."
                sshpass -p "$SSH_PASSWORD" ssh $SSH_OPTS -n -p 2222 "${SSH_USERNAME}@127.0.0.1" "cat > /home/sw/docker_root/hy/hy.yaml << EOFHY
          listen: :2443
          tls:
            cert: /etc/letsencrypt/live/${PROXY_DOMAIN}/fullchain.pem
            key: /etc/letsencrypt/live/${PROXY_DOMAIN}/privkey.pem
          auth:
            type: password
            password: ${HYSTERIA_PASSWORD}
          disableUDP: false
          bandwidth:
            up: 1000 mbps
            down: 1000 mbps
          masquerade:
            type: proxy
            proxy:
              url: https://www.kernel.org/
              rewriteHost: true
          resolver:
            type: udp
            udp:
              addr: 1.1.1.1:53
              timeout: 4s
          EOFHY" 2>&1 || true
                echo "âœ… é…ç½®å·²ä¿®å¤"
              fi
              sshpass -p "$SSH_PASSWORD" ssh $SSH_OPTS -n -p 2222 "${SSH_USERNAME}@127.0.0.1" 'cd /home/sw/docker_root/hy && sudo docker compose pull && sudo docker compose up -d' 2>&1 || true
              UPDATED_COUNT=$((UPDATED_COUNT + 1))
              echo "âœ… é•œåƒå·²æ›´æ–°"
              NODES_INFO="${NODES_INFO}hysteria2://${HYSTERIA_PASSWORD}@${PROXY_DOMAIN}:2443?insecure=0&sni=${PROXY_DOMAIN}#${HOST_NAME}\n"
              kill $TUNNEL_PID 2>/dev/null || true
              continue
            fi
            
            # å¦‚æœé…ç½®æ— æ•ˆï¼Œå¼ºåˆ¶é‡æ–°éƒ¨ç½²
            if [ "$CONFIG_VALID" = "no" ]; then
              echo ">>> é…ç½®æ— æ•ˆï¼Œå¼ºåˆ¶é‡æ–°éƒ¨ç½²..."
              FORCE_REDEPLOY="true"
            fi
            
            if [ "$CONTAINER_EXISTS" = "yes" ] && [ "$FORCE_REDEPLOY" != "true" ]; then
              echo "â­ï¸ å®¹å™¨å·²å­˜åœ¨ä¸”é…ç½®æ­£ç¡®ï¼Œè·³è¿‡éƒ¨ç½²"
              SKIPPED_COUNT=$((SKIPPED_COUNT + 1))
              NODES_INFO="${NODES_INFO}hysteria2://${HYSTERIA_PASSWORD}@${PROXY_DOMAIN}:2443?insecure=0&sni=${PROXY_DOMAIN}#${HOST_NAME}\n"
              kill $TUNNEL_PID 2>/dev/null || true
              continue
            fi
            
            echo ">>> å¼€å§‹éƒ¨ç½²..."
            
            # SSL è¯ä¹¦æ£€æŸ¥ (éœ€è¦ sudo æƒé™è®¿é—® letsencrypt ç›®å½•)
            echo ">>> æ£€æŸ¥ SSL..."
            CERT_EXISTS=$(sshpass -p "$SSH_PASSWORD" ssh $SSH_OPTS -n -p 2222 "${SSH_USERNAME}@127.0.0.1" "sudo test -f /etc/letsencrypt/live/${PROXY_DOMAIN}/fullchain.pem && echo CERT_FOUND || echo CERT_MISSING" 2>/dev/null | tail -1) || true
            echo ">>> è¯ä¹¦çŠ¶æ€: $CERT_EXISTS"
            
            if [ "$CERT_EXISTS" = "CERT_FOUND" ]; then
              echo "âœ… SSL è¯ä¹¦å·²å­˜åœ¨"
            else
              echo ">>> ç”³è¯· SSL è¯ä¹¦..."
              sshpass -p "$SSH_PASSWORD" ssh $SSH_OPTS -n -p 2222 "${SSH_USERNAME}@127.0.0.1" "
                which certbot > /dev/null 2>&1 || (sudo apt-get update -qq && sudo apt-get install -y -qq certbot)
                # åœæ­¢æ‰€æœ‰å ç”¨ç«¯å£80çš„æœåŠ¡
                sudo systemctl stop nginx 2>/dev/null || true
                sudo docker stop \$(sudo docker ps -q --filter 'publish=80') 2>/dev/null || true
                sudo docker stop nginx 2>/dev/null || true
                sudo docker stop hysteria-server 2>/dev/null || true
                sudo fuser -k 80/tcp 2>/dev/null || true
                sleep 2
                sudo certbot certonly --standalone -d ${PROXY_DOMAIN} --non-interactive --agree-tos --email ${CF_API_EMAIL} --http-01-port 80 || true
                sudo systemctl start nginx 2>/dev/null || true
              " 2>&1
              
              # éªŒè¯è¯ä¹¦æ˜¯å¦å­˜åœ¨
              CERT_CHECK=$(sshpass -p "$SSH_PASSWORD" ssh $SSH_OPTS -n -p 2222 "${SSH_USERNAME}@127.0.0.1" "sudo test -f /etc/letsencrypt/live/${PROXY_DOMAIN}/fullchain.pem && echo CERT_FOUND || echo CERT_MISSING" 2>/dev/null | tail -1) || true
              echo ">>> éªŒè¯ç»“æœ: $CERT_CHECK"
              
              if [ "$CERT_CHECK" = "CERT_FOUND" ]; then
                echo "âœ… SSL è¯ä¹¦å°±ç»ª"
              else
                echo "âŒ SSL è¯ä¹¦ç”³è¯·å¤±è´¥"
                kill $TUNNEL_PID 2>/dev/null || true
                continue
              fi
            fi
            
            # åˆ›å»ºé…ç½®æ–‡ä»¶
            echo ">>> åˆ›å»ºé…ç½®æ–‡ä»¶..."
            sshpass -p "$SSH_PASSWORD" ssh $SSH_OPTS -n -p 2222 "${SSH_USERNAME}@127.0.0.1" "mkdir -p /home/sw/docker_root/hy" 2>&1 || true
            
            # docker-compose.yml
            sshpass -p "$SSH_PASSWORD" ssh $SSH_OPTS -n -p 2222 "${SSH_USERNAME}@127.0.0.1" "cat > /home/sw/docker_root/hy/docker-compose.yml << 'EOFCOMPOSE'
          services:
            hysteria:
              image: tobyxdd/hysteria:latest
              container_name: hysteria-server
              restart: always
              network_mode: host
              volumes:
                - ./hy.yaml:/etc/hysteria/hysteria.yaml
                - /etc/letsencrypt:/etc/letsencrypt
              environment:
                - TZ=Asia/Jakarta
                - HYSTERIA_DISABLE_UPDATE_CHECK=1
                - HYSTERIA_LOG_LEVEL=info
              cap_add:
                - NET_ADMIN
                - NET_BIND_SERVICE
              devices:
                - /dev/net/tun:/dev/net/tun
              command: [server, -c, /etc/hysteria/hysteria.yaml]
          EOFCOMPOSE" 2>&1 || true
            
            # hy.yaml
            sshpass -p "$SSH_PASSWORD" ssh $SSH_OPTS -n -p 2222 "${SSH_USERNAME}@127.0.0.1" "cat > /home/sw/docker_root/hy/hy.yaml << EOFHY
          listen: :2443
          tls:
            cert: /etc/letsencrypt/live/${PROXY_DOMAIN}/fullchain.pem
            key: /etc/letsencrypt/live/${PROXY_DOMAIN}/privkey.pem
          auth:
            type: password
            password: ${HYSTERIA_PASSWORD}
          disableUDP: false
          bandwidth:
            up: 1000 mbps
            down: 1000 mbps
          masquerade:
            type: proxy
            proxy:
              url: https://www.kernel.org/
              rewriteHost: true
          resolver:
            type: udp
            udp:
              addr: 1.1.1.1:53
              timeout: 4s
          EOFHY" 2>&1 || true
            
            echo "âœ… é…ç½®æ–‡ä»¶å·²åˆ›å»º"
            
            # å¯åŠ¨å®¹å™¨ (å¸¦é‡è¯•)
            echo ">>> å¯åŠ¨å®¹å™¨..."
            CONTAINER_OK="no"
            for RETRY in 1 2 3; do
              echo ">>> å°è¯•å¯åŠ¨ (ç¬¬ $RETRY æ¬¡)..."
              
              sshpass -p "$SSH_PASSWORD" ssh $SSH_OPTS -n -p 2222 "${SSH_USERNAME}@127.0.0.1" "
                cd /home/sw/docker_root/hy
                # å¼ºåˆ¶åˆ é™¤æ—§å®¹å™¨é¿å…åç§°å†²çª
                sudo docker rm -f hysteria-server 2>/dev/null || true
                sudo docker compose down 2>/dev/null || true
                sudo docker compose pull 2>/dev/null || true
                sudo docker compose up -d
                
                # ç­‰å¾…å®¹å™¨å¯åŠ¨
                sleep 5
                
                # æ£€æŸ¥å®¹å™¨æ˜¯å¦å¥åº·è¿è¡Œ
                if sudo docker ps | grep -q hysteria-server; then
                  # æ£€æŸ¥æ—¥å¿—æ˜¯å¦æœ‰å¯åŠ¨æˆåŠŸæ ‡å¿—
                  if sudo docker logs hysteria-server 2>&1 | grep -q 'server up and running'; then
                    echo 'CONTAINER_HEALTHY'
                  else
                    echo 'CONTAINER_STARTING'
                    sudo docker logs hysteria-server 2>&1 | tail -3
                  fi
                else
                  echo 'CONTAINER_FAILED'
                  sudo docker logs hysteria-server 2>&1 | tail -5
                fi
              " 2>&1 | tee /tmp/container_output.txt
              
              if grep -q "CONTAINER_HEALTHY" /tmp/container_output.txt; then
                CONTAINER_OK="yes"
                break
              elif grep -q "CONTAINER_STARTING" /tmp/container_output.txt; then
                echo ">>> å®¹å™¨å¯åŠ¨ä¸­ï¼Œç­‰å¾… 5 ç§’..."
                sleep 5
                # å†æ¬¡æ£€æŸ¥
                CHECK=$(sshpass -p "$SSH_PASSWORD" ssh $SSH_OPTS -n -p 2222 "${SSH_USERNAME}@127.0.0.1" "docker logs hysteria-server 2>&1 | grep -q 'server up and running' && echo OK" 2>&1) || true
                if [ "$CHECK" = "OK" ]; then
                  CONTAINER_OK="yes"
                  break
                fi
              fi
              
              echo ">>> å¯åŠ¨å¤±è´¥ï¼Œç­‰å¾…é‡è¯•..."
              sleep 3
            done
            
            if [ "$CONTAINER_OK" = "yes" ]; then
              echo "âœ… éƒ¨ç½²æˆåŠŸ: $HOST_NAME"
              DEPLOYED_COUNT=$((DEPLOYED_COUNT + 1))
              NODES_INFO="${NODES_INFO}hysteria2://${HYSTERIA_PASSWORD}@${PROXY_DOMAIN}:2443?insecure=0&sni=${PROXY_DOMAIN}#${HOST_NAME}\n"
            else
              echo "âŒ éƒ¨ç½²å¤±è´¥: $HOST_NAME (3æ¬¡é‡è¯•åä»å¤±è´¥)"
            fi
            
            kill $TUNNEL_PID 2>/dev/null || true
          done
          
          echo ""
          echo "==========================================="
          echo "å®Œæˆ: æ–°éƒ¨ç½² $DEPLOYED_COUNT, æ›´æ–° $UPDATED_COUNT, è·³è¿‡ $SKIPPED_COUNT"
          echo "==========================================="
          
          echo -e "$NODES_INFO" > /tmp/nodes_info.txt

      - name: Send Telegram notification
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          if [ -z "$TELEGRAM_BOT_TOKEN" ] || [ -z "$TELEGRAM_CHAT_ID" ]; then
            echo "âš ï¸ Telegram æœªé…ç½®"
            exit 0
          fi
          
          if [ ! -s /tmp/nodes_info.txt ]; then
            echo "âš ï¸ æ— èŠ‚ç‚¹ä¿¡æ¯"
            exit 0
          fi
          
          TIMESTAMP=$(date -u +'%Y-%m-%d %H:%M UTC')
          NODE_COUNT=$(cat /tmp/nodes_info.txt | grep -v "^$" | wc -l)
          
          # èŠ‚ç‚¹åˆ—è¡¨ (å®Œæ•´ URI)
          NODES_FULL=$(cat /tmp/nodes_info.txt | grep -v "^$" | head -20)
          
          FINAL_MSG=$(printf "ğŸš€ *Hysteria v2 éƒ¨ç½²å®Œæˆ (AMD64)*\n\nğŸ“… %s\n\nâœ… *å…± %s ä¸ªèŠ‚ç‚¹*\n\nğŸ“‹ *å®¢æˆ·ç«¯è¿æ¥ä¿¡æ¯:*\n\`\`\`\n%s\n\`\`\`\n\nğŸ’¡ å¤åˆ¶ä¸Šæ–¹é“¾æ¥å¯¼å…¥å®¢æˆ·ç«¯å³å¯ä½¿ç”¨" "$TIMESTAMP" "$NODE_COUNT" "$NODES_FULL")
          
          # æ”¯æŒå¤šä¸ª chat_id (é€—å·åˆ†éš”)
          IFS=',' read -ra CHAT_IDS <<< "$TELEGRAM_CHAT_ID"
          for chat_id in "${CHAT_IDS[@]}"; do
            chat_id=$(echo "$chat_id" | xargs)
            if [ -n "$chat_id" ]; then
              curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
                -d chat_id="${chat_id}" \
                -d parse_mode="Markdown" \
                --data-urlencode "text=${FINAL_MSG}" > /dev/null
            fi
          done
          
          echo "âœ… Telegram å·²å‘é€"

      - name: Push to blog repository
        env:
          BLOG_GITHUB_TOKEN: ${{ secrets.BLOG_GITHUB_TOKEN }}
        run: |
          if [ -z "$BLOG_GITHUB_TOKEN" ]; then
            echo "âš ï¸ BLOG_GITHUB_TOKEN æœªé…ç½®"
            exit 0
          fi
          
          if [ ! -s /tmp/nodes_info.txt ]; then
            echo "âš ï¸ æ— èŠ‚ç‚¹ä¿¡æ¯"
            exit 0
          fi
          
          git clone "https://${BLOG_GITHUB_TOKEN}@github.com/suwei8/blog.git" /tmp/blog
          cd /tmp/blog
          
          TIMESTAMP=$(date -u +'%Y-%m-%d %H:%M UTC')
          echo "# Hysteria v2 èŠ‚ç‚¹åˆ—è¡¨ (AMD64)" > hy2_amd64.txt
          echo "# æ›´æ–°æ—¶é—´: $TIMESTAMP" >> hy2_amd64.txt
          echo "" >> hy2_amd64.txt
          cat /tmp/nodes_info.txt | grep -v "^$" >> hy2_amd64.txt
          
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add hy2_amd64.txt
          git diff --staged --quiet || git commit -m "Update Hysteria v2 AMD64 nodes $(date -u +%Y-%m-%d)"
          git push
          
          echo "âœ… å·²æ¨é€åˆ° blog ä»“åº“"

      - name: Summary
        run: |
          echo "## ğŸš€ Hysteria v2 éƒ¨ç½²ç»“æœ (AMD64)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -s /tmp/nodes_info.txt ]; then
            echo "### âœ… èŠ‚ç‚¹åˆ—è¡¨" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            cat /tmp/nodes_info.txt | grep -v "^$" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          else
            echo "æ— èŠ‚ç‚¹ä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
          fi
