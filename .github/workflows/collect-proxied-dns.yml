name: Collect Cloudflare Proxied DNS

on:
  schedule:
    - cron: "0 17 * * *"  # æ¯å¤©åŒ—äº¬æ—¶é—´å‡Œæ™¨ 1 ç‚¹ (UTC 17:00)
  workflow_dispatch:

jobs:
  collect-proxied-dns:
    name: "Collect Proxied DNS Records"
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Collect proxied DNS records
        env:
          # ynshanghui.com
          CF_API_EMAIL: ${{ secrets.CF_API_EMAIL }}
          CF_API_KEY: ${{ secrets.CF_API_KEY }}
          CF_ZONE_ID: ${{ secrets.CF_ZONE_ID }}
          # 555606.xyz
          CF_API_EMAIL_555606: ${{ secrets.CF_API_EMAIL_555606 }}
          CF_API_KEY_555606: ${{ secrets.CF_API_KEY_555606 }}
          CF_ZONE_ID_555606: ${{ secrets.CF_ZONE_ID_555606 }}
        run: |
          # éƒ¨åˆ†éšè—åŸŸåå‡½æ•° (å¦‚: xxx.555606.xyz -> xxx.**606.xyz)
          mask_domain() {
            local domain="$1"
            # è·å–å­åŸŸåå’Œä¸»åŸŸåéƒ¨åˆ†
            local subdomain=$(echo "$domain" | rev | cut -d. -f3- | rev)
            local main_domain=$(echo "$domain" | rev | cut -d. -f1-2 | rev)
            # éšè—ä¸»åŸŸåçš„å‰3ä¸ªå­—ç¬¦
            local masked_main=$(echo "$main_domain" | sed 's/^\(...\)/\*\*/')
            echo "${subdomain}.**${main_domain: -7}"
          }
          
          # åˆ›å»ºä¸´æ—¶æ–‡ä»¶
          > /tmp/proxied_domains.txt
          
          echo ">>> æ”¶é›†ç¬¬ä¸€ä¸ªè´¦æˆ·çš„ proxied DNS è®°å½•..."
          # ynshanghui.com
          RECORDS=$(curl -s "https://api.cloudflare.com/client/v4/zones/${CF_ZONE_ID}/dns_records?per_page=500" \
            -H "X-Auth-Email: ${CF_API_EMAIL}" \
            -H "X-Auth-Key: ${CF_API_KEY}")
          
          echo "$RECORDS" | jq -r '.result[] | select(.proxied == true) | .name' >> /tmp/proxied_domains.txt
          COUNT1=$(echo "$RECORDS" | jq '[.result[] | select(.proxied == true)] | length')
          # éšè—åŸå§‹åŸŸå
          echo "::add-mask::$(echo "$RECORDS" | jq -r '.result[0].zone_name // empty')"
          echo "âœ… è´¦æˆ·1: æ”¶é›†åˆ° $COUNT1 æ¡ proxied è®°å½•"
          
          echo ""
          echo ">>> æ”¶é›†ç¬¬äºŒä¸ªè´¦æˆ·çš„ proxied DNS è®°å½•..."
          # 555606.xyz
          RECORDS2=$(curl -s "https://api.cloudflare.com/client/v4/zones/${CF_ZONE_ID_555606}/dns_records?per_page=500" \
            -H "X-Auth-Email: ${CF_API_EMAIL_555606}" \
            -H "X-Auth-Key: ${CF_API_KEY_555606}")
          
          echo "$RECORDS2" | jq -r '.result[] | select(.proxied == true) | .name' >> /tmp/proxied_domains.txt
          COUNT2=$(echo "$RECORDS2" | jq '[.result[] | select(.proxied == true)] | length')
          # éšè—åŸå§‹åŸŸå
          echo "::add-mask::$(echo "$RECORDS2" | jq -r '.result[0].zone_name // empty')"
          echo "âœ… è´¦æˆ·2: æ”¶é›†åˆ° $COUNT2 æ¡ proxied è®°å½•"
          
          # éšè—æ‰€æœ‰å®Œæ•´åŸŸå (add-mask)
          while IFS= read -r domain; do
            [ -n "$domain" ] && echo "::add-mask::$domain"
          done < /tmp/proxied_domains.txt
          
          # æ’åºå»é‡
          sort -u /tmp/proxied_domains.txt > /tmp/cf-host-domain.txt
          
          # æ˜¾ç¤ºéƒ¨åˆ†éšè—çš„åŸŸååˆ—è¡¨
          echo ""
          echo "==========================================="
          echo "ğŸ“‹ æ”¶é›†åˆ°çš„ proxied DNS è®°å½• (éƒ¨åˆ†éšè—):"
          echo "==========================================="
          while IFS= read -r domain; do
            if [ -n "$domain" ]; then
              # è·å–å­åŸŸåå‰2ä¸ªå­—ç¬¦å’Œä¸»åŸŸåå7ä¸ªå­—ç¬¦
              prefix=$(echo "$domain" | cut -c1-2)
              suffix=$(echo "$domain" | grep -oE '[^.]+\.[^.]+$' | tail -c 8)
              echo "  ${prefix}**.**${suffix}"
            fi
          done < /tmp/cf-host-domain.txt
          
          TOTAL=$(wc -l < /tmp/cf-host-domain.txt)
          echo ""
          echo "==========================================="
          echo "âœ… æ€»è®¡æ”¶é›†åˆ° $TOTAL æ¡ proxied DNS è®°å½•"
          echo "==========================================="

      - name: Push to CFST-HostsServer repository
        env:
          BLOG_GITHUB_TOKEN: ${{ secrets.BLOG_GITHUB_TOKEN }}
        run: |
          if [ -z "$BLOG_GITHUB_TOKEN" ]; then
            echo "âŒ BLOG_GITHUB_TOKEN æœªé…ç½®"
            exit 1
          fi
          
          if [ ! -s /tmp/cf-host-domain.txt ]; then
            echo "âš ï¸ æ—  proxied DNS è®°å½•"
            exit 0
          fi
          
          # Clone ç›®æ ‡ä»“åº“
          git clone "https://${BLOG_GITHUB_TOKEN}@github.com/suwei8/CFST-HostsServer.git" /tmp/cfst-repo
          cd /tmp/cfst-repo
          
          # å¤åˆ¶æ–‡ä»¶
          cp /tmp/cf-host-domain.txt ./cf-host-domain.txt
          
          # é…ç½® git
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # æäº¤
          git add cf-host-domain.txt
          if git diff --staged --quiet; then
            echo "âš ï¸ æ— å˜åŒ–ï¼Œè·³è¿‡æäº¤"
          else
            TIMESTAMP=$(date -u +'%Y-%m-%d %H:%M UTC')
            git commit -m "Update proxied DNS records - $TIMESTAMP"
            git push
            echo "âœ… å·²æ¨é€åˆ° CFST-HostsServer ä»“åº“"
          fi

      - name: Summary
        run: |
          echo "## ğŸ“‹ Cloudflare Proxied DNS æ”¶é›†ç»“æœ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -s /tmp/cf-host-domain.txt ]; then
            TOTAL=$(wc -l < /tmp/cf-host-domain.txt)
            echo "âœ… æˆåŠŸæ”¶é›† **$TOTAL** æ¡ proxied DNS è®°å½•å¹¶æ¨é€åˆ°ä»“åº“" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ æœªæ”¶é›†åˆ°ä»»ä½• proxied DNS è®°å½•" >> $GITHUB_STEP_SUMMARY
          fi
