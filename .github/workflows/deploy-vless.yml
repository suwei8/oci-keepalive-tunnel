name: Deploy VLESS + Reality

on:
  workflow_dispatch:
    inputs:
      target_index:
        description: 'Target Host Index (0-29)'
        required: true
        type: string

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - name: Get host info
        id: host
        env:
          HOSTS_CONFIG: ${{ secrets.HOSTS_CONFIG }}
          TARGET_INDEX: ${{ inputs.target_index }}
        run: |
          if [ -z "$TARGET_INDEX" ]; then
            echo "Error: Target Index is required"
            exit 1
          fi
          
          HOST_NAME=$(echo "$HOSTS_CONFIG" | jq -r ".[$TARGET_INDEX].name")
          SSH_HOST=$(echo "$HOSTS_CONFIG" | jq -r ".[$TARGET_INDEX].ssh_host")
          
          if [ "$HOST_NAME" = "null" ] || [ -z "$HOST_NAME" ]; then
            echo "Error: No host found at index $TARGET_INDEX"
            exit 1
          fi
          
          echo "name=$HOST_NAME" >> $GITHUB_OUTPUT
          echo "ssh_host=$SSH_HOST" >> $GITHUB_OUTPUT
          echo "Deploying to: $HOST_NAME ($SSH_HOST)"

      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install cloudflared
        run: |
          wget -q https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64 -O /tmp/cloudflared
          chmod +x /tmp/cloudflared
          sudo mv /tmp/cloudflared /usr/local/bin/cloudflared
          cloudflared --version

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          cat >> ~/.ssh/config << 'EOF'
          Host *
            StrictHostKeyChecking no
            UserKnownHostsFile /dev/null
            LogLevel ERROR
          EOF
          sudo apt-get update -qq && sudo apt-get install -y -qq sshpass jq

      - name: Deploy VLESS + Reality
        id: vless
        env:
          SSH_USERNAME: ${{ secrets.SSH_USERNAME }}
          SSH_PASSWORD: ${{ secrets.SSH_PASSWORD }}
          SSH_HOST: ${{ steps.host.outputs.ssh_host }}
          HOST_NAME: ${{ steps.host.outputs.name }}
          TG_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TG_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          SSH_OPTS="-o ConnectTimeout=30 -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR -o ServerAliveInterval=30"
          
          # 1. Start Tunnel
          echo ">>> Establishing Tunnel..."
          cloudflared access ssh --hostname "$SSH_HOST" --url "ssh://127.0.0.1:2222" &
          TUNNEL_PID=$!
          sleep 10
          
          if ! kill -0 $TUNNEL_PID 2>/dev/null; then
            echo "âŒ Tunnel failed"
            exit 1
          fi
          
          # 2. Deploy on Remote
          echo ">>> Configure Remote Host..."
          
          if [ ! -f scripts/vless_remote.sh ]; then
             echo "âŒ Script scripts/vless_remote.sh not found!"
             kill $TUNNEL_PID
             exit 1
          fi
          
          echo ">>> Executing script on remote..."
          # Execute the script remotely by piping the local file to ssh
          set +e
          REMOTE_OUTPUT=$(sshpass -p "$SSH_PASSWORD" ssh $SSH_OPTS -p 2222 "${SSH_USERNAME}@127.0.0.1" "cat > /tmp/vless_install.sh && chmod +x /tmp/vless_install.sh && timeout 300 /tmp/vless_install.sh" < scripts/vless_remote.sh 2>&1)
          EXIT_CODE=$?
          set -e
          
          echo "Remote execution finished."
          
          # Parse Output
          IP=$(echo "$REMOTE_OUTPUT" | grep "IP=" | cut -d= -f2 | tr -d '\r')
          PORT=$(echo "$REMOTE_OUTPUT" | grep "PORT=" | cut -d= -f2 | tr -d '\r')
          UUID=$(echo "$REMOTE_OUTPUT" | grep "UUID=" | cut -d= -f2 | tr -d '\r')
          PBK=$(echo "$REMOTE_OUTPUT" | grep "PUBLIC_KEY=" | cut -d= -f2 | tr -d '\r')
          SNI=$(echo "$REMOTE_OUTPUT" | grep "SNI=" | cut -d= -f2 | tr -d '\r')
          
          if [ -z "$UUID" ]; then
            echo "âŒ Failed to retrieve VLESS config"
            echo "Debug Output: $REMOTE_OUTPUT"
            kill $TUNNEL_PID
            exit 1
          fi
          
          # Construct Link
          LINK="vless://${UUID}@${IP}:${PORT}?security=reality&encryption=none&pbk=${PBK}&headerType=none&fp=chrome&type=tcp&flow=xtls-rprx-vision&sni=${SNI}#${HOST_NAME}"
          
          echo "âœ… VLESS Deployed!"
          echo "Link: $LINK"
          
          # Send Telegram Notification
          echo ">>> Sending Telegram Notification..."
          MSG_TEXT="ðŸš€ *VLESS + Reality Deployed*
          
          *Host:* ${HOST_NAME}
          *IP:* \`${IP}\`
          *Port:* ${PORT}
          *UUID:* \`${UUID}\`
          *Public Key:* \`${PBK}\`
          *SNI:* \`${SNI}\`
          
          \`\`\`
          ${LINK}
          \`\`\`"
          
          echo "Debug Message Length: ${#MSG_TEXT}"
          
          curl -s -X POST "https://api.telegram.org/bot${TG_BOT_TOKEN}/sendMessage" \
               --data-urlencode "chat_id=${TG_CHAT_ID}" \
               --data-urlencode "text=${MSG_TEXT}" \
               --data-urlencode "parse_mode=Markdown"
            
          kill $TUNNEL_PID
