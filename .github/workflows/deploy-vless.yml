name: Deploy VLESS WS

on:
  schedule:
    - cron: "0 4 * * 1"
  workflow_dispatch:
    inputs:
      force_redeploy:
        description: 'å¼ºåˆ¶é‡æ–°éƒ¨ç½²'
        required: false
        default: 'false'
        type: choice
        options:
          - 'false'
          - 'true'
      target_host:
        description: 'æŒ‡å®šéƒ¨ç½²ä¸»æœº (ç•™ç©º=å…¨éƒ¨)'
        required: false
        default: ''

jobs:
  deploy:
    name: "Deploy VLESS"
    runs-on: ubuntu-latest
    timeout-minutes: 60
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install cloudflared
        run: |
          sudo cp bin/cloudflared /usr/local/bin/cloudflared
          cloudflared --version

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          cat >> ~/.ssh/config << 'EOF'
          Host *
            StrictHostKeyChecking no
            UserKnownHostsFile /dev/null
            LogLevel ERROR
          EOF
          sudo apt-get update -qq && sudo apt-get install -y -qq sshpass jq

      - name: Deploy to all hosts
        id: deploy
        env:
          VLESS_HOSTS_CONFIG: ${{ secrets.VLESS_HOSTS_CONFIG }}
          SSH_USERNAME: ${{ secrets.SSH_USERNAME }}
          SSH_PASSWORD: ${{ secrets.SSH_PASSWORD }}
          VLESS_UUID: ${{ secrets.VLESS_UUID }}
          FORCE_REDEPLOY: ${{ github.event.inputs.force_redeploy }}
          TARGET_HOST: ${{ github.event.inputs.target_host }}
        run: |
          SSH_OPTS="-o ConnectTimeout=30 -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR -o ServerAliveInterval=30"
          
          NODES_INFO=""
          DEPLOYED_COUNT=0
          SKIPPED_COUNT=0
          
          HOST_COUNT=$(echo "$VLESS_HOSTS_CONFIG" | jq '. | length')
          echo "Total hosts: $HOST_COUNT"
          
          for INDEX in $(seq 0 $((HOST_COUNT - 1))); do
            host_item=$(echo "$VLESS_HOSTS_CONFIG" | jq -c ".[$INDEX]")
            HOST_NAME=$(echo "$host_item" | jq -r '.name')
            SSH_HOST=$(echo "$host_item" | jq -r '.ssh_host')
            VLESS_DOMAIN=$(echo "$host_item" | jq -r '.vless_domain')
            TUNNEL_TOKEN=$(echo "$host_item" | jq -r '.tunnel_token')
            
            echo "::add-mask::$SSH_HOST"
            echo "::add-mask::$VLESS_DOMAIN"
            echo "::add-mask::$TUNNEL_TOKEN"
            
            if [ "$HOST_NAME" = "null" ] || [ -z "$HOST_NAME" ]; then
              continue
            fi
            
            if [ -n "$TARGET_HOST" ] && [ "$HOST_NAME" != "$TARGET_HOST" ]; then
              continue
            fi
            
            echo ""
            echo "==========================================="
            echo "Processing: $HOST_NAME"
            echo "==========================================="
            
            pkill -f "cloudflared.*2222" 2>/dev/null || true
            sleep 2
            cloudflared access ssh --hostname "$SSH_HOST" --url "ssh://127.0.0.1:2222" &
            TUNNEL_PID=$!
            sleep 5
            
            if ! kill -0 $TUNNEL_PID 2>/dev/null; then
              echo "âŒ Tunnel è¿žæŽ¥å¤±è´¥"
              continue
            fi
            
            CONTAINER_EXISTS=$(sshpass -p "$SSH_PASSWORD" ssh $SSH_OPTS -n -p 2222 "${SSH_USERNAME}@127.0.0.1" 'docker ps -a --format "{{.Names}}" | grep -q "^xray-vless$" && echo "yes" || echo "no"' 2>&1 | tail -1) || true
            
            if [ "$CONTAINER_EXISTS" = "yes" ] && [ "$FORCE_REDEPLOY" != "true" ]; then
              echo "â­ï¸ å®¹å™¨å·²å­˜åœ¨ï¼Œè·³è¿‡"
              SKIPPED_COUNT=$((SKIPPED_COUNT + 1))
              NODES_INFO="${NODES_INFO}vless://${VLESS_UUID}@${VLESS_DOMAIN}:443?encryption=none&security=tls&sni=${VLESS_DOMAIN}&type=ws&host=${VLESS_DOMAIN}&path=%2Fvless-ws#${HOST_NAME}\n"
              kill $TUNNEL_PID 2>/dev/null || true
              continue
            fi
            
            echo ">>> å¼€å§‹éƒ¨ç½²..."
            
            sshpass -p "$SSH_PASSWORD" ssh $SSH_OPTS -n -p 2222 "${SSH_USERNAME}@127.0.0.1" "mkdir -p /home/sw/docker_root/vless" 2>&1 || true
            
            echo ">>> åˆ›å»º Xray é…ç½®..."
            sshpass -p "$SSH_PASSWORD" ssh $SSH_OPTS -n -p 2222 "${SSH_USERNAME}@127.0.0.1" "echo '{\"log\":{\"loglevel\":\"warning\"},\"inbounds\":[{\"port\":10086,\"listen\":\"0.0.0.0\",\"protocol\":\"vless\",\"settings\":{\"clients\":[{\"id\":\"${VLESS_UUID}\",\"level\":0}],\"decryption\":\"none\"},\"streamSettings\":{\"network\":\"ws\",\"wsSettings\":{\"path\":\"/vless-ws\"}}}],\"outbounds\":[{\"protocol\":\"freedom\"}]}' > /home/sw/docker_root/vless/config.json" 2>&1 || true
            
            echo ">>> åˆ›å»º Docker é…ç½®..."
            sshpass -p "$SSH_PASSWORD" ssh $SSH_OPTS -n -p 2222 "${SSH_USERNAME}@127.0.0.1" "echo 'services:
            xray:
              image: teddysun/xray:latest
              container_name: xray-vless
              restart: always
              volumes:
                - ./config.json:/etc/xray/config.json
              ports:
                - 127.0.0.1:10086:10086
              environment:
                - TZ=Asia/Jakarta' > /home/sw/docker_root/vless/docker-compose.yml" 2>&1 || true
            
            echo ">>> é…ç½® Cloudflare Tunnel..."
            sshpass -p "$SSH_PASSWORD" ssh $SSH_OPTS -n -p 2222 "${SSH_USERNAME}@127.0.0.1" "
              mkdir -p /home/sw/.cloudflared
              echo 'tunnel: auto
          credentials-file: /home/sw/.cloudflared/credentials.json
          ingress:
            - hostname: ${VLESS_DOMAIN}
              service: http://localhost:10086
            - service: http_status:404' > /home/sw/docker_root/vless/tunnel-config.yml
              
              sudo tee /etc/systemd/system/cloudflared-vless.service > /dev/null << SVCEOF
          [Unit]
          Description=Cloudflare Tunnel for VLESS
          After=network.target
          [Service]
          Type=simple
          User=sw
          ExecStart=/usr/local/bin/cloudflared tunnel run --token ${TUNNEL_TOKEN}
          Restart=always
          RestartSec=5
          [Install]
          WantedBy=multi-user.target
          SVCEOF
              
              sudo systemctl daemon-reload
              sudo systemctl enable cloudflared-vless
              sudo systemctl restart cloudflared-vless
            " 2>&1 || true
            
            echo ">>> å¯åŠ¨ Xray å®¹å™¨..."
            CONTAINER_OK="no"
            for RETRY in 1 2 3; do
              echo ">>> å°è¯•å¯åŠ¨ (ç¬¬ $RETRY æ¬¡)..."
              sshpass -p "$SSH_PASSWORD" ssh $SSH_OPTS -n -p 2222 "${SSH_USERNAME}@127.0.0.1" "cd /home/sw/docker_root/vless && docker compose down 2>/dev/null || true && docker compose pull 2>/dev/null || true && docker compose up -d && sleep 3 && docker ps | grep xray-vless && echo CONTAINER_HEALTHY || echo CONTAINER_FAILED" 2>&1 | tee /tmp/container_output.txt
              
              if grep -q "CONTAINER_HEALTHY" /tmp/container_output.txt; then
                CONTAINER_OK="yes"
                break
              fi
              sleep 3
            done
            
            TUNNEL_STATUS=$(sshpass -p "$SSH_PASSWORD" ssh $SSH_OPTS -n -p 2222 "${SSH_USERNAME}@127.0.0.1" "systemctl is-active cloudflared-vless" 2>&1 | tail -1) || true
            
            if [ "$CONTAINER_OK" = "yes" ] && [ "$TUNNEL_STATUS" = "active" ]; then
              echo "âœ… éƒ¨ç½²æˆåŠŸ: $HOST_NAME"
              DEPLOYED_COUNT=$((DEPLOYED_COUNT + 1))
              NODES_INFO="${NODES_INFO}vless://${VLESS_UUID}@${VLESS_DOMAIN}:443?encryption=none&security=tls&sni=${VLESS_DOMAIN}&type=ws&host=${VLESS_DOMAIN}&path=%2Fvless-ws#${HOST_NAME}\n"
            else
              echo "âŒ éƒ¨ç½²å¤±è´¥: $HOST_NAME (Container: $CONTAINER_OK, Tunnel: $TUNNEL_STATUS)"
            fi
            
            kill $TUNNEL_PID 2>/dev/null || true
          done
          
          echo ""
          echo "==========================================="
          echo "å®Œæˆ: æ–°éƒ¨ç½² $DEPLOYED_COUNT, è·³è¿‡ $SKIPPED_COUNT"
          echo "==========================================="
          
          echo -e "$NODES_INFO" > /tmp/nodes_info.txt

      - name: Send Telegram notification
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          if [ -z "$TELEGRAM_BOT_TOKEN" ] || [ -z "$TELEGRAM_CHAT_ID" ]; then
            echo "âš ï¸ Telegram æœªé…ç½®"
            exit 0
          fi
          
          if [ ! -s /tmp/nodes_info.txt ]; then
            echo "âš ï¸ æ— èŠ‚ç‚¹ä¿¡æ¯"
            exit 0
          fi
          
          TIMESTAMP=$(date -u +'%Y-%m-%d %H:%M UTC')
          NODE_COUNT=$(cat /tmp/nodes_info.txt | grep -v "^$" | wc -l)
          NODES_FULL=$(cat /tmp/nodes_info.txt | grep -v "^$" | head -20)
          
          FINAL_MSG=$(printf "ðŸ” *VLESS WS éƒ¨ç½²å®Œæˆ*\n\nðŸ“… %s\n\nâœ… *å…± %s ä¸ªèŠ‚ç‚¹*\n\nðŸ“‹ *å®¢æˆ·ç«¯è¿žæŽ¥ä¿¡æ¯:*\n\`\`\`\n%s\n\`\`\`\n\nðŸ’¡ å¤åˆ¶ä¸Šæ–¹é“¾æŽ¥å¯¼å…¥å®¢æˆ·ç«¯å³å¯ä½¿ç”¨" "$TIMESTAMP" "$NODE_COUNT" "$NODES_FULL")
          
          curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
            -d chat_id="${TELEGRAM_CHAT_ID}" \
            -d parse_mode="Markdown" \
            --data-urlencode "text=${FINAL_MSG}" > /dev/null
          
          echo "âœ… Telegram å·²å‘é€"

      - name: Push to blog repository
        env:
          BLOG_GITHUB_TOKEN: ${{ secrets.BLOG_GITHUB_TOKEN }}
        run: |
          if [ -z "$BLOG_GITHUB_TOKEN" ]; then
            echo "âš ï¸ BLOG_GITHUB_TOKEN æœªé…ç½®"
            exit 0
          fi
          
          if [ ! -s /tmp/nodes_info.txt ]; then
            echo "âš ï¸ æ— èŠ‚ç‚¹ä¿¡æ¯"
            exit 0
          fi
          
          git clone "https://${BLOG_GITHUB_TOKEN}@github.com/suwei8/blog.git" /tmp/blog
          cd /tmp/blog
          
          TIMESTAMP=$(date -u +'%Y-%m-%d %H:%M UTC')
          echo "# VLESS WS èŠ‚ç‚¹åˆ—è¡¨" > vless.txt
          echo "# æ›´æ–°æ—¶é—´: $TIMESTAMP" >> vless.txt
          echo "" >> vless.txt
          cat /tmp/nodes_info.txt | grep -v "^$" >> vless.txt
          
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add vless.txt
          git diff --staged --quiet || git commit -m "Update VLESS nodes $(date -u +%Y-%m-%d)"
          git push
          
          echo "âœ… å·²æŽ¨é€åˆ° blog ä»“åº“"

      - name: Summary
        run: |
          echo "## ðŸ” VLESS WS éƒ¨ç½²ç»“æžœ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -s /tmp/nodes_info.txt ]; then
            echo "### âœ… èŠ‚ç‚¹åˆ—è¡¨" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            cat /tmp/nodes_info.txt | grep -v "^$" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          else
            echo "æ— èŠ‚ç‚¹ä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
          fi
