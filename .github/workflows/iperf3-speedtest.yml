name: iPerf3 Speedtest All Instances (Loop)

on:
  workflow_dispatch:
    inputs:
      test_duration:
        description: 'æµ‹é€Ÿæ—¶é•¿ (ç§’)'
        required: false
        default: '10'
      target_index:
        description: 'æŒ‡å®šä¸»æœºç´¢å¼• (0-29, ç•™ç©º=å…¨éƒ¨)'
        required: false
        default: ''

jobs:
  speedtest-loop:
    name: "Speedtest Loop"
    runs-on: ubuntu-latest
    timeout-minutes: 60  # å¢žåŠ è¶…æ—¶æ—¶é—´ï¼Œå› ä¸ºæ˜¯ä¸²è¡Œè·‘æ‰€æœ‰
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install cloudflared
        run: |
          sudo cp bin/cloudflared /usr/local/bin/cloudflared
          cloudflared --version

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          cat >> ~/.ssh/config << 'EOF'
          Host *
            StrictHostKeyChecking no
            UserKnownHostsFile /dev/null
            LogLevel ERROR
          EOF
          sudo apt-get update -qq && sudo apt-get install -y -qq sshpass jq

      - name: Run Speedtest Loop
        id: speedtest
        env:
          HOSTS_CONFIG: ${{ secrets.HOSTS_CONFIG }}
          SSH_USERNAME: ${{ secrets.SSH_USERNAME }}
          SSH_PASSWORD: ${{ secrets.SSH_PASSWORD }}
          IPERF_CLIENT_HOST: ${{ secrets.IPERF_CLIENT_HOST }}
          IPERF_CLIENT_USER: ${{ secrets.IPERF_CLIENT_USER }}
          IPERF_CLIENT_PASS: ${{ secrets.IPERF_CLIENT_PASS }}
          TEST_DURATION: ${{ github.event.inputs.test_duration }}
          TARGET_INDEX: ${{ github.event.inputs.target_index }}
        run: |
          # SSH å‚æ•°
          SSH_OPTS="-o ConnectTimeout=30 -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR -o ServerAliveInterval=30"
          
          # 1. å»ºç«‹åˆ°å®¶åº­å®¢æˆ·æœºçš„ Tunnel (å…¨å±€æŒä¹…è¿žæŽ¥, Port 2202)
          echo ">>> æ­£åœ¨è¿žæŽ¥å®¶åº­æµ‹é€Ÿå®¢æˆ·æœº ($IPERF_CLIENT_HOST)..."
          cloudflared access ssh --hostname "$IPERF_CLIENT_HOST" --url "ssh://127.0.0.1:2202" &
          TUNNEL_HOME_PID=$!
          sleep 5
          
          if ! kill -0 $TUNNEL_HOME_PID 2>/dev/null; then
            echo "âŒ æ— æ³•è¿žæŽ¥å®¶åº­å®¢æˆ·æœºï¼Œä»»åŠ¡ç»ˆæ­¢"
            exit 1
          fi
          echo "âœ… å®¶åº­å®¢æˆ·æœºè¿žæŽ¥æˆåŠŸ"
          
          # 2. å‡†å¤‡ CSV æ–‡ä»¶
          CSV_FILE="csv/iperf3_results.csv"
          mkdir -p csv
          if [ ! -f "$CSV_FILE" ] || [ ! -s "$CSV_FILE" ]; then
            echo "name,download_speed,upload_speed,timestamp" > "$CSV_FILE"
          else
            # ç®€å•æ£€æŸ¥è¡¨å¤´
            HEADER=$(head -1 "$CSV_FILE")
            if [[ "$HEADER" != *"upload_speed"* ]]; then
               echo "Detected old CSV format"
            fi
          fi
          
          # 3. å¾ªçŽ¯éåŽ†ä¸»æœº
          # å°† JSON æ•°ç»„è¯»å…¥å¹¶é€è¡Œå¤„ç†
          # å¢žåŠ  index è®¡æ•°å™¨
          INDEX=0
          
          echo "$HOSTS_CONFIG" | jq -c '.[]' | while read -r host_item; do
            # å¦‚æžœæŒ‡å®šäº† TARGET_INDEXï¼Œåˆ™è·³è¿‡ä¸åŒ¹é…çš„
            if [ -n "$TARGET_INDEX" ] && [ "$INDEX" -ne "$TARGET_INDEX" ]; then
              echo "è·³è¿‡ Index $INDEX (Target: $TARGET_INDEX)"
              INDEX=$((INDEX+1))
              continue
            fi
            
            HOST_NAME=$(echo "$host_item" | jq -r '.name')
            SSH_HOST=$(echo "$host_item" | jq -r '.ssh_host')
            
            if [ "$HOST_NAME" = "null" ] || [ -z "$HOST_NAME" ]; then
               INDEX=$((INDEX+1))
               continue
            fi
            
            echo ""
            echo "---------------------------------------------------"
            echo "Processing Host [$INDEX]: $HOST_NAME"
            echo "---------------------------------------------------"
            
            # --- å•ä¸ªä¸»æœºæµç¨‹å¼€å§‹ ---
            
            # 3.1 å»ºç«‹ OCI ä¸´æ—¶éš§é“ (Port 2222)
            cloudflared access ssh --hostname "$SSH_HOST" --url "ssh://127.0.0.1:2222" &
            TUNNEL_OCI_PID=$!
            sleep 5
            
            if ! kill -0 $TUNNEL_OCI_PID 2>/dev/null; then
              echo "âŒ OCI Tunnel å¤±è´¥: $HOST_NAME"
              INDEX=$((INDEX+1))
              continue
            fi
            
            # 3.2 é…ç½® OCI (å®‰è£… iperf3 + èŽ·å– IP + å¯åŠ¨ Server)
            echo ">>> é…ç½® OCI..."
            
            # å°è¯•è¿žæŽ¥å¹¶æ‰§è¡Œå‘½ä»¤
            PREPARE_OUTPUT=$(sshpass -p "$SSH_PASSWORD" ssh $SSH_OPTS -p 2222 "${SSH_USERNAME}@127.0.0.1" '
              which iperf3 > /dev/null 2>&1 || (sudo apt-get update -qq && sudo apt-get install -y -qq iperf3)
              IP=$(curl -4 -s ip.sb)
              echo "PUBLIC_IP::$IP"
              sudo pkill -9 iperf3 2>/dev/null || true
              sudo iptables -I INPUT -p tcp --dport 5201 -j ACCEPT 2>/dev/null || true
              sudo netfilter-persistent save 2>/dev/null || true
              sudo nohup iperf3 -s -D > /dev/null 2>&1
              sleep 2
              pgrep -x iperf3 > /dev/null && echo "SERVER_STARTED" || echo "SERVER_FAILED"
            ' 2>&1)
            
            # è§£æžè¾“å‡º
            OCI_PUBLIC_IP=$(echo "$PREPARE_OUTPUT" | grep "PUBLIC_IP::" | cut -d':' -f3 | tr -d '\r')
            SERVER_STATUS=$(echo "$PREPARE_OUTPUT" | grep "SERVER_STARTED")
            
            if [ -z "$OCI_PUBLIC_IP" ] || [ -z "$SERVER_STATUS" ]; then
               echo "âŒ OCI é…ç½®å¤±è´¥ (IP: $OCI_PUBLIC_IP, Server: $SERVER_STATUS)"
               kill $TUNNEL_OCI_PID 2>/dev/null || true
               INDEX=$((INDEX+1))
               continue
            fi
            
            MASKED_IP=$(echo "$OCI_PUBLIC_IP" | awk -F. '{print $1"."$2"."$3".*"}')
            echo "âœ… OCI å°±ç»ª: $MASKED_IP"
            
            # 3.3 å®¢æˆ·æœºæµ‹é€Ÿ (Home -> OCI)
            echo ">>> å¼€å§‹æµ‹é€Ÿ..."
            
            UNSET_PROXY="unset http_proxy https_proxy ftp_proxy all_proxy HTTP_PROXY HTTPS_PROXY FTP_PROXY ALL_PROXY"
            
            # ä¸‹è½½ (Server sends to Client)
            IPERF_DL_RESULT=$(sshpass -p "$IPERF_CLIENT_PASS" ssh $SSH_OPTS -p 2202 "${IPERF_CLIENT_USER}@127.0.0.1" "
              $UNSET_PROXY
              which iperf3 > /dev/null 2>&1 || (apt-get update -qq && apt-get install -y -qq iperf3)
              iperf3 -c $OCI_PUBLIC_IP -R -t ${TEST_DURATION:-10} -J || echo '{\"error\": \"connection failed\"}'
            ")
            
            sleep 1
            
            # ä¸Šä¼  (Client sends to Server)
            IPERF_UL_RESULT=$(sshpass -p "$IPERF_CLIENT_PASS" ssh $SSH_OPTS -p 2202 "${IPERF_CLIENT_USER}@127.0.0.1" "
              $UNSET_PROXY
              iperf3 -c $OCI_PUBLIC_IP -t ${TEST_DURATION:-10} -J || echo '{\"error\": \"connection failed\"}'
            ")
            
            # 3.4 æ¸…ç† OCI
            sshpass -p "$SSH_PASSWORD" ssh $SSH_OPTS -p 2222 "${SSH_USERNAME}@127.0.0.1" 'sudo pkill -9 iperf3 2>/dev/null || true'
            kill $TUNNEL_OCI_PID 2>/dev/null || true
            
            # 3.5 è§£æžç»“æžœ & å†™å…¥ CSV
            get_speed_mbps() {
                local json=$1
                if echo "$json" | grep -q '"error"'; then
                    echo "N/A"
                else
                    local bits=$(echo "$json" | jq -r '.end.sum_received.bits_per_second // 0' 2>/dev/null)
                    if [ -z "$bits" ] || [ "$bits" = "0" ] || [ "$bits" = "null" ]; then
                        echo "N/A"
                    else
                        echo "scale=2; $bits / 1000000" | bc
                    fi
                fi
            }
            
            DL_VAL=$(get_speed_mbps "$IPERF_DL_RESULT")
            UL_VAL=$(get_speed_mbps "$IPERF_UL_RESULT")
            
            if [ "$DL_VAL" != "N/A" ]; then DL_STR="${DL_VAL} Mbps"; else DL_STR="N/A"; fi
            if [ "$UL_VAL" != "N/A" ]; then UL_STR="${UL_VAL} Mbps"; else UL_STR="N/A"; fi
            
            TIMESTAMP=$(date -u +"%Y-%m-%d %H:%M:%S")
            
            # å†™å…¥æ–‡ä»¶
            echo "${HOST_NAME},${DL_STR},${UL_STR},${TIMESTAMP}" >> "$CSV_FILE"
            echo "âœ… ç»“æžœ: ä¸‹è½½ $DL_STR | ä¸Šä¼  $UL_STR"
            
            # --- å•ä¸ªä¸»æœºæµç¨‹ç»“æŸ ---
            
            INDEX=$((INDEX+1))
          done
          
          # ç»“æŸåŽæ¸…ç†å®¶åº­éš§é“
          kill $TUNNEL_HOME_PID 2>/dev/null || true
          echo "âœ… æ‰€æœ‰ä»»åŠ¡å®Œæˆ"
          
          # æ˜¾ç¤ºå½“å‰æ–‡ä»¶å†…å®¹ç”¨äºŽè°ƒè¯•
          echo "=== Final CSV Content ==="
          tail -20 "$CSV_FILE"

      - name: Commit results
        run: |
          CSV_FILE="csv/iperf3_results.csv"
          if [ -f "$CSV_FILE" ]; then
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git pull --rebase origin main || echo "Git pull failed"
            git add "$CSV_FILE"
            git diff --staged --quiet || git commit -m "Update iPerf3 speedtest results (Loop) $(date -u +%Y-%m-%d)"
            git push || echo "Nothing to push"
          fi

      - name: Summary
        run: |
          CSV_FILE="csv/iperf3_results.csv"
          TODAY=$(date -u +"%Y-%m-%d")
          
          echo "## ðŸš€ iPerf3 æµ‹é€Ÿç»“æžœ (Single Loop)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### ðŸ† é€Ÿåº¦æŽ’å (Top 10)" >> $GITHUB_STEP_SUMMARY
          echo "| ä¸‹è½½é€Ÿåº¦ | ä¸Šä¼ é€Ÿåº¦ | å®žä¾‹åç§° |" >> $GITHUB_STEP_SUMMARY
          echo "| :--- | :--- | :--- |" >> $GITHUB_STEP_SUMMARY
          
          if [ -f "$CSV_FILE" ]; then
            grep "$TODAY" "$CSV_FILE" 2>/dev/null | grep -v "N/A" | \
              awk -F',' '{
                dl = $2; ul = $3;
                gsub(/ Mbps/, "", dl); gsub(/ Mbps/, "", ul);
                printf "| %s Mbps | %s Mbps | %s |\n", dl, ul, $1
              }' | sort -k2 -rn | head -10 >> $GITHUB_STEP_SUMMARY
          else
            echo "No results found." >> $GITHUB_STEP_SUMMARY
          fi
