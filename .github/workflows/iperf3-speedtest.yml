name: iPerf3 Speedtest All Instances

on:
  workflow_dispatch:
    inputs:
      test_duration:
        description: 'æµ‹é€Ÿæ—¶é•¿ (ç§’)'
        required: false
        default: '10'
      target_index:
        description: 'æŒ‡å®šä¸»æœºç´¢å¼• (0-29, ç•™ç©º=å…¨éƒ¨)'
        required: false
        default: ''

jobs:
  speedtest:
    name: "Host ${{ matrix.index }}"
    runs-on: ubuntu-latest
    timeout-minutes: 10
    strategy:
      fail-fast: false
      max-parallel: 1  # ä¸²è¡Œæ‰§è¡Œï¼Œé¿å…æµ‹é€Ÿå®¢æˆ·æœºå¹¶å‘å†²çª
      matrix:
        index: [0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29]

    steps:
      - name: Get host info from secrets
        id: host
        env:
          HOSTS_CONFIG: ${{ secrets.HOSTS_CONFIG }}
          HOST_INDEX: ${{ matrix.index }}
          TARGET_INDEX: ${{ github.event.inputs.target_index }}
        run: |
          # å¦‚æœæŒ‡å®šäº†ç›®æ ‡ç´¢å¼•ä¸”ä¸åŒ¹é…ï¼Œè·³è¿‡
          if [ -n "$TARGET_INDEX" ] && [ "$TARGET_INDEX" != "$HOST_INDEX" ]; then
            echo "skip=true" >> $GITHUB_OUTPUT
            echo "Skipping index $HOST_INDEX (target: $TARGET_INDEX)"
            exit 0
          fi
          
          HOST_NAME=$(echo "$HOSTS_CONFIG" | jq -r ".[$HOST_INDEX].name")
          SSH_HOST=$(echo "$HOSTS_CONFIG" | jq -r ".[$HOST_INDEX].ssh_host")
          
          if [ "$HOST_NAME" = "null" ] || [ -z "$HOST_NAME" ]; then
            echo "skip=true" >> $GITHUB_OUTPUT
            echo "No host at index $HOST_INDEX"
            exit 0
          fi
          
          echo "skip=false" >> $GITHUB_OUTPUT
          echo "name=$HOST_NAME" >> $GITHUB_OUTPUT
          echo "ssh_host=$SSH_HOST" >> $GITHUB_OUTPUT
          echo "Host: $HOST_NAME ($SSH_HOST)"

      - name: Checkout repository
        if: steps.host.outputs.skip != 'true'
        uses: actions/checkout@v4

      - name: Install cloudflared
        if: steps.host.outputs.skip != 'true'
        run: |
          curl -sL https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64 -o /tmp/cloudflared
          chmod +x /tmp/cloudflared
          sudo mv /tmp/cloudflared /usr/local/bin/cloudflared

      - name: Setup SSH
        if: steps.host.outputs.skip != 'true'
        run: |
          mkdir -p ~/.ssh
          cat >> ~/.ssh/config << 'EOF'
          Host *
            StrictHostKeyChecking no
            UserKnownHostsFile /dev/null
            LogLevel ERROR
          EOF
          sudo apt-get update -qq && sudo apt-get install -y -qq sshpass

      - name: Run iPerf3 speedtest
        if: steps.host.outputs.skip != 'true'
        id: speedtest
        env:
          SSH_USERNAME: ${{ secrets.SSH_USERNAME }}
          SSH_PASSWORD: ${{ secrets.SSH_PASSWORD }}
          HOST_NAME: ${{ steps.host.outputs.name }}
          SSH_HOST: ${{ steps.host.outputs.ssh_host }}
          TEST_DURATION: ${{ github.event.inputs.test_duration }}
          IPERF_CLIENT_HOST: wky-ssh.555606.xyz
          IPERF_CLIENT_USER: root
          IPERF_CLIENT_PASS: sw63828
        run: |
          echo "==========================================="
          echo "iPerf3 æµ‹é€Ÿ: $HOST_NAME <-> å®¶åº­å®¢æˆ·æœº"
          echo "==========================================="
          
          SSH_OPTS="-o ConnectTimeout=30 -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR -o ServerAliveInterval=30"
          
          # 1. å»ºç«‹åˆ° OCI å®ä¾‹çš„ Tunnel (ç«¯å£ 2222)
          echo ">>> è¿æ¥ OCI å®ä¾‹..."
          cloudflared access ssh --hostname "$SSH_HOST" --url "ssh://127.0.0.1:2222" &
          TUNNEL_OCI_PID=$!
          sleep 5
          
          if ! kill -0 $TUNNEL_OCI_PID 2>/dev/null; then
            echo "âŒ OCI Tunnel å¤±è´¥"
            exit 1
          fi
          echo "âœ… OCI Tunnel å·²å»ºç«‹"
          
          # 2. åœ¨ OCI å®ä¾‹ä¸Šå®‰è£… iperf3 å¹¶è·å–å…¬ç½‘ IP
          echo ">>> é…ç½® OCI å®ä¾‹..."
          # å…ˆå®‰è£… iperf3 (å•ç‹¬æ‰§è¡Œï¼Œé¿å…è¾“å‡ºæ··å…¥å˜é‡)
          sshpass -p "$SSH_PASSWORD" ssh $SSH_OPTS -p 2222 "${SSH_USERNAME}@127.0.0.1" '
            which iperf3 > /dev/null 2>&1 || (sudo apt-get update -qq && sudo apt-get install -y -qq iperf3)
          '
          
          # å†è·å–å…¬ç½‘ IPv4 (åªè·å– IP)
          OCI_PUBLIC_IP=$(sshpass -p "$SSH_PASSWORD" ssh $SSH_OPTS -p 2222 "${SSH_USERNAME}@127.0.0.1" 'curl -4 -s ip.sb')
          
          if [ -z "$OCI_PUBLIC_IP" ]; then
            echo "âŒ æ— æ³•è·å– OCI å…¬ç½‘ IP"
            kill $TUNNEL_OCI_PID 2>/dev/null || true
            exit 1
          fi
          
          # æ©ç  IP ç”¨äºæ—¥å¿—æ˜¾ç¤º
          MASKED_IP=$(echo "$OCI_PUBLIC_IP" | awk -F. '{print $1"."$2"."$3".*"}')
          echo "âœ… OCI å…¬ç½‘ IP: $MASKED_IP"
          
          # 3. åœ¨ OCI å®ä¾‹ä¸Šå¯åŠ¨ iperf3 æœåŠ¡ç«¯ (åå°è¿è¡Œ)
          echo ">>> å¯åŠ¨ iperf3 æœåŠ¡ç«¯..."
          sshpass -p "$SSH_PASSWORD" ssh $SSH_OPTS -p 2222 "${SSH_USERNAME}@127.0.0.1" '
            # æ€æ­»æ—§çš„ iperf3 è¿›ç¨‹
            sudo pkill -9 iperf3 2>/dev/null || true
            sleep 1
            
            # å¼€æ”¾é˜²ç«å¢™ç«¯å£ 5201 (iptables)
            sudo iptables -I INPUT -p tcp --dport 5201 -j ACCEPT 2>/dev/null || true
            sudo netfilter-persistent save 2>/dev/null || true

            # å¯åŠ¨æœåŠ¡ç«¯ (ç›‘å¬é»˜è®¤ç«¯å£ 5201, ä½¿ç”¨ sudo)
            sudo nohup iperf3 -s -D > /dev/null 2>&1
            sleep 2
            # éªŒè¯æœåŠ¡ç«¯å¯åŠ¨
            if pgrep -x iperf3 > /dev/null; then
              echo "iperf3 server started"
            else
              echo "iperf3 server failed to start"
              exit 1
            fi
          '
          echo "âœ… iperf3 æœåŠ¡ç«¯å·²å¯åŠ¨"
          
          # 4. å»ºç«‹åˆ°å®¶åº­æµ‹é€Ÿå®¢æˆ·æœºçš„ Tunnel (ç«¯å£ 2202)
          echo ">>> è¿æ¥å®¶åº­æµ‹é€Ÿå®¢æˆ·æœº..."
          cloudflared access ssh --hostname "$IPERF_CLIENT_HOST" --url "ssh://127.0.0.1:2202" &
          TUNNEL_HOME_PID=$!
          sleep 5
          
          if ! kill -0 $TUNNEL_HOME_PID 2>/dev/null; then
            echo "âŒ å®¶åº­å®¢æˆ·æœº Tunnel å¤±è´¥"
            kill $TUNNEL_OCI_PID 2>/dev/null || true
            exit 1
          fi
          echo "âœ… å®¶åº­å®¢æˆ·æœº Tunnel å·²å»ºç«‹"
          
          # 5. åœ¨å®¶åº­å®¢æˆ·æœºä¸Šæ‰§è¡Œ iperf3 æµ‹é€Ÿ
          
          # æ¸…é™¤ä»£ç†ç¯å¢ƒ
          UNSET_PROXY="unset http_proxy https_proxy ftp_proxy all_proxy HTTP_PROXY HTTPS_PROXY FTP_PROXY ALL_PROXY"
          
          # 5.1 æµ‹é€Ÿ: ä¸‹è½½ (OCI -> å®¶åº­)
          echo ">>> æ‰§è¡Œä¸‹è½½æµ‹é€Ÿ (OCI -> å®¶åº­)..."
          IPERF_DL_RESULT=$(sshpass -p "$IPERF_CLIENT_PASS" ssh $SSH_OPTS -p 2202 "${IPERF_CLIENT_USER}@127.0.0.1" "
            $UNSET_PROXY
            which iperf3 > /dev/null 2>&1 || (apt-get update -qq && apt-get install -y -qq iperf3)
            # -R: Reverse mode (Server sends, Client receives = Download)
            iperf3 -c $OCI_PUBLIC_IP -R -t ${TEST_DURATION:-10} -J || echo '{\"error\": \"connection failed\"}'
          ")
          
          sleep 2
          
          # 5.2 æµ‹é€Ÿ: ä¸Šä¼  (å®¶åº­ -> OCI)
          echo ">>> æ‰§è¡Œä¸Šä¼ æµ‹é€Ÿ (å®¶åº­ -> OCI)..."
          IPERF_UL_RESULT=$(sshpass -p "$IPERF_CLIENT_PASS" ssh $SSH_OPTS -p 2202 "${IPERF_CLIENT_USER}@127.0.0.1" "
            $UNSET_PROXY
            # Default mode (Client sends, Server receives = Upload)
            iperf3 -c $OCI_PUBLIC_IP -t ${TEST_DURATION:-10} -J || echo '{\"error\": \"connection failed\"}'
          ")
          
          # 6. æ¸…ç†
          echo ">>> æ¸…ç†..."
          sshpass -p "$SSH_PASSWORD" ssh $SSH_OPTS -p 2222 "${SSH_USERNAME}@127.0.0.1" 'sudo pkill -9 iperf3 2>/dev/null || true'
          kill $TUNNEL_OCI_PID 2>/dev/null || true
          kill $TUNNEL_HOME_PID 2>/dev/null || true
          
          # 7. è§£æç»“æœå‡½æ•°
          get_speed_mbps() {
              local json=$1
              if echo "$json" | grep -q '"error"'; then
                  echo "N/A"
              else
                  local bits=$(echo "$json" | jq -r '.end.sum_received.bits_per_second // 0' 2>/dev/null)
                  if [ -z "$bits" ] || [ "$bits" = "0" ] || [ "$bits" = "null" ]; then
                      echo "N/A"
                  else
                      echo "scale=2; $bits / 1000000" | bc
                  fi
              fi
          }

          echo ">>> è§£æç»“æœ..."
          DL_SPEED_VAL=$(get_speed_mbps "$IPERF_DL_RESULT")
          UL_SPEED_VAL=$(get_speed_mbps "$IPERF_UL_RESULT")
          
          if [ "$DL_SPEED_VAL" = "N/A" ]; then DOWNLOAD_SPEED="N/A"; else DOWNLOAD_SPEED="${DL_SPEED_VAL} Mbps"; fi
          if [ "$UL_SPEED_VAL" = "N/A" ]; then UPLOAD_SPEED="N/A"; else UPLOAD_SPEED="${UL_SPEED_VAL} Mbps"; fi
          
          echo "download_speed=$DOWNLOAD_SPEED" >> $GITHUB_OUTPUT
          echo "upload_speed=$UPLOAD_SPEED" >> $GITHUB_OUTPUT
          echo "oci_ip=$OCI_PUBLIC_IP" >> $GITHUB_OUTPUT
          
          MASKED_IP=$(echo "$OCI_PUBLIC_IP" | awk -F. '{print $1"."$2"."$3".*"}')
          echo ""
          echo "==========================================="
          echo "âœ… æµ‹é€Ÿç»“æœ: $HOST_NAME"
          echo "   OCI IP: $MASKED_IP"
          echo "   ä¸‹è½½é€Ÿåº¦: $DOWNLOAD_SPEED"
          echo "   ä¸Šä¼ é€Ÿåº¦: $UPLOAD_SPEED"
          echo "==========================================="

      - name: Save result to file
        if: steps.host.outputs.skip != 'true'
        env:
          HOST_NAME: ${{ steps.host.outputs.name }}
          OCI_IP: ${{ steps.speedtest.outputs.oci_ip }}
          DOWNLOAD_SPEED: ${{ steps.speedtest.outputs.download_speed }}
          UPLOAD_SPEED: ${{ steps.speedtest.outputs.upload_speed }}
        run: |
          mkdir -p speedtest_results
          SAFE_NAME=$(echo "$HOST_NAME" | tr ' ' '_')
          TIMESTAMP=$(date -u +"%Y-%m-%d %H:%M:%S")
          echo "${HOST_NAME},${OCI_IP},${DOWNLOAD_SPEED},${UPLOAD_SPEED},${TIMESTAMP}" > "speedtest_results/${SAFE_NAME}.txt"

      - name: Upload speedtest result artifact
        if: steps.host.outputs.skip != 'true'
        uses: actions/upload-artifact@v4
        with:
          name: speedtest-result-${{ matrix.index }}
          path: speedtest_results/*.txt
          if-no-files-found: ignore
          retention-days: 1

  # æ”¶é›†æ‰€æœ‰æµ‹é€Ÿç»“æœ
  collect:
    name: Collect Speedtest Results
    needs: speedtest
    if: always()
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download all speedtest result artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          pattern: speedtest-result-*
        continue-on-error: true

      - name: Merge results to CSV
        run: |
          CSV_FILE="csv/iperf3_results.csv"
          mkdir -p csv
          
          # åˆ›å»º CSV å¤´ (å¦‚æœä¸å­˜åœ¨) - æ›´æ–°ä¸ºåŒ…å« upload_speed
          if [ ! -f "$CSV_FILE" ]; then
            echo "name,oci_ip,download_speed,upload_speed,timestamp" > "$CSV_FILE"
          else
             # å¦‚æœæ–‡ä»¶å­˜åœ¨ä½†æ²¡æœ‰ upload_speed åˆ— (æ—§æ ¼å¼), ç®€å•çš„å¤„ç†æ–¹å¼æ˜¯é‡ç½® header æˆ–è€…è¿½åŠ ç©ºåˆ—
             # ä¸ºäº†ç®€å•èµ·è§, æˆ‘ä»¬ä¿æŒåŸæ¥çš„æ–‡ä»¶è¿½åŠ æ¨¡å¼, ä½†æ–°çš„ header åªåœ¨æ–°æ–‡ä»¶æ—¶å†™å…¥
             # å¦‚æœç”¨æˆ·æƒ³å®Œå…¨é‡ç½®, å¯ä»¥æ‰‹åŠ¨åˆ é™¤ CSV
             HEADER=$(head -1 "$CSV_FILE")
             if [[ "$HEADER" != *"upload_speed"* ]]; then
                echo "Detected old CSV format, appending new column to header locally for display consistency (file unmodified)"
             fi
          fi
          
          # åˆå¹¶æ‰€æœ‰ç»“æœ
          if [ -d artifacts ]; then
            find artifacts -name "*.txt" -type f | while read result_file; do
              if [ -f "$result_file" ]; then
                cat "$result_file" >> "$CSV_FILE"
                echo "Added: $(cat "$result_file")"
              fi
            done
          fi
          
          echo ""
          echo "=== æœ¬æ¬¡æµ‹é€Ÿç»“æœ ==="
          tail -30 "$CSV_FILE"

      - name: Find fastest instance
        run: |
          CSV_FILE="csv/iperf3_results.csv"
          
          echo ""
          echo "==========================================="
          echo "ğŸ† é€Ÿåº¦æ’å (æŒ‰ä¸‹è½½é€Ÿåº¦æ’åº)"
          echo "==========================================="
          echo -e "ä¸‹è½½\t\tä¸Šä¼ \t\tå®ä¾‹åç§°\tIP"
          
          # æå–æœ¬æ¬¡æµ‹é€Ÿç»“æœå¹¶æ’åº (è·³è¿‡ N/A)
          # æ³¨æ„ï¼šCSV æ ¼å¼ç°åœ¨æ˜¯ name,oci_ip,download,upload,timestamp
          # awk $3=download, $4=upload
          TODAY=$(date -u +"%Y-%m-%d")
          grep "$TODAY" "$CSV_FILE" 2>/dev/null | grep -v "N/A" | \
            awk -F',' '{
              dl = $3; ul = $4;
              gsub(/ Mbps/, "", dl); gsub(/ Mbps/, "", ul);
              printf "%.2f Mbps\t%.2f Mbps\t%s\t%s\n", dl, ul, $1, $2
            }' | sort -k1 -rn | head -10
          
          echo ""
          echo "==========================================="

      - name: Commit results
        run: |
          if [ -f csv/iperf3_results.csv ]; then
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            
            # ä½¿ç”¨ rebase æ¨¡å¼æ‹‰å–æœ€æ–°ä»£ç ï¼Œé˜²æ­¢å†²çª
            git pull --rebase origin main || echo "Git pull failed, pushing anyway might fail"
            
            git add csv/iperf3_results.csv
            git diff --staged --quiet || git commit -m "Update iPerf3 speedtest results $(date -u +%Y-%m-%d)"
            git push || echo "Nothing to push"
          fi

      - name: Summary
        run: |
          echo "## ğŸš€ iPerf3 æµ‹é€Ÿç»“æœ (OCI <-> å®¶åº­)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          CSV_FILE="csv/iperf3_results.csv"
          TODAY=$(date -u +"%Y-%m-%d")
          
          echo "### ğŸ† é€Ÿåº¦æ’å (Top 10)" >> $GITHUB_STEP_SUMMARY
          echo "| ä¸‹è½½é€Ÿåº¦ | ä¸Šä¼ é€Ÿåº¦ | å®ä¾‹åç§° | OCI IP |" >> $GITHUB_STEP_SUMMARY
          echo "| :--- | :--- | :--- | :--- |" >> $GITHUB_STEP_SUMMARY
          
          grep "$TODAY" "$CSV_FILE" 2>/dev/null | grep -v "N/A" | \
            awk -F',' '{
              dl = $3; ul = $4;
              gsub(/ Mbps/, "", dl); gsub(/ Mbps/, "", ul);
              printf "| %s Mbps | %s Mbps | %s | %s |\n", dl, ul, $1, $2
            }' | sort -k2 -rn | head -10 >> $GITHUB_STEP_SUMMARY
            # sort -k2 means sorting by Download Speed (which is the first number in the output string because we used printf)
            # Actually sort -k2 in the pipe above sorts by the 2nd column of the pipe input.
            # The pipe input is "| DL | UL | Name | IP |" so column 1 is "|", col 2 is "DL". Correct.
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“Š å®Œæ•´ç»“æœ" >> $GITHUB_STEP_SUMMARY
          echo '```csv' >> $GITHUB_STEP_SUMMARY
          head -1 "$CSV_FILE" >> $GITHUB_STEP_SUMMARY
          grep "$TODAY" "$CSV_FILE" 2>/dev/null | head -30 >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

