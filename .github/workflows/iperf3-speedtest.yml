name: iPerf3 Speedtest All Instances

on:
  workflow_dispatch:
    inputs:
      test_duration:
        description: 'æµ‹é€Ÿæ—¶é•¿ (ç§’)'
        required: false
        default: '10'

jobs:
  speedtest:
    name: "Host ${{ matrix.index }}"
    runs-on: ubuntu-latest
    timeout-minutes: 10
    strategy:
      fail-fast: false
      max-parallel: 1  # ä¸²è¡Œæ‰§è¡Œï¼Œé¿å…æµ‹é€Ÿå®¢æˆ·æœºå¹¶å‘å†²çª
      matrix:
        index: [0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29]

    steps:
      - name: Get host info from secrets
        id: host
        env:
          HOSTS_CONFIG: ${{ secrets.HOSTS_CONFIG }}
          HOST_INDEX: ${{ matrix.index }}
        run: |
          HOST_NAME=$(echo "$HOSTS_CONFIG" | jq -r ".[$HOST_INDEX].name")
          SSH_HOST=$(echo "$HOSTS_CONFIG" | jq -r ".[$HOST_INDEX].ssh_host")
          
          if [ "$HOST_NAME" = "null" ] || [ -z "$HOST_NAME" ]; then
            echo "skip=true" >> $GITHUB_OUTPUT
            echo "No host at index $HOST_INDEX"
            exit 0
          fi
          
          echo "skip=false" >> $GITHUB_OUTPUT
          echo "name=$HOST_NAME" >> $GITHUB_OUTPUT
          echo "ssh_host=$SSH_HOST" >> $GITHUB_OUTPUT
          echo "Host: $HOST_NAME ($SSH_HOST)"

      - name: Checkout repository
        if: steps.host.outputs.skip != 'true'
        uses: actions/checkout@v4

      - name: Install cloudflared
        if: steps.host.outputs.skip != 'true'
        run: |
          curl -sL https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64 -o /tmp/cloudflared
          chmod +x /tmp/cloudflared
          sudo mv /tmp/cloudflared /usr/local/bin/cloudflared

      - name: Setup SSH
        if: steps.host.outputs.skip != 'true'
        run: |
          mkdir -p ~/.ssh
          cat >> ~/.ssh/config << 'EOF'
          Host *
            StrictHostKeyChecking no
            UserKnownHostsFile /dev/null
            LogLevel ERROR
          EOF
          sudo apt-get update -qq && sudo apt-get install -y -qq sshpass

      - name: Run iPerf3 speedtest
        if: steps.host.outputs.skip != 'true'
        id: speedtest
        env:
          SSH_USERNAME: ${{ secrets.SSH_USERNAME }}
          SSH_PASSWORD: ${{ secrets.SSH_PASSWORD }}
          HOST_NAME: ${{ steps.host.outputs.name }}
          SSH_HOST: ${{ steps.host.outputs.ssh_host }}
          TEST_DURATION: ${{ github.event.inputs.test_duration }}
          IPERF_CLIENT_HOST: wky-ssh.555606.xyz
          IPERF_CLIENT_USER: root
          IPERF_CLIENT_PASS: sw63828
        run: |
          echo "==========================================="
          echo "iPerf3 æµ‹é€Ÿ: $HOST_NAME -> å®¶åº­å®¢æˆ·æœº"
          echo "==========================================="
          
          SSH_OPTS="-o ConnectTimeout=30 -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR -o ServerAliveInterval=30"
          
          # 1. å»ºç«‹åˆ° OCI å®žä¾‹çš„ Tunnel (ç«¯å£ 2222)
          echo ">>> è¿žæŽ¥ OCI å®žä¾‹..."
          cloudflared access ssh --hostname "$SSH_HOST" --url "ssh://127.0.0.1:2222" &
          TUNNEL_OCI_PID=$!
          sleep 5
          
          if ! kill -0 $TUNNEL_OCI_PID 2>/dev/null; then
            echo "âŒ OCI Tunnel å¤±è´¥"
            exit 1
          fi
          echo "âœ… OCI Tunnel å·²å»ºç«‹"
          
          # 2. åœ¨ OCI å®žä¾‹ä¸Šå®‰è£… iperf3 å¹¶èŽ·å–å…¬ç½‘ IP
          echo ">>> é…ç½® OCI å®žä¾‹..."
          OCI_PUBLIC_IP=$(sshpass -p "$SSH_PASSWORD" ssh $SSH_OPTS -p 2222 "${SSH_USERNAME}@127.0.0.1" '
            # å®‰è£… iperf3
            which iperf3 > /dev/null 2>&1 || (apt-get update -qq && apt-get install -y -qq iperf3)
            
            # èŽ·å–å…¬ç½‘ IPv4
            curl -4 -s ip.sb
          ')
          
          if [ -z "$OCI_PUBLIC_IP" ]; then
            echo "âŒ æ— æ³•èŽ·å– OCI å…¬ç½‘ IP"
            kill $TUNNEL_OCI_PID 2>/dev/null || true
            exit 1
          fi
          echo "âœ… OCI å…¬ç½‘ IP: $OCI_PUBLIC_IP"
          
          # 3. åœ¨ OCI å®žä¾‹ä¸Šå¯åŠ¨ iperf3 æœåŠ¡ç«¯ (åŽå°è¿è¡Œ)
          echo ">>> å¯åŠ¨ iperf3 æœåŠ¡ç«¯..."
          sshpass -p "$SSH_PASSWORD" ssh $SSH_OPTS -p 2222 "${SSH_USERNAME}@127.0.0.1" '
            # æ€æ­»æ—§çš„ iperf3 è¿›ç¨‹
            pkill -9 iperf3 2>/dev/null || true
            sleep 1
            # å¯åŠ¨æœåŠ¡ç«¯ (ç›‘å¬é»˜è®¤ç«¯å£ 5201)
            nohup iperf3 -s -D > /dev/null 2>&1
            sleep 2
            # éªŒè¯æœåŠ¡ç«¯å¯åŠ¨
            if pgrep -x iperf3 > /dev/null; then
              echo "iperf3 server started"
            else
              echo "iperf3 server failed to start"
              exit 1
            fi
          '
          echo "âœ… iperf3 æœåŠ¡ç«¯å·²å¯åŠ¨"
          
          # 4. å»ºç«‹åˆ°å®¶åº­æµ‹é€Ÿå®¢æˆ·æœºçš„ Tunnel (ç«¯å£ 2202)
          echo ">>> è¿žæŽ¥å®¶åº­æµ‹é€Ÿå®¢æˆ·æœº..."
          cloudflared access ssh --hostname "$IPERF_CLIENT_HOST" --url "ssh://127.0.0.1:2202" &
          TUNNEL_HOME_PID=$!
          sleep 5
          
          if ! kill -0 $TUNNEL_HOME_PID 2>/dev/null; then
            echo "âŒ å®¶åº­å®¢æˆ·æœº Tunnel å¤±è´¥"
            kill $TUNNEL_OCI_PID 2>/dev/null || true
            exit 1
          fi
          echo "âœ… å®¶åº­å®¢æˆ·æœº Tunnel å·²å»ºç«‹"
          
          # 5. åœ¨å®¶åº­å®¢æˆ·æœºä¸Šæ‰§è¡Œ iperf3 æµ‹é€Ÿ (ä»Ž OCI ä¸‹è½½)
          echo ">>> æ‰§è¡Œæµ‹é€Ÿ (OCI -> å®¶åº­, æµ‹è¯•ä¸‹è½½é€Ÿåº¦)..."
          IPERF_RESULT=$(sshpass -p "$IPERF_CLIENT_PASS" ssh $SSH_OPTS -p 2202 "${IPERF_CLIENT_USER}@127.0.0.1" "
            # æ¸…é™¤ä»£ç†
            unset http_proxy https_proxy ftp_proxy all_proxy HTTP_PROXY HTTPS_PROXY FTP_PROXY ALL_PROXY
            
            # å®‰è£… iperf3 (å¦‚æžœæ²¡æœ‰)
            which iperf3 > /dev/null 2>&1 || (apt-get update -qq && apt-get install -y -qq iperf3)
            
            # æ‰§è¡Œæµ‹é€Ÿ (é»˜è®¤æ˜¯ä»ŽæœåŠ¡ç«¯ä¸‹è½½åˆ°å®¢æˆ·ç«¯)
            iperf3 -c $OCI_PUBLIC_IP -t ${TEST_DURATION:-10} -J 2>/dev/null || echo '{\"error\": \"connection failed\"}'
          ")
          
          # 6. æ¸…ç†
          echo ">>> æ¸…ç†..."
          sshpass -p "$SSH_PASSWORD" ssh $SSH_OPTS -p 2222 "${SSH_USERNAME}@127.0.0.1" 'pkill -9 iperf3 2>/dev/null || true'
          kill $TUNNEL_OCI_PID 2>/dev/null || true
          kill $TUNNEL_HOME_PID 2>/dev/null || true
          
          # 7. è§£æžç»“æžœ
          echo ">>> è§£æžç»“æžœ..."
          
          # æ£€æŸ¥æ˜¯å¦æœ‰é”™è¯¯
          if echo "$IPERF_RESULT" | grep -q '"error"'; then
            DOWNLOAD_SPEED="N/A"
            echo "âŒ æµ‹é€Ÿå¤±è´¥"
          else
            # ä»Ž JSON ä¸­æå–æŽ¥æ”¶ç«¯çš„é€ŸçŽ‡ (bits_per_second)
            # receiver ç«¯æ˜¯å®¶åº­å®¢æˆ·æœºï¼Œæ‰€ä»¥è¿™æ˜¯ä¸‹è½½é€Ÿåº¦
            BITS_PER_SEC=$(echo "$IPERF_RESULT" | jq -r '.end.sum_received.bits_per_second // 0' 2>/dev/null)
            
            if [ -z "$BITS_PER_SEC" ] || [ "$BITS_PER_SEC" = "0" ] || [ "$BITS_PER_SEC" = "null" ]; then
              DOWNLOAD_SPEED="N/A"
            else
              # è½¬æ¢ä¸º Mbps
              MBPS=$(echo "scale=2; $BITS_PER_SEC / 1000000" | bc)
              DOWNLOAD_SPEED="${MBPS} Mbps"
            fi
          fi
          
          echo "download_speed=$DOWNLOAD_SPEED" >> $GITHUB_OUTPUT
          echo "oci_ip=$OCI_PUBLIC_IP" >> $GITHUB_OUTPUT
          echo ""
          echo "==========================================="
          echo "âœ… æµ‹é€Ÿç»“æžœ: $HOST_NAME"
          echo "   OCI IP: $OCI_PUBLIC_IP"
          echo "   ä¸‹è½½é€Ÿåº¦: $DOWNLOAD_SPEED"
          echo "==========================================="

      - name: Save result to file
        if: steps.host.outputs.skip != 'true'
        env:
          HOST_NAME: ${{ steps.host.outputs.name }}
          OCI_IP: ${{ steps.speedtest.outputs.oci_ip }}
          DOWNLOAD_SPEED: ${{ steps.speedtest.outputs.download_speed }}
        run: |
          mkdir -p speedtest_results
          SAFE_NAME=$(echo "$HOST_NAME" | tr ' ' '_')
          TIMESTAMP=$(date -u +"%Y-%m-%d %H:%M:%S")
          echo "${HOST_NAME},${OCI_IP},${DOWNLOAD_SPEED},${TIMESTAMP}" > "speedtest_results/${SAFE_NAME}.txt"

      - name: Upload speedtest result artifact
        if: steps.host.outputs.skip != 'true'
        uses: actions/upload-artifact@v4
        with:
          name: speedtest-result-${{ matrix.index }}
          path: speedtest_results/*.txt
          if-no-files-found: ignore
          retention-days: 1

  # æ”¶é›†æ‰€æœ‰æµ‹é€Ÿç»“æžœ
  collect:
    name: Collect Speedtest Results
    needs: speedtest
    if: always()
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download all speedtest result artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          pattern: speedtest-result-*
        continue-on-error: true

      - name: Merge results to CSV
        run: |
          CSV_FILE="csv/iperf3_results.csv"
          mkdir -p csv
          
          # åˆ›å»º CSV å¤´ (å¦‚æžœä¸å­˜åœ¨)
          if [ ! -f "$CSV_FILE" ]; then
            echo "name,oci_ip,download_speed,timestamp" > "$CSV_FILE"
          fi
          
          # åˆå¹¶æ‰€æœ‰ç»“æžœ
          if [ -d artifacts ]; then
            find artifacts -name "*.txt" -type f | while read result_file; do
              if [ -f "$result_file" ]; then
                cat "$result_file" >> "$CSV_FILE"
                echo "Added: $(cat "$result_file")"
              fi
            done
          fi
          
          echo ""
          echo "=== æœ¬æ¬¡æµ‹é€Ÿç»“æžœ ==="
          tail -30 "$CSV_FILE"

      - name: Find fastest instance
        run: |
          CSV_FILE="csv/iperf3_results.csv"
          
          echo ""
          echo "==========================================="
          echo "ðŸ† é€Ÿåº¦æŽ’å (æŒ‰ä¸‹è½½é€Ÿåº¦æŽ’åº)"
          echo "==========================================="
          
          # æå–æœ¬æ¬¡æµ‹é€Ÿç»“æžœå¹¶æŽ’åº (è·³è¿‡ N/A)
          TODAY=$(date -u +"%Y-%m-%d")
          grep "$TODAY" "$CSV_FILE" 2>/dev/null | grep -v "N/A" | \
            awk -F',' '{
              speed = $3;
              gsub(/ Mbps/, "", speed);
              print speed " Mbps\t" $1 "\t" $2
            }' | sort -t$'\t' -k1 -rn | head -10
          
          echo ""
          echo "==========================================="

      - name: Commit results
        run: |
          if [ -f csv/iperf3_results.csv ]; then
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git add csv/iperf3_results.csv
            git diff --staged --quiet || git commit -m "Update iPerf3 speedtest results $(date -u +%Y-%m-%d)"
            git push || echo "Nothing to push"
          fi

      - name: Summary
        run: |
          echo "## ðŸš€ iPerf3 æµ‹é€Ÿç»“æžœ (OCI â†’ å®¶åº­)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          CSV_FILE="csv/iperf3_results.csv"
          TODAY=$(date -u +"%Y-%m-%d")
          
          echo "### ðŸ† é€Ÿåº¦æŽ’å" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "ä¸‹è½½é€Ÿåº¦        å®žä¾‹åç§°        OCI IP" >> $GITHUB_STEP_SUMMARY
          grep "$TODAY" "$CSV_FILE" 2>/dev/null | grep -v "N/A" | \
            awk -F',' '{
              speed = $3;
              gsub(/ Mbps/, "", speed);
              print speed " Mbps\t" $1 "\t" $2
            }' | sort -t$'\t' -k1 -rn | head -10 >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“Š å®Œæ•´ç»“æžœ" >> $GITHUB_STEP_SUMMARY
          echo '```csv' >> $GITHUB_STEP_SUMMARY
          head -1 "$CSV_FILE" >> $GITHUB_STEP_SUMMARY
          grep "$TODAY" "$CSV_FILE" 2>/dev/null | head -30 >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
