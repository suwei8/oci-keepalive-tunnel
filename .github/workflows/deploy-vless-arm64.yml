name: Deploy VLESS WS (ARM64)

on:
  schedule:
    - cron: "0 4 * * 1"
  workflow_dispatch:
    inputs:
      force_redeploy:
        description: 'å¼ºåˆ¶é‡æ–°éƒ¨ç½²'
        required: false
        default: 'false'
        type: choice
        options:
          - 'false'
          - 'true'
      target_host:
        description: 'æŒ‡å®šéƒ¨ç½²ä¸»æœº (ç•™ç©º=å…¨éƒ¨)'
        required: false
        default: ''

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false

jobs:
  deploy:
    name: "Deploy VLESS"
    runs-on: ubuntu-latest
    timeout-minutes: 60
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install cloudflared
        run: |
          sudo cp bin/cloudflared /usr/local/bin/cloudflared
          cloudflared --version

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          cat >> ~/.ssh/config << 'EOF'
          Host *
            StrictHostKeyChecking no
            UserKnownHostsFile /dev/null
            LogLevel ERROR
          EOF
          sudo apt-get update -qq && sudo apt-get install -y -qq sshpass jq

      - name: Deploy to all hosts
        id: deploy
        env:
          HOSTS_CONFIG: ${{ secrets.HOSTS_CONFIG }}
          SSH_USERNAME: ${{ secrets.SSH_USERNAME }}
          SSH_PASSWORD: ${{ secrets.SSH_PASSWORD }}
          CF_API_EMAIL: ${{ secrets.CF_API_EMAIL }}
          CF_API_KEY: ${{ secrets.CF_API_KEY }}
          CF_ACCOUNT_ID: ${{ secrets.CF_ACCOUNT_ID }}
          CF_ZONE_ID: ${{ secrets.CF_ZONE_ID }}
          CF_API_EMAIL_555606: ${{ secrets.CF_API_EMAIL_555606 }}
          CF_API_KEY_555606: ${{ secrets.CF_API_KEY_555606 }}
          CF_ACCOUNT_ID_555606: ${{ secrets.CF_ACCOUNT_ID_555606 }}
          CF_ZONE_ID_555606: ${{ secrets.CF_ZONE_ID_555606 }}
          VLESS_UUID: ${{ secrets.VLESS_UUID }}
          FORCE_REDEPLOY: ${{ github.event.inputs.force_redeploy }}
          TARGET_HOST: ${{ github.event.inputs.target_host }}
        run: |
          SSH_OPTS="-o ConnectTimeout=30 -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR -o ServerAliveInterval=30"
          
          # éƒ¨åˆ†éšè—åŸŸåå‡½æ•° (å¦‚: cf-bd3.hhwpxh.com -> cf-bd3.**pxh.com)
          mask_domain() {
            local domain="$1"
            # è·å–å­åŸŸåå‰ç¼€å’Œä¸»åŸŸåå7ä¸ªå­—ç¬¦
            local prefix=$(echo "$domain" | cut -d. -f1)
            local suffix=$(echo "$domain" | grep -oE '[^.]+\.[^.]+$' | tail -c 8)
            echo "${prefix}.**${suffix}"
          }
          
          NODES_INFO=""
          NODES_DIRECT_INFO=""
          DEPLOYED_COUNT=0
          SKIPPED_COUNT=0
          
          HOST_COUNT=$(echo "$HOSTS_CONFIG" | jq '. | length')
          echo "Total hosts: $HOST_COUNT"
          
          for INDEX in $(seq 0 $((HOST_COUNT - 1))); do
            host_item=$(echo "$HOSTS_CONFIG" | jq -c ".[$INDEX]")
            HOST_NAME=$(echo "$host_item" | jq -r '.name')
            SSH_HOST=$(echo "$host_item" | jq -r '.ssh_host')
            VLESS_HOST=$(echo "$host_item" | jq -r '.vless_host')
            PROXY_DOMAIN=$(echo "$host_item" | jq -r '.proxy_domains')
            CPU_TYPE=$(echo "$host_item" | jq -r '.cpu_type')
            
            # åˆ›å»ºéšè—ç‰ˆæœ¬ç”¨äºæ—¥å¿—æ˜¾ç¤º
            MASKED_VLESS_HOST=$(mask_domain "$VLESS_HOST")
            MASKED_PROXY_DOMAIN=$(mask_domain "$PROXY_DOMAIN")
            
            echo "::add-mask::$SSH_HOST"
            echo "::add-mask::$VLESS_HOST"
            echo "::add-mask::$PROXY_DOMAIN"
            
            if [ "$HOST_NAME" = "null" ] || [ -z "$HOST_NAME" ]; then
              continue
            fi
            
            # åªå¤„ç† arm64 ç±»å‹çš„ä¸»æœº
            if [ "$CPU_TYPE" != "arm64" ]; then
              continue
            fi
            
            if [ "$VLESS_HOST" = "null" ] || [ -z "$VLESS_HOST" ]; then
              echo ">>> è·³è¿‡ $HOST_NAME (æ—  vless_host é…ç½®)"
              continue
            fi
            
            if [ -n "$TARGET_HOST" ] && [ "$HOST_NAME" != "$TARGET_HOST" ]; then
              continue
            fi
            
            echo ""
            echo "==========================================="
            echo "Processing: $HOST_NAME"
            echo "==========================================="
            
            pkill -f "cloudflared.*2222" 2>/dev/null || true
            sleep 2
            cloudflared access ssh --hostname "$SSH_HOST" --url "ssh://127.0.0.1:2222" &
            TUNNEL_PID=$!
            sleep 5
            
            if ! kill -0 $TUNNEL_PID 2>/dev/null; then
              echo "âŒ Tunnel è¿æ¥å¤±è´¥"
              continue
            fi
            
            # æ£€æŸ¥ xray-vless æœåŠ¡çŠ¶æ€ (ä½¿ç”¨ systemd)
            SERVICE_ACTIVE=$(sshpass -p "$SSH_PASSWORD" ssh $SSH_OPTS -n -p 2222 "${SSH_USERNAME}@127.0.0.1" 'sudo systemctl is-active xray-vless 2>/dev/null || echo "inactive"' 2>&1 | tail -1) || true
            
            if [ "$SERVICE_ACTIVE" = "active" ] && [ "$FORCE_REDEPLOY" != "true" ]; then
              echo "â­ï¸ æœåŠ¡è¿è¡Œä¸­ï¼Œæ£€æŸ¥é…ç½®åè·³è¿‡"
              
              # å³ä½¿è·³è¿‡éƒ¨ç½²ä¹Ÿæ£€æŸ¥ DNS è®°å½• (Cloudflare Tunnel)
              # æ ¹æ® vless_host åŸŸåé€‰æ‹©è´¦æˆ·
              if echo "$VLESS_HOST" | grep -q "555606.xyz"; then
                VLESS_CF_EMAIL="$CF_API_EMAIL_555606"
                VLESS_CF_KEY="$CF_API_KEY_555606"
                VLESS_ZONE_ID="$CF_ZONE_ID_555606"
              else
                VLESS_CF_EMAIL="$CF_API_EMAIL"
                VLESS_CF_KEY="$CF_API_KEY"
                VLESS_ZONE_ID="$CF_ZONE_ID"
              fi
              
              # æ ¹æ® ssh_host åŸŸåæŸ¥æ‰¾ Tunnel ID
              if echo "$SSH_HOST" | grep -q "555606.xyz"; then
                TUNNEL_CF_EMAIL="$CF_API_EMAIL_555606"
                TUNNEL_CF_KEY="$CF_API_KEY_555606"
                TUNNEL_CF_ACCOUNT="$CF_ACCOUNT_ID_555606"
              else
                TUNNEL_CF_EMAIL="$CF_API_EMAIL"
                TUNNEL_CF_KEY="$CF_API_KEY"
                TUNNEL_CF_ACCOUNT="$CF_ACCOUNT_ID"
              fi
              
              # æŸ¥æ‰¾ Tunnel ID
              TUNNELS=$(curl -s "https://api.cloudflare.com/client/v4/accounts/${TUNNEL_CF_ACCOUNT}/cfd_tunnel?is_deleted=false" \
                -H "X-Auth-Email: ${TUNNEL_CF_EMAIL}" \
                -H "X-Auth-Key: ${TUNNEL_CF_KEY}")
              
              TUNNEL_ID=""
              for tid in $(echo "$TUNNELS" | jq -r '.result[].id // empty' 2>/dev/null); do
                CONFIG=$(curl -s "https://api.cloudflare.com/client/v4/accounts/${TUNNEL_CF_ACCOUNT}/cfd_tunnel/${tid}/configurations" \
                  -H "X-Auth-Email: ${TUNNEL_CF_EMAIL}" \
                  -H "X-Auth-Key: ${TUNNEL_CF_KEY}")
                
                if echo "$CONFIG" | grep -q "$SSH_HOST"; then
                  TUNNEL_ID="$tid"
                  break
                fi
              done
              
              if [ -n "$TUNNEL_ID" ]; then
                TUNNEL_CNAME="${TUNNEL_ID}.cfargotunnel.com"
                # æ£€æŸ¥ Tunnel ingress æ˜¯å¦åŒ…å« VLESS_HOST (ç•¥è¿‡è¯¦ç»†æ£€æŸ¥ï¼Œå‡è®¾å·²å­˜åœ¨)
                
                # æ£€æŸ¥ DNS è®°å½•æ˜¯å¦å­˜åœ¨åŠå†…å®¹æ˜¯å¦æ­£ç¡®
                DNS_CHECK=$(curl -s "https://api.cloudflare.com/client/v4/zones/${VLESS_ZONE_ID}/dns_records?name=${VLESS_HOST}" \
                  -H "X-Auth-Email: ${VLESS_CF_EMAIL}" \
                  -H "X-Auth-Key: ${VLESS_CF_KEY}")
                
                EXISTING_DNS_ID=$(echo "$DNS_CHECK" | jq -r '.result[0].id // empty')
                EXISTING_DNS_CONTENT=$(echo "$DNS_CHECK" | jq -r '.result[0].content // empty')
                
                if [ -z "$EXISTING_DNS_ID" ]; then
                  echo ">>> åˆ›å»ºç¼ºå¤±çš„ DNS CNAME: $MASKED_VLESS_HOST -> Tunnel"
                  DNS_RESULT=$(curl -s -X POST "https://api.cloudflare.com/client/v4/zones/${VLESS_ZONE_ID}/dns_records" \
                    -H "X-Auth-Email: ${VLESS_CF_EMAIL}" \
                    -H "X-Auth-Key: ${VLESS_CF_KEY}" \
                    -H "Content-Type: application/json" \
                    -d "{\"type\":\"CNAME\",\"name\":\"${VLESS_HOST}\",\"content\":\"${TUNNEL_CNAME}\",\"proxied\":true}")
                elif [ "$EXISTING_DNS_CONTENT" != "$TUNNEL_CNAME" ]; then
                  echo ">>> æ›´æ–° DNS CNAME: $MASKED_VLESS_HOST -> Tunnel"
                  DNS_RESULT=$(curl -s -X PUT "https://api.cloudflare.com/client/v4/zones/${VLESS_ZONE_ID}/dns_records/${EXISTING_DNS_ID}" \
                    -H "X-Auth-Email: ${VLESS_CF_EMAIL}" \
                    -H "X-Auth-Key: ${VLESS_CF_KEY}" \
                    -H "Content-Type: application/json" \
                    -d "{\"type\":\"CNAME\",\"name\":\"${VLESS_HOST}\",\"content\":\"${TUNNEL_CNAME}\",\"proxied\":true}")
                fi
              fi
              
              SKIPPED_COUNT=$((SKIPPED_COUNT + 1))
              
              # ç”Ÿæˆä¸¤ä¸ªé“¾æ¥
              # 1. Cloudflare Tunnel é“¾æ¥
              NODES_INFO="${NODES_INFO}vless://${VLESS_UUID}@${VLESS_HOST}:443?encryption=none&security=tls&sni=${VLESS_HOST}&type=ws&host=${VLESS_HOST}&path=%2Flibrary1629#${HOST_NAME}\n"
              
              # 2. ç›´è¿å…æµé“¾æ¥ (å¦‚æœ proxy_domains å­˜åœ¨)
              if [ "$PROXY_DOMAIN" != "null" ] && [ -n "$PROXY_DOMAIN" ]; then
                 NODES_DIRECT_INFO="${NODES_DIRECT_INFO}vless://${VLESS_UUID}@${PROXY_DOMAIN}:5443?encryption=none&security=tls&sni=${PROXY_DOMAIN}&type=ws&headerType=http&host=a.189.cn&path=%2Flibrary1629#${HOST_NAME}-ç›´è¿å…æµ\n"
              fi
              
              kill $TUNNEL_PID 2>/dev/null || true
              continue
            fi
            
            echo ">>> å¼€å§‹éƒ¨ç½²..."
            
            # ============================================
            # æ­¥éª¤1: é…ç½® Cloudflare è´¦æˆ·
            # ============================================
            echo ">>> é…ç½® Cloudflare è´¦æˆ·..."
            
            # æ ¹æ® vless_host åŸŸåé€‰æ‹©è´¦æˆ· (ç”¨äº Tunnel DNS)
            if echo "$VLESS_HOST" | grep -q "555606.xyz"; then
              VLESS_CF_EMAIL="$CF_API_EMAIL_555606"
              VLESS_CF_KEY="$CF_API_KEY_555606"
              VLESS_CF_ACCOUNT="$CF_ACCOUNT_ID_555606"
              VLESS_ZONE_ID="$CF_ZONE_ID_555606"
              VLESS_ACCOUNT_NAME="555606.xyz"
            else
              VLESS_CF_EMAIL="$CF_API_EMAIL"
              VLESS_CF_KEY="$CF_API_KEY"
              VLESS_CF_ACCOUNT="$CF_ACCOUNT_ID"
              VLESS_ZONE_ID="$CF_ZONE_ID"
              VLESS_ACCOUNT_NAME="hhwpxh.com"
            fi
            
            # æ ¹æ® ssh_host åŸŸåé€‰æ‹©è´¦æˆ· (ç”¨äºæŸ¥æ‰¾ Tunnel)
            if echo "$SSH_HOST" | grep -q "555606.xyz"; then
              TUNNEL_CF_EMAIL="$CF_API_EMAIL_555606"
              TUNNEL_CF_KEY="$CF_API_KEY_555606"
              TUNNEL_CF_ACCOUNT="$CF_ACCOUNT_ID_555606"
              TUNNEL_ACCOUNT_NAME="555606.xyz"
            else
              TUNNEL_CF_EMAIL="$CF_API_EMAIL"
              TUNNEL_CF_KEY="$CF_API_KEY"
              TUNNEL_CF_ACCOUNT="$CF_ACCOUNT_ID"
              TUNNEL_ACCOUNT_NAME="hhwpxh.com"
            fi
            
            echo ">>> VLESS DNS è´¦æˆ·: $VLESS_ACCOUNT_NAME"
            echo ">>> Tunnel è´¦æˆ·: $TUNNEL_ACCOUNT_NAME"
            
            # æŸ¥æ‰¾åŒ…å« ssh_host çš„ Tunnel (åœ¨ SSH_HOST å¯¹åº”çš„è´¦æˆ·ä¸­)
            echo ">>> æŸ¥æ‰¾ Tunnel..."
            TUNNELS=$(curl -s "https://api.cloudflare.com/client/v4/accounts/${TUNNEL_CF_ACCOUNT}/cfd_tunnel?is_deleted=false" \
              -H "X-Auth-Email: ${TUNNEL_CF_EMAIL}" \
              -H "X-Auth-Key: ${TUNNEL_CF_KEY}")
            
            TUNNEL_ID=""
            for tid in $(echo "$TUNNELS" | jq -r '.result[].id // empty' 2>/dev/null); do
              CONFIG=$(curl -s "https://api.cloudflare.com/client/v4/accounts/${TUNNEL_CF_ACCOUNT}/cfd_tunnel/${tid}/configurations" \
                -H "X-Auth-Email: ${TUNNEL_CF_EMAIL}" \
                -H "X-Auth-Key: ${TUNNEL_CF_KEY}")
              
              if echo "$CONFIG" | grep -q "$SSH_HOST"; then
                TUNNEL_ID="$tid"
                TUNNEL_NAME=$(echo "$TUNNELS" | jq -r ".result[] | select(.id==\"$tid\") | .name")
                echo ">>> æ‰¾åˆ° Tunnel: $TUNNEL_NAME ($TUNNEL_ID)"
                break
              fi
            done
            
            if [ -z "$TUNNEL_ID" ]; then
              echo "âš ï¸ æœªæ‰¾åˆ°åŒ…å« SSH_HOST çš„ Tunnel"
              kill $TUNNEL_PID 2>/dev/null || true
              continue
            fi
            
            # è·å–å½“å‰ ingress é…ç½®
            CURRENT_CONFIG=$(curl -s "https://api.cloudflare.com/client/v4/accounts/${TUNNEL_CF_ACCOUNT}/cfd_tunnel/${TUNNEL_ID}/configurations" \
              -H "X-Auth-Email: ${TUNNEL_CF_EMAIL}" \
              -H "X-Auth-Key: ${TUNNEL_CF_KEY}")
            
            CURRENT_INGRESS=$(echo "$CURRENT_CONFIG" | jq '.result.config.ingress')
            
            # æ£€æŸ¥ vless_host æ˜¯å¦å·²å­˜åœ¨
            if echo "$CURRENT_INGRESS" | grep -q "$VLESS_HOST"; then
              echo ">>> VLESS hostname å·²å­˜åœ¨äº Tunnel é…ç½®ä¸­"
            else
              echo ">>> æ·»åŠ  VLESS hostname: $MASKED_VLESS_HOST -> http://127.0.0.1:10086"
              
              # åœ¨ catch-all è§„åˆ™ä¹‹å‰æ’å…¥æ–°çš„ ingress
              NEW_INGRESS=$(echo "$CURRENT_INGRESS" | jq --arg host "$VLESS_HOST" \
                '. | .[:-1] + [{"hostname": $host, "service": "http://127.0.0.1:10086", "originRequest": {}}] + [.[-1]]')
              
              # æ›´æ–° Tunnel é…ç½®
              UPDATE_RESULT=$(curl -s -X PUT "https://api.cloudflare.com/client/v4/accounts/${TUNNEL_CF_ACCOUNT}/cfd_tunnel/${TUNNEL_ID}/configurations" \
                -H "X-Auth-Email: ${TUNNEL_CF_EMAIL}" \
                -H "X-Auth-Key: ${TUNNEL_CF_KEY}" \
                -H "Content-Type: application/json" \
                -d "{\"config\":{\"ingress\":$NEW_INGRESS}}")
              
              if echo "$UPDATE_RESULT" | jq -e '.success' > /dev/null; then
                echo "âœ… Tunnel é…ç½®å·²æ›´æ–°"
              else
                echo "âŒ Tunnel é…ç½®æ›´æ–°å¤±è´¥"
                echo "$UPDATE_RESULT" | jq '.errors'
              fi
            fi
            
            # åˆ›å»º DNS CNAME è®°å½• (æŒ‡å‘ Tunnel)
            echo ">>> æ£€æŸ¥ DNS è®°å½•..."
            
            TUNNEL_CNAME="${TUNNEL_ID}.cfargotunnel.com"
            
            # æ£€æŸ¥ DNS è®°å½•æ˜¯å¦å·²å­˜åœ¨åŠå†…å®¹æ˜¯å¦æ­£ç¡® (ä½¿ç”¨ VLESS è´¦æˆ·)
            DNS_CHECK=$(curl -s "https://api.cloudflare.com/client/v4/zones/${VLESS_ZONE_ID}/dns_records?name=${VLESS_HOST}" \
              -H "X-Auth-Email: ${VLESS_CF_EMAIL}" \
              -H "X-Auth-Key: ${VLESS_CF_KEY}")
            
            EXISTING_DNS_ID=$(echo "$DNS_CHECK" | jq -r '.result[0].id // empty')
            EXISTING_DNS_CONTENT=$(echo "$DNS_CHECK" | jq -r '.result[0].content // empty')
            
            if [ -z "$EXISTING_DNS_ID" ]; then
              echo ">>> åˆ›å»º DNS CNAME: $MASKED_VLESS_HOST -> Tunnel"
              DNS_RESULT=$(curl -s -X POST "https://api.cloudflare.com/client/v4/zones/${VLESS_ZONE_ID}/dns_records" \
                -H "X-Auth-Email: ${VLESS_CF_EMAIL}" \
                -H "X-Auth-Key: ${VLESS_CF_KEY}" \
                -H "Content-Type: application/json" \
                -d "{\"type\":\"CNAME\",\"name\":\"${VLESS_HOST}\",\"content\":\"${TUNNEL_CNAME}\",\"proxied\":true}")
              
              if echo "$DNS_RESULT" | jq -e '.success' > /dev/null; then
                echo "âœ… DNS CNAME å·²åˆ›å»º"
              else
                echo "âŒ DNS CNAME åˆ›å»ºå¤±è´¥"
                echo "$DNS_RESULT" | jq '.errors'
              fi
            elif [ "$EXISTING_DNS_CONTENT" != "$TUNNEL_CNAME" ]; then
              echo ">>> æ›´æ–° DNS CNAME: $MASKED_VLESS_HOST -> Tunnel (åŸ: ${EXISTING_DNS_CONTENT})"
              DNS_RESULT=$(curl -s -X PUT "https://api.cloudflare.com/client/v4/zones/${VLESS_ZONE_ID}/dns_records/${EXISTING_DNS_ID}" \
                -H "X-Auth-Email: ${VLESS_CF_EMAIL}" \
                -H "X-Auth-Key: ${VLESS_CF_KEY}" \
                -H "Content-Type: application/json" \
                -d "{\"type\":\"CNAME\",\"name\":\"${VLESS_HOST}\",\"content\":\"${TUNNEL_CNAME}\",\"proxied\":true}")
              
              if echo "$DNS_RESULT" | jq -e '.success' > /dev/null; then
                echo "âœ… DNS CNAME å·²æ›´æ–°"
              else
                echo "âŒ DNS CNAME æ›´æ–°å¤±è´¥"
                echo "$DNS_RESULT" | jq '.errors'
              fi
            else
              echo "âœ… DNS è®°å½•å·²å­˜åœ¨ä¸”æ­£ç¡®"
            fi
            
            # ============================================
            # æ­¥éª¤2: éƒ¨ç½² Xray (åŒ…å«ç›´è¿å…æµé…ç½®)
            # ============================================
            echo ">>> æ£€æŸ¥/å®‰è£… Xray..."
            sshpass -p "$SSH_PASSWORD" ssh $SSH_OPTS -n -p 2222 "${SSH_USERNAME}@127.0.0.1" "
              # å®‰è£…å¿…è¦å·¥å…· (Firewall & Unzip)
              export DEBIAN_FRONTEND=noninteractive
              sudo apt-get update -qq 2>/dev/null || true
              echo "iptables-persistent iptables-persistent/autosave_v4 boolean true" | sudo debconf-set-selections 2>/dev/null || true
              echo "iptables-persistent iptables-persistent/autosave_v6 boolean true" | sudo debconf-set-selections 2>/dev/null || true
              sudo apt-get install -y -qq iptables iptables-persistent netfilter-persistent unzip 2>/dev/null || true

              # å¼€æ”¾ç«¯å£ (Idempotent check)
              sudo iptables -C INPUT -p tcp --dport 5443 -j ACCEPT 2>/dev/null || sudo iptables -I INPUT -p tcp --dport 5443 -j ACCEPT
              sudo netfilter-persistent save 2>/dev/null || true
              
              # æ£€æŸ¥å®‰è£…
              if [ ! -f /usr/local/bin/xray ]; then
                echo '>>> ä¸‹è½½ Xray...'
                cd /tmp
                wget -q https://github.com/XTLS/Xray-core/releases/latest/download/Xray-linux-arm64-v8a.zip -O xray.zip
                unzip -o xray.zip xray geoip.dat geosite.dat
                sudo mv xray /usr/local/bin/
                sudo chmod +x /usr/local/bin/xray
                sudo mkdir -p /usr/local/share/xray
                sudo mv geoip.dat geosite.dat /usr/local/share/xray/
                rm -f xray.zip
              fi
            " 2>&1 || true
            
            echo ">>> åˆ›å»º Xray é…ç½® (ä½¿ç”¨ jq ç”Ÿæˆ)..."
            
            # ä½¿ç”¨ jq åœ¨ Runner æœ¬åœ°ç”Ÿæˆå®‰å…¨çš„ JSON é…ç½®
            if [ "$PROXY_DOMAIN" != "null" ] && [ -n "$PROXY_DOMAIN" ]; then
              # åŒå…¥å£é…ç½® (Tunnel + Direct No-TLS)
              XRAY_CONFIG=$(jq -n \
                --arg uuid "$VLESS_UUID" \
                --arg host "a.189.cn" \
                '{
                  log: {loglevel: "warning"},
                  inbounds: [
                    {
                      port: 10086,
                      listen: "127.0.0.1",
                      protocol: "vless",
                      settings: {clients: [{id: $uuid, level: 0}], decryption: "none"},
                      streamSettings: {network: "ws", wsSettings: {path: "/library1629"}}
                    },
                    {
                      port: 5443,
                      listen: "0.0.0.0",
                      protocol: "vless",
                      settings: {clients: [{id: $uuid, level: 0}], decryption: "none"},
                      streamSettings: {network: "ws", wsSettings: {path: "/", headers: {Host: $host}}}
                    }
                  ],
                  outbounds: [{protocol: "freedom"}]
                }')
              echo "âœ… é…ç½®åŒ…å«: Tunnel + Direct VLESS (æ—  TLS)"
            else
               # å•å…¥å£é…ç½® (ä»… Tunnel)
              XRAY_CONFIG=$(jq -n \
                --arg uuid "$VLESS_UUID" \
                '{
                  log: {loglevel: "warning"},
                  inbounds: [
                    {
                      port: 10086,
                      listen: "127.0.0.1",
                      protocol: "vless",
                      settings: {clients: [{id: $uuid, level: 0}], decryption: "none"},
                      streamSettings: {network: "ws", wsSettings: {path: "/library1629"}}
                    }
                  ],
                  outbounds: [{protocol: "freedom"}]
                }')
              echo "âœ… é…ç½®åŒ…å«: ä»… Tunnel"
            fi
            
            # ä½¿ç”¨ base64 ä¼ è¾“ JSON ä»¥é¿å…è½¬ä¹‰é—®é¢˜
            CONFIG_B64=$(echo "$XRAY_CONFIG" | base64 -w 0)
            sshpass -p "$SSH_PASSWORD" ssh $SSH_OPTS -n -p 2222 "${SSH_USERNAME}@127.0.0.1" "sudo mkdir -p /etc/xray && echo '$CONFIG_B64' | base64 -d | sudo tee /etc/xray/config.json > /dev/null" 2>&1 || true
            
            echo ">>> åˆ›å»º systemd æœåŠ¡..."
            SYSTEMD_SERVICE="W1VuaXRdCkRlc2NyaXB0aW9uPVhyYXkgVkxFU1MgU2VydmljZQpBZnRlcj1uZXR3b3JrLnRhcmdldAoKW1NlcnZpY2VdClR5cGU9c2ltcGxlCkV4ZWNTdGFydD0vdXNyL2xvY2FsL2Jpbi94cmF5IHJ1biAtY29uZmlnIC9ldGMveHJheS9jb25maWcuanNvbgpSZXN0YXJ0PW9uLWZhaWx1cmUKUmVzdGFydFNlYz0zCgpbSW5zdGFsbF0KV2FudGVkQnk9bXVsdGktdXNlci50YXJnZXQK"
            sshpass -p "$SSH_PASSWORD" ssh $SSH_OPTS -n -p 2222 "${SSH_USERNAME}@127.0.0.1" "echo '$SYSTEMD_SERVICE' | base64 -d | sudo tee /etc/systemd/system/xray-vless.service > /dev/null && sudo systemctl daemon-reload" 2>&1 || true
            
            echo ">>> å¯åŠ¨ Xray æœåŠ¡..."
            SERVICE_OK="no"
            for RETRY in 1 2 3; do
              echo ">>> å°è¯•å¯åŠ¨ (ç¬¬ $RETRY æ¬¡)..."
              sshpass -p "$SSH_PASSWORD" ssh $SSH_OPTS -n -p 2222 "${SSH_USERNAME}@127.0.0.1" "
                sudo systemctl stop xray-vless 2>/dev/null || true
                sudo systemctl enable xray-vless
                sudo systemctl start xray-vless
                sleep 2
                if sudo systemctl is-active xray-vless > /dev/null 2>&1; then
                  echo 'SERVICE_HEALTHY'
                else
                  echo 'SERVICE_FAILED'
                  sudo journalctl -u xray-vless --no-pager | tail -5
                fi
              " 2>&1 | tee /tmp/service_output.txt
              
              if grep -q "SERVICE_HEALTHY" /tmp/service_output.txt; then
                SERVICE_OK="yes"
                break
              fi
              sleep 3
            done
            
            if [ "$SERVICE_OK" = "yes" ]; then
              echo "âœ… éƒ¨ç½²æˆåŠŸ: $HOST_NAME"
              DEPLOYED_COUNT=$((DEPLOYED_COUNT + 1))
              
              # 1. Cloudflare Tunnel èŠ‚ç‚¹
              NODES_INFO="${NODES_INFO}vless://${VLESS_UUID}@${VLESS_HOST}:443?encryption=none&security=tls&sni=${VLESS_HOST}&type=ws&host=${VLESS_HOST}&path=%2Flibrary1629#${HOST_NAME}-Tunnel\n"
              
              # 2. ç›´è¿å…æµèŠ‚ç‚¹ (æ—  TLS)
              if [ "$PROXY_DOMAIN" != "null" ] && [ -n "$PROXY_DOMAIN" ]; then
                 NODES_DIRECT_INFO="${NODES_DIRECT_INFO}vless://${VLESS_UUID}@${PROXY_DOMAIN}:5443?encryption=none&security=none&type=ws&headerType=http&host=a.189.cn&path=%2F#${HOST_NAME}-ç›´è¿å…æµ\n"
              fi
            else
              echo "âŒ éƒ¨ç½²å¤±è´¥: $HOST_NAME"
            fi
            
            kill $TUNNEL_PID 2>/dev/null || true
          done
          
          echo ""
          echo "==========================================="
          echo "å®Œæˆ: æ–°éƒ¨ç½² $DEPLOYED_COUNT, è·³è¿‡ $SKIPPED_COUNT"
          echo "==========================================="
          
          echo -e "$NODES_INFO" > /tmp/nodes_info.txt
          echo -e "$NODES_DIRECT_INFO" > /tmp/nodes_direct_info.txt

      - name: Send Telegram notification
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          if [ -z "$TELEGRAM_BOT_TOKEN" ] || [ -z "$TELEGRAM_CHAT_ID" ]; then
            echo "âš ï¸ Telegram æœªé…ç½®"
            exit 0
          fi
          
          if [ ! -s /tmp/nodes_info.txt ]; then
            echo "âš ï¸ æ— èŠ‚ç‚¹ä¿¡æ¯"
            exit 0
          fi
          
          TIMESTAMP=$(date -u +'%Y-%m-%d %H:%M UTC')
          NODE_COUNT=$( (cat /tmp/nodes_info.txt | grep -v "^$" || true) | wc -l )
          
          # æ„å»º Telegram æ¶ˆæ¯å†…å®¹ (åˆ†æ æ˜¾ç¤º)
          NODES_FULL="ğŸ“‹ CF-Tunnel èŠ‚ç‚¹:"$'\n'
          NODES_FULL="${NODES_FULL}"'```'$'\n'
          NODES_FULL="${NODES_FULL}$( (cat /tmp/nodes_info.txt | grep -v "^$" || true) | head -20 )"
          NODES_FULL="${NODES_FULL}"$'\n''```'
          
          # åˆå¹¶æ˜¾ç¤ºç›´è¿èŠ‚ç‚¹ (å¦‚æœæœ‰)
          if [ -s /tmp/nodes_direct_info.txt ]; then
             DIRECT_COUNT=$( (cat /tmp/nodes_direct_info.txt | grep -v "^$" || true) | wc -l )
             
             NODES_FULL="${NODES_FULL}"$'\n\n'"ğŸ“‹ ç›´è¿å…æµèŠ‚ç‚¹:"$'\n'
             NODES_FULL="${NODES_FULL}"'```'$'\n'
             NODES_FULL="${NODES_FULL}$( (cat /tmp/nodes_direct_info.txt | grep -v "^$" || true) | head -20 )"
             NODES_FULL="${NODES_FULL}"$'\n''```'
             
             NODE_COUNT="$NODE_COUNT (Tunnel) + $DIRECT_COUNT (Direct)"
          fi
          
          FINAL_MSG=$(printf "ğŸ” *VLESS WS éƒ¨ç½²å®Œæˆ*\n\nğŸ“… %s\n\nâœ… *å…± %s ä¸ªèŠ‚ç‚¹*\n\n%s\n\nğŸ”— *è®¢é˜…åœ°å€:*\nCF-Tunnel\nhttps://v.555606.xyz/cf-2s1zhe9tq1f7f5i20lw2d243tyzts9.txt\n\nç›´è¿+å…æµ\nhttps://v.555606.xyz/ml-4nlsgmf2iazhegmhwozyohxlek8t3c.txt\n\nğŸ’¡ å¤åˆ¶ä¸Šæ–¹é“¾æ¥å¯¼å…¥å®¢æˆ·ç«¯å³å¯ä½¿ç”¨" "$TIMESTAMP" "$NODE_COUNT" "$NODES_FULL")
          
          # æ”¯æŒå¤šä¸ª chat_id (é€—å·åˆ†éš”)
          IFS=',' read -ra CHAT_IDS <<< "$TELEGRAM_CHAT_ID"
          for chat_id in "${CHAT_IDS[@]}"; do
            chat_id=$(echo "$chat_id" | xargs)
            if [ -n "$chat_id" ]; then
              curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
                -d chat_id="${chat_id}" \
                -d parse_mode="Markdown" \
                --data-urlencode "text=${FINAL_MSG}" > /dev/null
            fi
          done
          
          echo "âœ… Telegram å·²å‘é€"

      - name: Push to blog repository
        env:
          BLOG_GITHUB_TOKEN: ${{ secrets.BLOG_GITHUB_TOKEN }}
        run: |
          if [ -z "$BLOG_GITHUB_TOKEN" ]; then
            echo "âš ï¸ BLOG_GITHUB_TOKEN æœªé…ç½®"
            exit 0
          fi
          
          if [ ! -s /tmp/nodes_info.txt ]; then
            echo "âš ï¸ æ— èŠ‚ç‚¹ä¿¡æ¯"
            exit 0
          fi
          
          git clone "https://${BLOG_GITHUB_TOKEN}@github.com/suwei8/blog.git" /tmp/blog
          cd /tmp/blog
          
          TIMESTAMP=$(date -u +'%Y-%m-%d %H:%M UTC')
          
          # 1. Cloudflare Tunnel èŠ‚ç‚¹ (cf-2...)
          FILE_CF="cf-2s1zhe9tq1f7f5i20lw2d243tyzts9.txt"
          CONTENT_CF="# VLESS WS èŠ‚ç‚¹åˆ—è¡¨"$'\n'"# æ›´æ–°æ—¶é—´: $TIMESTAMP"$'\n\n'
          CONTENT_CF="${CONTENT_CF}$(cat /tmp/nodes_info.txt | grep -v "^$" || true)"
          
          echo -n "$CONTENT_CF" | base64 > "$FILE_CF"
          
          # 2. ç›´è¿å…æµèŠ‚ç‚¹ (ml-4...)
          FILE_ML="ml-4nlsgmf2iazhegmhwozyohxlek8t3c.txt"
          if [ -s /tmp/nodes_direct_info.txt ]; then
             CONTENT_ML="# ç›´è¿å…æµ VLESS èŠ‚ç‚¹åˆ—è¡¨"$'\n'"# æ›´æ–°æ—¶é—´: $TIMESTAMP"$'\n\n'
             CONTENT_ML="${CONTENT_ML}$(cat /tmp/nodes_direct_info.txt | grep -v "^$" || true)"
             
             echo -n "$CONTENT_ML" | base64 > "$FILE_ML"
             git add "$FILE_ML"
             echo "âœ… å·²ç”Ÿæˆç›´è¿è®¢é˜…æ–‡ä»¶"
          fi
          
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # æ¸…ç†æ—§æ–‡ä»¶ (å¦‚æœå­˜åœ¨)
          git rm --ignore-unmatch kphDl0SYZmghX7uxOxlLDnEiIOc3.txt cfml.txt 2>/dev/null || true
          
          git add "$FILE_CF"
          git diff --staged --quiet || git commit -m "Update VLESS nodes (Base64) $(date -u +%Y-%m-%d)"
          git push
          
          echo "âœ… å·²æ¨é€åˆ° blog ä»“åº“"
          
      - name: Summary
        run: |
          echo "## ğŸ” VLESS WS éƒ¨ç½²ç»“æœ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -s /tmp/nodes_info.txt ]; then
            echo "### âœ… èŠ‚ç‚¹åˆ—è¡¨" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            cat /tmp/nodes_info.txt | grep -v "^$" || true >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          else
            echo "æ— èŠ‚ç‚¹ä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
          fi
