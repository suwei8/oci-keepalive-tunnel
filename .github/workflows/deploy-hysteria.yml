name: Deploy Hysteria v2

on:
  workflow_dispatch:
    inputs:
      force_redeploy:
        description: 'å¼ºåˆ¶é‡æ–°éƒ¨ç½² (å³ä½¿å®¹å™¨å·²å­˜åœ¨)'
        required: false
        default: 'false'
        type: choice
        options:
          - 'false'
          - 'true'
      target_host:
        description: 'æŒ‡å®šéƒ¨ç½²ä¸»æœº (ç•™ç©º=å…¨éƒ¨)'
        required: false
        default: ''

jobs:
  deploy:
    name: "Deploy Hysteria"
    runs-on: ubuntu-latest
    timeout-minutes: 60
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install cloudflared
        run: |
          sudo cp bin/cloudflared /usr/local/bin/cloudflared
          cloudflared --version

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          cat >> ~/.ssh/config << 'EOF'
          Host *
            StrictHostKeyChecking no
            UserKnownHostsFile /dev/null
            LogLevel ERROR
          EOF
          sudo apt-get update -qq && sudo apt-get install -y -qq sshpass jq

      - name: Deploy to all hosts
        id: deploy
        env:
          PROXY_HOSTS_CONFIG: ${{ secrets.PROXY_HOSTS_CONFIG }}
          SSH_USERNAME: ${{ secrets.SSH_USERNAME }}
          SSH_PASSWORD: ${{ secrets.SSH_PASSWORD }}
          CF_API_EMAIL: ${{ secrets.CF_API_EMAIL }}
          CF_API_KEY: ${{ secrets.CF_API_KEY }}
          CF_ZONE_ID: ${{ secrets.CF_ZONE_ID }}
          HYSTERIA_PASSWORD: ${{ secrets.HYSTERIA_PASSWORD }}
          FORCE_REDEPLOY: ${{ github.event.inputs.force_redeploy }}
          TARGET_HOST: ${{ github.event.inputs.target_host }}
        run: |
          SSH_OPTS="-o ConnectTimeout=30 -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR -o ServerAliveInterval=30"
          
          # æ”¶é›†æ‰€æœ‰èŠ‚ç‚¹ä¿¡æ¯
          NODES_INFO=""
          DEPLOYED_COUNT=0
          SKIPPED_COUNT=0
          
          # èŽ·å–ä¸»æœºæ€»æ•°
          HOST_COUNT=$(echo "$PROXY_HOSTS_CONFIG" | jq '. | length')
          echo "Total hosts: $HOST_COUNT"
          
          for INDEX in $(seq 0 $((HOST_COUNT - 1))); do
            # èŽ·å–å½“å‰ä¸»æœºé…ç½®
            host_item=$(echo "$PROXY_HOSTS_CONFIG" | jq -c ".[$INDEX]")
            HOST_NAME=$(echo "$host_item" | jq -r '.name')
            SSH_HOST=$(echo "$host_item" | jq -r '.ssh_host')
            PROXY_DOMAIN=$(echo "$host_item" | jq -r '.proxy_domains')
            
            if [ "$HOST_NAME" = "null" ] || [ -z "$HOST_NAME" ]; then
              continue
            fi
            
            # æ£€æŸ¥æ˜¯å¦æŒ‡å®šäº†ç›®æ ‡ä¸»æœº
            if [ -n "$TARGET_HOST" ] && [ "$HOST_NAME" != "$TARGET_HOST" ]; then
              echo ">>> è·³è¿‡ $HOST_NAME (éžç›®æ ‡ä¸»æœº)"
              continue
            fi
            
            echo ""
            echo "==========================================="
            echo "Processing: $HOST_NAME"
            echo "SSH Host: $SSH_HOST"
            echo "Proxy Domain: $PROXY_DOMAIN"
            echo "==========================================="
            
            # å»ºç«‹ Cloudflare Tunnel
            pkill -f "cloudflared.*2222" 2>/dev/null || true
            sleep 2
            cloudflared access ssh --hostname "$SSH_HOST" --url "ssh://127.0.0.1:2222" &
            TUNNEL_PID=$!
            sleep 5
            
            if ! kill -0 $TUNNEL_PID 2>/dev/null; then
              echo "âŒ Tunnel è¿žæŽ¥å¤±è´¥: $HOST_NAME"
              continue
            fi
            echo "âœ… Tunnel å·²å»ºç«‹"
            
            # æ£€æŸ¥å®¹å™¨æ˜¯å¦å·²å­˜åœ¨
            CONTAINER_EXISTS=$(sshpass -p "$SSH_PASSWORD" ssh $SSH_OPTS -n -p 2222 "${SSH_USERNAME}@127.0.0.1" \
              'docker ps -a --format "{{.Names}}" | grep -q "^hysteria-server$" && echo "yes" || echo "no"' 2>&1) || true
            
            if [ "$CONTAINER_EXISTS" = "yes" ] && [ "$FORCE_REDEPLOY" != "true" ]; then
              echo "â­ï¸ å®¹å™¨å·²å­˜åœ¨ï¼Œè·³è¿‡éƒ¨ç½²: $HOST_NAME"
              SKIPPED_COUNT=$((SKIPPED_COUNT + 1))
              # æ·»åŠ åˆ°èŠ‚ç‚¹åˆ—è¡¨
              NODES_INFO="${NODES_INFO}hysteria2://${HYSTERIA_PASSWORD}@${PROXY_DOMAIN}:2443?insecure=0&sni=${PROXY_DOMAIN}#${HOST_NAME}\n"
              kill $TUNNEL_PID 2>/dev/null || true
              continue
            fi
            
            echo ">>> å¼€å§‹éƒ¨ç½²..."
            
            # 1. èŽ·å–å®žä¾‹å…¬ç½‘ IP
            PUBLIC_IP=$(sshpass -p "$SSH_PASSWORD" ssh $SSH_OPTS -n -p 2222 "${SSH_USERNAME}@127.0.0.1" \
              'curl -4 -s ip.sb' 2>&1) || true
            
            if [ -z "$PUBLIC_IP" ]; then
              echo "âŒ æ— æ³•èŽ·å–å…¬ç½‘ IP"
              kill $TUNNEL_PID 2>/dev/null || true
              continue
            fi
            echo "âœ… å…¬ç½‘ IP: $PUBLIC_IP"
            
            # 2. æ£€æŸ¥å¹¶é…ç½® DNS
            echo ">>> æ£€æŸ¥ DNS è§£æž..."
            DNS_RECORD=$(curl -s "https://api.cloudflare.com/client/v4/zones/${CF_ZONE_ID}/dns_records?name=${PROXY_DOMAIN}" \
              -H "X-Auth-Email: ${CF_API_EMAIL}" \
              -H "X-Auth-Key: ${CF_API_KEY}" | jq -r '.result[0].content // empty')
            
            if [ -z "$DNS_RECORD" ]; then
              echo ">>> åˆ›å»º DNS è®°å½•: $PROXY_DOMAIN -> $PUBLIC_IP"
              curl -s -X POST "https://api.cloudflare.com/client/v4/zones/${CF_ZONE_ID}/dns_records" \
                -H "X-Auth-Email: ${CF_API_EMAIL}" \
                -H "X-Auth-Key: ${CF_API_KEY}" \
                -H "Content-Type: application/json" \
                -d "{\"type\":\"A\",\"name\":\"${PROXY_DOMAIN}\",\"content\":\"${PUBLIC_IP}\",\"proxied\":false,\"ttl\":1}" > /dev/null
              echo "âœ… DNS è®°å½•å·²åˆ›å»º"
            elif [ "$DNS_RECORD" != "$PUBLIC_IP" ]; then
              echo ">>> æ›´æ–° DNS è®°å½•: $PROXY_DOMAIN -> $PUBLIC_IP (åŽŸ: $DNS_RECORD)"
              RECORD_ID=$(curl -s "https://api.cloudflare.com/client/v4/zones/${CF_ZONE_ID}/dns_records?name=${PROXY_DOMAIN}" \
                -H "X-Auth-Email: ${CF_API_EMAIL}" \
                -H "X-Auth-Key: ${CF_API_KEY}" | jq -r '.result[0].id')
              curl -s -X PUT "https://api.cloudflare.com/client/v4/zones/${CF_ZONE_ID}/dns_records/${RECORD_ID}" \
                -H "X-Auth-Email: ${CF_API_EMAIL}" \
                -H "X-Auth-Key: ${CF_API_KEY}" \
                -H "Content-Type: application/json" \
                -d "{\"type\":\"A\",\"name\":\"${PROXY_DOMAIN}\",\"content\":\"${PUBLIC_IP}\",\"proxied\":false,\"ttl\":1}" > /dev/null
              echo "âœ… DNS è®°å½•å·²æ›´æ–°"
            else
              echo "âœ… DNS è®°å½•æ­£ç¡®: $PROXY_DOMAIN -> $PUBLIC_IP"
            fi
            
            # ç­‰å¾… DNS ç”Ÿæ•ˆ
            sleep 5
            
            # 3. æ£€æŸ¥å¹¶ç”³è¯· SSL è¯ä¹¦
            echo ">>> æ£€æŸ¥ SSL è¯ä¹¦..."
            CERT_EXISTS=$(sshpass -p "$SSH_PASSWORD" ssh $SSH_OPTS -n -p 2222 "${SSH_USERNAME}@127.0.0.1" \
              "test -f /etc/letsencrypt/live/${PROXY_DOMAIN}/fullchain.pem && echo 'yes' || echo 'no'" 2>&1) || true
            
            if [ "$CERT_EXISTS" != "yes" ]; then
              echo ">>> ç”³è¯· SSL è¯ä¹¦..."
              sshpass -p "$SSH_PASSWORD" ssh $SSH_OPTS -n -p 2222 "${SSH_USERNAME}@127.0.0.1" "
                # å®‰è£… certbot
                which certbot > /dev/null 2>&1 || (sudo apt-get update -qq && sudo apt-get install -y -qq certbot)
                
                # ä¸´æ—¶åœæ­¢å ç”¨ 80 ç«¯å£çš„æœåŠ¡
                sudo systemctl stop nginx 2>/dev/null || true
                sudo docker stop hysteria-server 2>/dev/null || true
                
                # ç”³è¯·è¯ä¹¦
                sudo certbot certonly --standalone -d ${PROXY_DOMAIN} \
                  --non-interactive --agree-tos --email ${CF_API_EMAIL} \
                  --http-01-port 80 || echo 'Certbot failed'
                
                # é‡å¯æœåŠ¡
                sudo systemctl start nginx 2>/dev/null || true
              " 2>&1 || true
              echo "âœ… SSL è¯ä¹¦ç”³è¯·å®Œæˆ"
            else
              echo "âœ… SSL è¯ä¹¦å·²å­˜åœ¨"
            fi
            
            # 4. åˆ›å»ºé…ç½®ç›®å½•å’Œæ–‡ä»¶
            echo ">>> åˆ›å»ºé…ç½®æ–‡ä»¶..."
            sshpass -p "$SSH_PASSWORD" ssh $SSH_OPTS -n -p 2222 "${SSH_USERNAME}@127.0.0.1" "
              # åˆ›å»ºç›®å½•
              mkdir -p /home/sw/docker_root/hy
              
              # åˆ›å»º docker-compose.yml
              cat > /home/sw/docker_root/hy/docker-compose.yml << 'COMPOSE_EOF'
services:
  hysteria:
    image: tobyxdd/hysteria:latest
    container_name: hysteria-server
    restart: always
    network_mode: \"host\"
    volumes:
      - ./hy.yaml:/etc/hysteria/hysteria.yaml
      - /etc/letsencrypt:/etc/letsencrypt
    environment:
      - TZ=Asia/Jakarta
      - HYSTERIA_DISABLE_UPDATE_CHECK=1
      - HYSTERIA_LOG_LEVEL=info
    cap_add:
      - NET_ADMIN
      - NET_BIND_SERVICE
    devices:
      - /dev/net/tun:/dev/net/tun
    command: [\"server\", \"-c\", \"/etc/hysteria/hysteria.yaml\"]
COMPOSE_EOF
              
              # åˆ›å»º hy.yaml
              cat > /home/sw/docker_root/hy/hy.yaml << HY_EOF
listen: :2443

tls:
  cert: /etc/letsencrypt/live/${PROXY_DOMAIN}/fullchain.pem
  key: /etc/letsencrypt/live/${PROXY_DOMAIN}/privkey.pem

auth:
  type: password
  password: \"${HYSTERIA_PASSWORD}\"

disableUDP: false

bandwidth:
  up: 1000 mbps
  down: 1000 mbps

masquerade:
  type: proxy
  proxy:
    url: https://www.kernel.org/
    rewriteHost: true

resolver:
  type: udp
  udp:
    addr: 1.1.1.1:53
    timeout: 4s
HY_EOF
            " 2>&1 || true
            echo "âœ… é…ç½®æ–‡ä»¶å·²åˆ›å»º"
            
            # 5. å¯åŠ¨ Docker å®¹å™¨
            echo ">>> å¯åŠ¨ Hysteria å®¹å™¨..."
            sshpass -p "$SSH_PASSWORD" ssh $SSH_OPTS -n -p 2222 "${SSH_USERNAME}@127.0.0.1" "
              cd /home/sw/docker_root/hy
              
              # åœæ­¢æ—§å®¹å™¨
              docker compose down 2>/dev/null || docker-compose down 2>/dev/null || true
              
              # æ‹‰å–æœ€æ–°é•œåƒå¹¶å¯åŠ¨
              docker compose pull 2>/dev/null || docker-compose pull 2>/dev/null || true
              docker compose up -d 2>/dev/null || docker-compose up -d 2>/dev/null
              
              # ç­‰å¾…å¯åŠ¨
              sleep 3
              
              # æ£€æŸ¥çŠ¶æ€
              docker ps | grep hysteria-server
            " 2>&1 || true
            
            # éªŒè¯å®¹å™¨æ˜¯å¦å¯åŠ¨æˆåŠŸ
            CONTAINER_RUNNING=$(sshpass -p "$SSH_PASSWORD" ssh $SSH_OPTS -n -p 2222 "${SSH_USERNAME}@127.0.0.1" \
              'docker ps --format "{{.Names}}" | grep -q "^hysteria-server$" && echo "yes" || echo "no"' 2>&1) || true
            
            if [ "$CONTAINER_RUNNING" = "yes" ]; then
              echo "âœ… Hysteria éƒ¨ç½²æˆåŠŸ: $HOST_NAME"
              DEPLOYED_COUNT=$((DEPLOYED_COUNT + 1))
              # æ·»åŠ åˆ°èŠ‚ç‚¹åˆ—è¡¨
              NODES_INFO="${NODES_INFO}hysteria2://${HYSTERIA_PASSWORD}@${PROXY_DOMAIN}:2443?insecure=0&sni=${PROXY_DOMAIN}#${HOST_NAME}\n"
            else
              echo "âŒ Hysteria å¯åŠ¨å¤±è´¥: $HOST_NAME"
            fi
            
            # æ¸…ç† Tunnel
            kill $TUNNEL_PID 2>/dev/null || true
            
          done
          
          echo ""
          echo "==========================================="
          echo "éƒ¨ç½²å®Œæˆ: æˆåŠŸ $DEPLOYED_COUNT, è·³è¿‡ $SKIPPED_COUNT"
          echo "==========================================="
          
          # ä¿å­˜èŠ‚ç‚¹ä¿¡æ¯åˆ°æ–‡ä»¶
          echo -e "$NODES_INFO" > /tmp/nodes_info.txt
          echo "deployed_count=$DEPLOYED_COUNT" >> $GITHUB_OUTPUT
          echo "skipped_count=$SKIPPED_COUNT" >> $GITHUB_OUTPUT

      - name: Send Telegram notification
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          if [ -z "$TELEGRAM_BOT_TOKEN" ] || [ -z "$TELEGRAM_CHAT_ID" ]; then
            echo "âš ï¸ Telegram æœªé…ç½®ï¼Œè·³è¿‡é€šçŸ¥"
            exit 0
          fi
          
          if [ ! -f /tmp/nodes_info.txt ]; then
            echo "âš ï¸ æ— èŠ‚ç‚¹ä¿¡æ¯"
            exit 0
          fi
          
          # æž„å»ºæ¶ˆæ¯
          NODES_LIST=$(cat /tmp/nodes_info.txt | grep -v "^$" | awk -F'#' '{print NR". "$2": "$1}' | head -20)
          TIMESTAMP=$(date -u +'%Y-%m-%d %H:%M UTC')
          
          FINAL_MSG=$(printf "ðŸš€ *Hysteria v2 éƒ¨ç½²å®Œæˆ*\n\nðŸ“… %s\n\nâœ… *èŠ‚ç‚¹åˆ—è¡¨:*\n\`\`\`\n%s\n\`\`\`\n\nðŸ“‹ å®¢æˆ·ç«¯é…ç½®å·²æ›´æ–°åˆ°:\nhttps://github.com/suwei8/blog/blob/main/hy2.txt" "$TIMESTAMP" "$NODES_LIST")
          
          curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
            -d chat_id="${TELEGRAM_CHAT_ID}" \
            -d parse_mode="Markdown" \
            --data-urlencode "text=${FINAL_MSG}" > /dev/null
          
          echo "âœ… Telegram é€šçŸ¥å·²å‘é€"

      - name: Push to blog repository
        env:
          BLOG_GITHUB_TOKEN: ${{ secrets.BLOG_GITHUB_TOKEN }}
        run: |
          if [ -z "$BLOG_GITHUB_TOKEN" ]; then
            echo "âš ï¸ BLOG_GITHUB_TOKEN æœªé…ç½®ï¼Œè·³è¿‡æŽ¨é€"
            exit 0
          fi
          
          if [ ! -f /tmp/nodes_info.txt ]; then
            echo "âš ï¸ æ— èŠ‚ç‚¹ä¿¡æ¯"
            exit 0
          fi
          
          # å…‹éš† blog ä»“åº“
          git clone "https://${BLOG_GITHUB_TOKEN}@github.com/suwei8/blog.git" /tmp/blog
          cd /tmp/blog
          
          # åˆ›å»º hy2.txt
          TIMESTAMP=$(date -u +'%Y-%m-%d %H:%M UTC')
          cat > hy2.txt << EOF
# Hysteria v2 èŠ‚ç‚¹åˆ—è¡¨
# æ›´æ–°æ—¶é—´: $TIMESTAMP
# ä½¿ç”¨æ–¹æ³•: å¯¼å…¥åˆ° Clash/v2rayN/NekoBox ç­‰å®¢æˆ·ç«¯

EOF
          cat /tmp/nodes_info.txt | grep -v "^$" >> hy2.txt
          
          # æäº¤å¹¶æŽ¨é€
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add hy2.txt
          git diff --staged --quiet || git commit -m "Update Hysteria v2 nodes $(date -u +%Y-%m-%d)"
          git push
          
          echo "âœ… å·²æŽ¨é€åˆ° blog ä»“åº“"

      - name: Summary
        run: |
          echo "## ðŸš€ Hysteria v2 éƒ¨ç½²ç»“æžœ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -f /tmp/nodes_info.txt ]; then
            echo "### âœ… èŠ‚ç‚¹åˆ—è¡¨" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            cat /tmp/nodes_info.txt | grep -v "^$" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          else
            echo "æ— èŠ‚ç‚¹ä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
          fi
