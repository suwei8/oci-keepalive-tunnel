name: Export HOSTS_CONFIG

on:
  workflow_dispatch:

jobs:
  export-config:
    name: "Export HOSTS_CONFIG to blog"
    runs-on: ubuntu-latest
    timeout-minutes: 5
    
    steps:
      - name: Export configs
        env:
          HOSTS_CONFIG: ${{ secrets.HOSTS_CONFIG }}
          BLOG_GITHUB_TOKEN: ${{ secrets.BLOG_GITHUB_TOKEN }}
          BLOG_REPO_URL: ${{ secrets.BLOG_REPO_URL }}
        run: |
          if [ -z "$BLOG_GITHUB_TOKEN" ]; then
            echo "❌ BLOG_GITHUB_TOKEN 未配置"
            exit 1
          fi
          
          # Inject token into URL if not already present
          if [[ "$BLOG_REPO_URL" != *"@"* ]]; then
             # Remove https:// prefix to inject token
             CLEAN_URL="${BLOG_REPO_URL#https://}"
             FINAL_URL="https://${BLOG_GITHUB_TOKEN}@${CLEAN_URL}"
          else
             FINAL_URL="$BLOG_REPO_URL"
          fi
          
          # Clone blog 仓库
          git clone "$FINAL_URL" /tmp/blog
          cd /tmp/blog
          
          # 保存 HOSTS_CONFIG
          if [ -n "$HOSTS_CONFIG" ]; then
            echo "$HOSTS_CONFIG" > HOSTS_CONFIG.txt
            echo "✅ HOSTS_CONFIG 已保存"
          else
            echo "⚠️ HOSTS_CONFIG 未配置"
          fi
          
          # 配置 git
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # 提交
          git add HOSTS_CONFIG.txt 2>/dev/null || true
          if git diff --staged --quiet; then
            echo "⚠️ 无变化"
          else
            git commit -m "Export configs - $(date -u +'%Y-%m-%d %H:%M UTC')"
            git push
            echo "✅ 已推送到 blog 仓库"
          fi

