name: OCI Keepalive via Tunnel (AMD64)

on:
  schedule:
    - cron: "0 */6 * * *"
  workflow_dispatch:
    inputs:
      target_index:
        description: 'Target Host Index (0-29)'
        required: false
        default: ''

concurrency:
  group: keepalive-amd64
  cancel-in-progress: true

jobs:
  keepalive-matrix:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    strategy:
      fail-fast: false
      max-parallel: 3
      matrix: 
        host_id: [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29]

    steps:
      - name: Check Host Configuration
        id: host
        env:
          HOSTS_CONFIG_URL: ${{ secrets.HOSTS_CONFIG_URL }}
          TARGET_INDEX: ${{ inputs.target_index }}
          CURRENT_INDEX: ${{ matrix.host_id }}
        run: |
          # èŽ·å–é…ç½®
          HOSTS_CONFIG=$(curl -s $HOSTS_CONFIG_URL) || true
          
          # æå–ä¸»æœºä¿¡æ¯
          HOST_INFO=$(echo $HOSTS_CONFIG | jq -r --argjson idx $CURRENT_INDEX '.[$idx]')

          # æ£€æŸ¥æ˜¯å¦å­˜åœ¨
          if [ "$HOST_INFO" == "null" ] || [ -z "$HOST_INFO" ]; then
            echo "skip=true" >> $GITHUB_OUTPUT
            echo "No host config at index $CURRENT_INDEX"
            exit 0
          fi

          # æ£€æŸ¥æ˜¯å¦ä¸º AMD64
          CPU_TYPE=$(echo "$HOST_INFO" | jq -r '.cpu_type')
          if [ "${CPU_TYPE,,}" != "amd64" ]; then
            echo "skip=true" >> $GITHUB_OUTPUT
            echo "Skipping non-AMD64 host (Type: $CPU_TYPE) at index $CURRENT_INDEX"
            exit 0
          fi

          # æ£€æŸ¥æ˜¯å¦æŒ‡å®šäº† Target Index
          if [ -n "$TARGET_INDEX" ] && [ "$TARGET_INDEX" != "$CURRENT_INDEX" ]; then
            echo "skip=true" >> $GITHUB_OUTPUT
            echo "Skipping index $CURRENT_INDEX (Target is $TARGET_INDEX)"
            exit 0
          fi

          echo "skip=false" >> $GITHUB_OUTPUT
          echo "Found AMD64 host at index $CURRENT_INDEX"


      - name: Checkout
        if: steps.host.outputs.skip != 'true'
        uses: actions/checkout@v4

      - name: Set Random Delay
        if: steps.host.outputs.skip != 'true'
        run: |
          # AMD64 å®žä¾‹è¾ƒå°‘ï¼Œå‡å°‘å»¶è¿Ÿä»¥æé«˜æ•ˆçŽ‡
          DELAY=$((RANDOM % 120 + 30))
          echo "Sleeping for ${DELAY} seconds..."
          sleep $DELAY

      - name: Install Dependencies
        if: steps.host.outputs.skip != 'true'
        run: |
          sudo apt-get update
          sudo apt-get install -y sshpass jq unzip
          
          # Install cloudflared from local bin
          sudo cp bin/cloudflared /usr/local/bin/cloudflared
          sudo chmod +x /usr/local/bin/cloudflared
          cloudflared --version
          
      - name: Setup SSH
        if: steps.host.outputs.skip != 'true'
        run: |
          mkdir -p ~/.ssh
          echo "StrictHostKeyChecking no" > ~/.ssh/config
          
      - name: Run Keepalive (Tunnel Mode)
        env:
          HOSTS_CONFIG_URL: ${{ secrets.HOSTS_CONFIG_URL }}
          AMD_SSH_USERNAME: ${{ secrets.AMD_SSH_USERNAME }}
          SSH_PASSWORD: ${{ secrets.SSH_PASSWORD }}
          CURRENT_INDEX: ${{ matrix.host_id }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO_OWNER: ${{ github.repository_owner }}
          REPO_NAME: ${{ github.event.repository.name }}
        if: steps.host.outputs.skip != 'true'
        run: |
          # èŽ·å–é…ç½®
          HOSTS_CONFIG=$(curl -s $HOSTS_CONFIG_URL) || true
          
          # è§£æžé…ç½®
          # No decoding needed for static matrix
          HOST_INFO=$(echo $HOSTS_CONFIG | jq -r --argjson idx $CURRENT_INDEX '.[$idx]')
          
          if [ "$HOST_INFO" == "null" ]; then
            echo "Host config not found for index $CURRENT_INDEX"
            exit 0
          fi

          NAME=$(echo $HOST_INFO | jq -r '.name')
          SSH_HOST=$(echo $HOST_INFO | jq -r '.ssh_host')
          # CPU_TYPE å·²åœ¨ define-matrix é˜¶æ®µè¿‡æ»¤ï¼Œæ­¤å¤„æ— éœ€å†æ¬¡æ£€æŸ¥
          
          echo "=========================================="
          echo "ðŸš€ Starting Keepalive for $NAME ($SSH_HOST) [AMD64]"
          echo "=========================================="
          
          # å»ºç«‹ Tunnel
          echo "Creating Cloudflare Tunnel..."
          cloudflared access tcp --hostname $SSH_HOST --url tcp://localhost:2222 > /dev/null 2>&1 &
          TUNNEL_PID=$!
          sleep 5
          
          # å‡†å¤‡è„šæœ¬
          cat > setup_env.sh << 'EOF'
          export LC_ALL=C.UTF-8
          export LANG=C.UTF-8
          # æ£€æŸ¥ python3 å’Œ unzip
          if ! command -v python3 &> /dev/null || ! command -v unzip &> /dev/null; then
              echo "Installing Dependencies..."
              if command -v apt-get &> /dev/null; then
                  sudo apt-get update && sudo apt-get install -y python3 python3-pip unzip
              elif command -v yum &> /dev/null; then
                  sudo yum install -y python3 unzip
              fi
          fi
          EOF
          
          # å‘é€å¹¶æ‰§è¡Œè„šæœ¬
          # æ³¨æ„ï¼šAMD64 å®žä¾‹å¼ºåˆ¶ä½¿ç”¨ AMD_SSH_USERNAME (é€šå¸¸ä¸º root)
          USER_NAME="${AMD_SSH_USERNAME:-root}"
          echo "Using SSH User: $USER_NAME"
          
          echo "Copying scripts to $NAME..."
          sshpass -p "$SSH_PASSWORD" scp -P 2222 -o UserKnownHostsFile=/dev/null -o StrictHostKeyChecking=no scripts/remote_keepalive.py $USER_NAME@localhost:~/
          
          echo "Executing remote keepalive..."
          # ä¼ é€’ GITHUB_TOKEN ç»™è¿œç¨‹è„šæœ¬
          sshpass -p "$SSH_PASSWORD" ssh -vvv -o PreferredAuthentications=password -o PubkeyAuthentication=no -p 2222 -o UserKnownHostsFile=/dev/null -o StrictHostKeyChecking=no $USER_NAME@localhost \
              "export GITHUB_TOKEN='$GITHUB_TOKEN' && \
               export REPO_OWNER='$REPO_OWNER' && \
               export REPO_NAME='$REPO_NAME' && \
               python3 ~/remote_keepalive.py --hostname '$NAME'"
          
          # å›žä¼ é¢„æµ‹ç»“æžœ
          echo ">>> Retrieve Prediction Result..."
          mkdir -p predictions
          SAFE_NAME=$(echo "$NAME" | tr ' ' '_')
          
          sshpass -p "$SSH_PASSWORD" ssh -vvv -o PreferredAuthentications=password -o PubkeyAuthentication=no -p 2222 -o UserKnownHostsFile=/dev/null -o StrictHostKeyChecking=no $USER_NAME@localhost \
              "ls -lh /tmp/prediction_result.json && echo 'File exists' || echo 'âŒ Remote file missing'"
          
          sshpass -p "$SSH_PASSWORD" scp -P 2222 -o UserKnownHostsFile=/dev/null -o StrictHostKeyChecking=no \
             "$USER_NAME@localhost:/tmp/prediction_result.json" \
             "predictions/${SAFE_NAME}.json" && echo "âœ… Retrieved ${SAFE_NAME}.json" || echo "âŒ SCP Failed"

          # æ¸…ç† Tunnel
          kill $TUNNEL_PID

      - name: Upload prediction artifact
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: prediction-${{ matrix.host_id }}
          path: predictions/*.json
          if-no-files-found: ignore
          retention-days: 1

  # æ”¶é›†æ‰€æœ‰é¢„æµ‹ç»“æžœ
  collect:
    name: Collect Predictions
    needs: keepalive-matrix
    if: always()
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download all prediction artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          pattern: prediction-*
        continue-on-error: true

      - name: Merge predictions to CSV
        run: |
          CSV_FILE="predictions/predictions.csv"
          mkdir -p predictions
          
          if [ ! -f "$CSV_FILE" ]; then
            echo "timestamp,hostname,issue,d1,d2,d3,model_type" > "$CSV_FILE"
          fi
          
          if [ -d artifacts ]; then
            find artifacts -name "*.json" -type f | while read json_file; do
              if [ -f "$json_file" ]; then
                timestamp=$(jq -r '.timestamp' "$json_file")
                hostname=$(jq -r '.hostname' "$json_file")
                issue=$(jq -r '.issue' "$json_file")
                d1=$(jq -r '.d1' "$json_file")
                d2=$(jq -r '.d2' "$json_file")
                d3=$(jq -r '.d3' "$json_file")
                model_type=$(jq -r '.model_type' "$json_file")
                echo "${timestamp},${hostname},${issue},${d1},${d2},${d3},${model_type}" >> "$CSV_FILE"
                echo "Added: $hostname -> $d1 $d2 $d3"
              fi
            done
          fi
          
          if [ -f "$CSV_FILE" ] && [ $(wc -l < "$CSV_FILE") -gt 1 ]; then
            head -1 "$CSV_FILE" > /tmp/csv_header.tmp
            tail -n +2 "$CSV_FILE" | sort -t',' -k1 -r > /tmp/csv_body.tmp
            cat /tmp/csv_header.tmp /tmp/csv_body.tmp > "$CSV_FILE"
            rm -f /tmp/csv_header.tmp /tmp/csv_body.tmp
          fi

      - name: Upload merged predictions
        uses: actions/upload-artifact@v4
        with:
          name: predictions-csv
          path: predictions/predictions.csv
          if-no-files-found: warn

      - name: Commit predictions
        run: |
          if [ -f predictions/predictions.csv ]; then
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git add predictions/predictions.csv
            git diff --staged --quiet || git commit -m "Update predictions $(date -u +%Y-%m-%d)"
            git pull --rebase
            git push
          fi
