name: OCI Keepalive via Tunnel (AMD64)

on:
  schedule:
    - cron: "*/45 * * * *"
  workflow_dispatch:
    inputs:
        target_index:
            description: 'Target Host Index (0-29)'
            required: false
            default: ''

concurrency:
  group: keepalive-amd64
  cancel-in-progress: true

jobs:
  define-matrix:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - name: Filter AMD64 Hosts
        id: set-matrix
        env:
          HOSTS_CONFIG: ${{ secrets.HOSTS_CONFIG }}
          TARGET_INDEX: ${{ inputs.target_index }}
        run: |
          python3 -c '
          import os, json
          
          try:
              config_str = os.environ.get("HOSTS_CONFIG", "[]")
              target_index_str = os.environ.get("TARGET_INDEX", "")
              hosts = json.loads(config_str)
              
              indices = []
              
              if target_index_str:
                  idx = int(target_index_str)
                  if 0 <= idx < len(hosts) and hosts[idx].get("cpu_type") == "amd64":
                      print(f"Target {idx} is AMD64. Proceeding.")
                      indices = [idx]
                  else:
                      print(f"Target {idx} is not AMD64 or out of range. Skipping.")
              else:
                  # Filter all AMD64
                  indices = [i for i, h in enumerate(hosts) if h.get("cpu_type") == "amd64"]
                  print(f"Found AMD64 indices: {indices}")
              
              json_output = json.dumps({"host_id": indices})
              with open(os.environ["GITHUB_OUTPUT"], "a") as f:
                  f.write(f"matrix={json_output}\n")
                  
          except Exception as e:
              print(f"Error parsing config: {e}")
              # Default to empty to prevent workflow error
              with open(os.environ["GITHUB_OUTPUT"], "a") as f:
                  f.write("matrix={\"host_id\": []}\n")
          '

  keepalive-matrix:
    needs: define-matrix
    # Â¶ÇÊûúÂàóË°®‰∏∫Á©∫Ôºà‰æãÂ¶ÇÊ≤°Êúâ amd64 ÂÆû‰æãÔºâÔºåË∑≥ËøáÊâßË°å
    if: ${{ fromJson(needs.define-matrix.outputs.matrix).host_id[0] != null }}
    runs-on: ubuntu-latest
    permissions:
      contents: write
    strategy:
      fail-fast: false
      max-parallel: 3
      matrix: ${{ fromJson(needs.define-matrix.outputs.matrix) }}

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Set Random Delay
      run: |
        # AMD64 ÂÆû‰æãËæÉÂ∞ëÔºåÂáèÂ∞ëÂª∂Ëøü‰ª•ÊèêÈ´òÊïàÁéá
        DELAY=$((RANDOM % 120 + 30))
        echo "Sleeping for ${DELAY} seconds..."
        sleep $DELAY

    - name: Install Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y sshpass jq unzip
        
        # Install cloudflared from local bin
        sudo cp bin/cloudflared /usr/local/bin/cloudflared
        sudo chmod +x /usr/local/bin/cloudflared
        cloudflared --version
        
    - name: Setup SSH
      run: |
        mkdir -p ~/.ssh
        echo "StrictHostKeyChecking no" > ~/.ssh/config
        
    - name: Run Keepalive (Tunnel Mode)
      env:
        HOSTS_CONFIG: ${{ secrets.HOSTS_CONFIG }}
        SSH_KEY: ${{ secrets.SSH_KEY }}
        AMD_SSH_USERNAME: ${{ secrets.AMD_SSH_USERNAME }}
        SSH_PASSWORD: ${{ secrets.SSH_PASSWORD }}
        CURRENT_INDEX: ${{ matrix.host_id }}
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        REPO_OWNER: ${{ github.repository_owner }}
        REPO_NAME: ${{ github.event.repository.name }}
      run: |
        # Ëß£ÊûêÈÖçÁΩÆ
        HOST_INFO=$(echo $HOSTS_CONFIG | jq -r --argjson idx $CURRENT_INDEX '.[$idx]')
        
        if [ "$HOST_INFO" == "null" ]; then
          echo "Host config not found for index $CURRENT_INDEX"
          exit 0
        fi

        NAME=$(echo $HOST_INFO | jq -r '.name')
        SSH_HOST=$(echo $HOST_INFO | jq -r '.ssh_host')
        # CPU_TYPE Â∑≤Âú® define-matrix Èò∂ÊÆµËøáÊª§ÔºåÊ≠§Â§ÑÊó†ÈúÄÂÜçÊ¨°Ê£ÄÊü•
        
        echo "=========================================="
        echo "üöÄ Starting Keepalive for $NAME ($SSH_HOST) [AMD64]"
        echo "=========================================="
        
        # Âª∫Á´ã Tunnel
        echo "Creating Cloudflare Tunnel..."
        cloudflared access tcp --hostname $SSH_HOST --url tcp://localhost:2222 > /dev/null 2>&1 &
        TUNNEL_PID=$!
        sleep 5
        
        # ÂáÜÂ§áËÑöÊú¨
        cat > setup_env.sh << 'EOF'
        export LC_ALL=C.UTF-8
        export LANG=C.UTF-8
        # Ê£ÄÊü• python3 Âíå unzip
        if ! command -v python3 &> /dev/null || ! command -v unzip &> /dev/null; then
            echo "Installing Dependencies..."
            if command -v apt-get &> /dev/null; then
                sudo apt-get update && sudo apt-get install -y python3 python3-pip unzip
            elif command -v yum &> /dev/null; then
                sudo yum install -y python3 unzip
            fi
        fi
        EOF
        
        # ÂèëÈÄÅÂπ∂ÊâßË°åËÑöÊú¨
        # Ê≥®ÊÑèÔºöAMD64 ÂÆû‰æãÂº∫Âà∂‰ΩøÁî® AMD_SSH_USERNAME (ÈÄöÂ∏∏‰∏∫ root)
        USER_NAME="${AMD_SSH_USERNAME:-root}"
        echo "Using SSH User: $USER_NAME"
        
        echo "Copying scripts to $NAME..."
        sshpass -p "$SSH_PASSWORD" scp -P 2222 -o UserKnownHostsFile=/dev/null -o StrictHostKeyChecking=no scripts/remote_keepalive.py $USER_NAME@localhost:~/
        
        echo "Executing remote keepalive..."
        # ‰º†ÈÄí GITHUB_TOKEN ÁªôËøúÁ®ãËÑöÊú¨
        sshpass -p "$SSH_PASSWORD" ssh -P 2222 -o UserKnownHostsFile=/dev/null -o StrictHostKeyChecking=no $USER_NAME@localhost \
            "export GITHUB_TOKEN='$GITHUB_TOKEN' && \
             export REPO_OWNER='$REPO_OWNER' && \
             export REPO_NAME='$REPO_NAME' && \
             python3 ~/remote_keepalive.py --hostname '$NAME'"
        
        # Ê∏ÖÁêÜ Tunnel
        kill $TUNNEL_PID
