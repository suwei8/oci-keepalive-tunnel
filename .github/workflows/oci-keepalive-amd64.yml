name: OCI Keepalive via Tunnel (AMD64)

on:
  schedule:
    - cron: "*/45 * * * *"
  workflow_dispatch:
    inputs:
        target_index:
            description: 'Target Host Index (0-29)'
            required: false
            default: ''

concurrency:
  group: keepalive-amd64
  cancel-in-progress: true

jobs:
  define-matrix:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - name: Filter AMD64 Hosts
        id: set-matrix
        env:
          HOSTS_CONFIG: ${{ secrets.HOSTS_CONFIG }}
          TARGET_INDEX: ${{ inputs.target_index }}
        run: |
          # åŠ¨æ€ç”Ÿæˆ AMD64 ä¸»æœºåˆ—è¡¨ï¼Œé¿å…æ— æ•ˆçš„ä»»åŠ¡å¯åŠ¨
          JSON="{\"host_id\": []}" # é»˜è®¤å€¼
          
          if [ -n "$TARGET_INDEX" ]; then
             # å¦‚æœæŒ‡å®šäº†ç›®æ ‡ï¼Œæ£€æŸ¥æ˜¯å¦ä¸º amd64
             IS_AMD=$(echo "$HOSTS_CONFIG" | jq --argjson idx "$TARGET_INDEX" '.[$idx].cpu_type == "amd64"')
             if [ "$IS_AMD" == "true" ]; then
                 echo "Target $TARGET_INDEX is AMD64. Proceeding."
                 JSON="{\"host_id\": [$TARGET_INDEX]}"
             else
                 echo "Target $TARGET_INDEX is NOT AMD64. Skipping."
             fi
          else
             # ç­›é€‰æ‰€æœ‰ amd64 ä¸»æœº
             INDICES=$(echo "$HOSTS_CONFIG" | jq -c '[to_entries[] | select(.value.cpu_type == "amd64") | .key]')
             if [ -n "$INDICES" ]; then
                echo "Found AMD64 indices: $INDICES"
                JSON="{\"host_id\": $INDICES}"
             else
                echo "No AMD64 indices found."
             fi
          fi
          echo "matrix=$JSON" >> $GITHUB_OUTPUT

  keepalive-matrix:
    needs: define-matrix
    # å¦‚æœåˆ—è¡¨ä¸ºç©ºï¼ˆä¾‹å¦‚æ²¡æœ‰ amd64 å®ä¾‹ï¼‰ï¼Œè·³è¿‡æ‰§è¡Œ
    if: ${{ fromJson(needs.define-matrix.outputs.matrix).host_id[0] != null }}
    runs-on: ubuntu-latest
    permissions:
      contents: write
    strategy:
      fail-fast: false
      max-parallel: 3
      matrix: ${{ fromJson(needs.define-matrix.outputs.matrix) }}

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Set Random Delay
      run: |
        # AMD64 å®ä¾‹è¾ƒå°‘ï¼Œå‡å°‘å»¶è¿Ÿä»¥æé«˜æ•ˆç‡
        DELAY=$((RANDOM % 120 + 30))
        echo "Sleeping for ${DELAY} seconds..."
        sleep $DELAY

    - name: Install Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y sshpass jq unzip
        
        # Install cloudflared from local bin
        sudo cp bin/cloudflared /usr/local/bin/cloudflared
        sudo chmod +x /usr/local/bin/cloudflared
        cloudflared --version
        
    - name: Setup SSH
      run: |
        mkdir -p ~/.ssh
        echo "StrictHostKeyChecking no" > ~/.ssh/config
        
    - name: Run Keepalive (Tunnel Mode)
      env:
        HOSTS_CONFIG: ${{ secrets.HOSTS_CONFIG }}
        SSH_KEY: ${{ secrets.SSH_KEY }}
        AMD_SSH_USERNAME: ${{ secrets.AMD_SSH_USERNAME }}
        SSH_PASSWORD: ${{ secrets.SSH_PASSWORD }}
        CURRENT_INDEX: ${{ matrix.host_id }}
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        REPO_OWNER: ${{ github.repository_owner }}
        REPO_NAME: ${{ github.event.repository.name }}
      run: |
        # è§£æé…ç½®
        HOST_INFO=$(echo $HOSTS_CONFIG | jq -r --argjson idx $CURRENT_INDEX '.[$idx]')
        
        if [ "$HOST_INFO" == "null" ]; then
          echo "Host config not found for index $CURRENT_INDEX"
          exit 0
        fi

        NAME=$(echo $HOST_INFO | jq -r '.name')
        SSH_HOST=$(echo $HOST_INFO | jq -r '.ssh_host')
        # CPU_TYPE å·²åœ¨ define-matrix é˜¶æ®µè¿‡æ»¤ï¼Œæ­¤å¤„æ— éœ€å†æ¬¡æ£€æŸ¥
        
        echo "=========================================="
        echo "ğŸš€ Starting Keepalive for $NAME ($SSH_HOST) [AMD64]"
        echo "=========================================="
        
        # å»ºç«‹ Tunnel
        echo "Creating Cloudflare Tunnel..."
        cloudflared access tcp --hostname $SSH_HOST --url tcp://localhost:2222 > /dev/null 2>&1 &
        TUNNEL_PID=$!
        sleep 5
        
        # å‡†å¤‡è„šæœ¬
        cat > setup_env.sh << 'EOF'
        export LC_ALL=C.UTF-8
        export LANG=C.UTF-8
        # æ£€æŸ¥ python3 å’Œ unzip
        if ! command -v python3 &> /dev/null || ! command -v unzip &> /dev/null; then
            echo "Installing Dependencies..."
            if command -v apt-get &> /dev/null; then
                sudo apt-get update && sudo apt-get install -y python3 python3-pip unzip
            elif command -v yum &> /dev/null; then
                sudo yum install -y python3 unzip
            fi
        fi
        EOF
        
        # å‘é€å¹¶æ‰§è¡Œè„šæœ¬
        # æ³¨æ„ï¼šAMD64 å®ä¾‹å¼ºåˆ¶ä½¿ç”¨ AMD_SSH_USERNAME (é€šå¸¸ä¸º root)
        USER_NAME="${AMD_SSH_USERNAME:-root}"
        echo "Using SSH User: $USER_NAME"
        
        echo "Copying scripts to $NAME..."
        sshpass -p "$SSH_PASSWORD" scp -P 2222 -o UserKnownHostsFile=/dev/null -o StrictHostKeyChecking=no scripts/remote_keepalive.py $USER_NAME@localhost:~/
        
        echo "Executing remote keepalive..."
        # ä¼ é€’ GITHUB_TOKEN ç»™è¿œç¨‹è„šæœ¬
        sshpass -p "$SSH_PASSWORD" ssh -P 2222 -o UserKnownHostsFile=/dev/null -o StrictHostKeyChecking=no $USER_NAME@localhost \
            "export GITHUB_TOKEN='$GITHUB_TOKEN' && \
             export REPO_OWNER='$REPO_OWNER' && \
             export REPO_NAME='$REPO_NAME' && \
             python3 ~/remote_keepalive.py --hostname '$NAME'"
        
        # æ¸…ç† Tunnel
        kill $TUNNEL_PID
