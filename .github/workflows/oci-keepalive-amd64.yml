name: OCI Keepalive via Tunnel (AMD64)

on:
  schedule:
    - cron: "*/45 * * * *"
  workflow_dispatch:
    inputs:
      target_index:
        description: 'Target Host Index (0-29)'
        required: false
        default: ''

concurrency:
  group: keepalive-amd64
  cancel-in-progress: true

jobs:
  define-matrix:
    runs-on: ubuntu-latest
    outputs:
      ids: ${{ steps.set-matrix.outputs.ids }}
    steps:
      - name: Filter AMD64 Hosts
        id: set-matrix
        env:
          HOSTS_CONFIG: ${{ secrets.HOSTS_CONFIG }}
          TARGET_INDEX: ${{ inputs.target_index }}
        run: |
          cat > parse_matrix.py << 'EOF'
          import os, json
          
          try:
              config_str = os.environ.get("HOSTS_CONFIG", "[]")
              hosts = json.loads(config_str)
              
              indices = []
              target_index_str = os.environ.get("TARGET_INDEX", "")
              
              if target_index_str:
                  idx = int(target_index_str)
                  if 0 <= idx < len(hosts):
                      ctype = hosts[idx].get("cpu_type", "unknown")
                      if str(ctype).lower() == "amd64":
                          indices = [idx]
                  else:
                       print(f"Target {idx} out of range.")
              else:
                  # Filter all AMD64 (Case Insensitive)
                  for i, h in enumerate(hosts):
                      ctype = h.get("cpu_type", "unknown")
                      if str(ctype).lower() == "amd64":
                          indices.append(i)
              
              print(f"Found AMD64 indices: {indices}")
              
              # Output JSON string for matrix
              # Base64 encode IDs to avoid matching secrets (GitHub Actions false positive on "0", "1" etc)
              import base64
              b64_indices = [base64.b64encode(str(i).encode()).decode() for i in indices]
              ids_json = json.dumps(b64_indices)
              with open(os.environ["GITHUB_OUTPUT"], "a") as f:
                  f.write(f"ids={ids_json}\n")
                  
          except Exception as e:
              print(f"Error parsing config: {e}")
              with open(os.environ["GITHUB_OUTPUT"], "a") as f:
                  f.write("ids=[]\n")
          EOF
          
          python3 parse_matrix.py

  keepalive-matrix:
    needs: define-matrix
    # å¦‚æœ ID åˆ—è¡¨ä¸ºç©º (å³ "[]")ï¼ŒfromJson è§£æåé•¿åº¦ä¸º 0ï¼Œä½†è¿™å¾ˆéš¾åˆ¤æ–­
    # ç®€å•åˆ¤æ–­å­—ç¬¦ä¸²æ˜¯å¦ä¸º "[]"
    if: ${{ needs.define-matrix.outputs.ids != '[]' }}
    runs-on: ubuntu-latest
    permissions:
      contents: write
    strategy:
      fail-fast: false
      max-parallel: 3
      matrix: 
        host_id: ${{ fromJson(needs.define-matrix.outputs.ids || '[]') }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set Random Delay
        run: |
          # AMD64 å®ä¾‹è¾ƒå°‘ï¼Œå‡å°‘å»¶è¿Ÿä»¥æé«˜æ•ˆç‡
          DELAY=$((RANDOM % 120 + 30))
          echo "Sleeping for ${DELAY} seconds..."
          sleep $DELAY

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y sshpass jq unzip
          
          # Install cloudflared from local bin
          sudo cp bin/cloudflared /usr/local/bin/cloudflared
          sudo chmod +x /usr/local/bin/cloudflared
          cloudflared --version
          
      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "StrictHostKeyChecking no" > ~/.ssh/config
          
      - name: Run Keepalive (Tunnel Mode)
        env:
          HOSTS_CONFIG: ${{ secrets.HOSTS_CONFIG }}
          SSH_KEY: ${{ secrets.SSH_KEY }}
          AMD_SSH_USERNAME: ${{ secrets.AMD_SSH_USERNAME }}
          SSH_PASSWORD: ${{ secrets.SSH_PASSWORD }}
          CURRENT_INDEX: ${{ matrix.host_id }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO_OWNER: ${{ github.repository_owner }}
          REPO_NAME: ${{ github.event.repository.name }}
        run: |
          # è§£æé…ç½®
          # Decode Base64 index
          REAL_INDEX=$(echo "$CURRENT_INDEX" | base64 -d)
          echo "Decoded Target Index: $REAL_INDEX"
          HOST_INFO=$(echo $HOSTS_CONFIG | jq -r --argjson idx $REAL_INDEX '.[$idx]')
          
          if [ "$HOST_INFO" == "null" ]; then
            echo "Host config not found for index $CURRENT_INDEX"
            exit 0
          fi

          NAME=$(echo $HOST_INFO | jq -r '.name')
          SSH_HOST=$(echo $HOST_INFO | jq -r '.ssh_host')
          # CPU_TYPE å·²åœ¨ define-matrix é˜¶æ®µè¿‡æ»¤ï¼Œæ­¤å¤„æ— éœ€å†æ¬¡æ£€æŸ¥
          
          echo "=========================================="
          echo "ğŸš€ Starting Keepalive for $NAME ($SSH_HOST) [AMD64]"
          echo "=========================================="
          
          # å»ºç«‹ Tunnel
          echo "Creating Cloudflare Tunnel..."
          cloudflared access tcp --hostname $SSH_HOST --url tcp://localhost:2222 > /dev/null 2>&1 &
          TUNNEL_PID=$!
          sleep 5
          
          # å‡†å¤‡è„šæœ¬
          cat > setup_env.sh << 'EOF'
          export LC_ALL=C.UTF-8
          export LANG=C.UTF-8
          # æ£€æŸ¥ python3 å’Œ unzip
          if ! command -v python3 &> /dev/null || ! command -v unzip &> /dev/null; then
              echo "Installing Dependencies..."
              if command -v apt-get &> /dev/null; then
                  sudo apt-get update && sudo apt-get install -y python3 python3-pip unzip
              elif command -v yum &> /dev/null; then
                  sudo yum install -y python3 unzip
              fi
          fi
          EOF
          
          # å‘é€å¹¶æ‰§è¡Œè„šæœ¬
          # æ³¨æ„ï¼šAMD64 å®ä¾‹å¼ºåˆ¶ä½¿ç”¨ AMD_SSH_USERNAME (é€šå¸¸ä¸º root)
          USER_NAME="${AMD_SSH_USERNAME:-root}"
          echo "Using SSH User: $USER_NAME"
          
          echo "Copying scripts to $NAME..."
          sshpass -p "$SSH_PASSWORD" scp -P 2222 -o UserKnownHostsFile=/dev/null -o StrictHostKeyChecking=no scripts/remote_keepalive.py $USER_NAME@localhost:~/
          
          echo "Executing remote keepalive..."
          # ä¼ é€’ GITHUB_TOKEN ç»™è¿œç¨‹è„šæœ¬
          sshpass -p "$SSH_PASSWORD" ssh -P 2222 -o UserKnownHostsFile=/dev/null -o StrictHostKeyChecking=no $USER_NAME@localhost \
              "export GITHUB_TOKEN='$GITHUB_TOKEN' && \
               export REPO_OWNER='$REPO_OWNER' && \
               export REPO_NAME='$REPO_NAME' && \
               python3 ~/remote_keepalive.py --hostname '$NAME'"
          
          # æ¸…ç† Tunnel
          kill $TUNNEL_PID
