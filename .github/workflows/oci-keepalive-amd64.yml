name: OCI Keepalive via Tunnel (AMD64)

on:
  schedule:
    - cron: "*/45 * * * *"
  workflow_dispatch:
    inputs:
        target_index:
            description: 'Target Host Index (0-29)'
            required: false
            default: ''

concurrency:
  group: keepalive-amd64
  cancel-in-progress: true

jobs:
  keepalive-matrix:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      max-parallel: 3
      matrix:
        host_id: [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29]

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Set Random Delay
      run: |
        # AMD64 å®ä¾‹è¾ƒå°‘ï¼Œå‡å°‘å»¶è¿Ÿä»¥æé«˜æ•ˆç‡
        DELAY=$((RANDOM % 120 + 30))
        echo "Sleeping for ${DELAY} seconds..."
        sleep $DELAY

    - name: Install Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y sshpass cloudflared jq
        
    - name: Setup SSH
      run: |
        mkdir -p ~/.ssh
        echo "StrictHostKeyChecking no" > ~/.ssh/config
        
    - name: Run Keepalive (Tunnel Mode)
      env:
        HOSTS_CONFIG: ${{ secrets.HOSTS_CONFIG }}
        SSH_KEY: ${{ secrets.SSH_KEY }}
        AMD_SSH_USERNAME: ${{ secrets.AMD_SSH_USERNAME }}
        SSH_PASSWORD: ${{ secrets.SSH_PASSWORD }}
        TARGET_INDEX: ${{ inputs.target_index }}
        CURRENT_INDEX: ${{ matrix.host_id }}
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        REPO_OWNER: ${{ github.repository_owner }}
        REPO_NAME: ${{ github.event.repository.name }}
      run: |
        # è§£æé…ç½®
        HOST_INFO=$(echo $HOSTS_CONFIG | jq -r --argjson idx $CURRENT_INDEX '.[$idx]')
        
        if [ "$HOST_INFO" == "null" ]; then
          echo "Host config not found for index $CURRENT_INDEX"
          exit 0
        fi

        NAME=$(echo $HOST_INFO | jq -r '.name')
        SSH_HOST=$(echo $HOST_INFO | jq -r '.ssh_host')
        CPU_TYPE=$(echo $HOST_INFO | jq -r '.cpu_type')

        # ğŸ¯ å…³é”®è¿‡æ»¤ï¼šä»…å¤„ç† AMD64 å®ä¾‹
        if [ "$CPU_TYPE" != "amd64" ]; then
            echo "âš ï¸  Skipping $NAME (Type: $CPU_TYPE) - This workflow is for AMD64 only."
            exit 0
        fi

        # å¤„ç†æ‰‹åŠ¨è§¦å‘çš„ç›®æ ‡ç­›é€‰
        if [ ! -z "$TARGET_INDEX" ] && [ "$TARGET_INDEX" != "$CURRENT_INDEX" ]; then
            echo "Skipping $CURRENT_INDEX (Target is $TARGET_INDEX)"
            exit 0
        fi
        
        echo "=========================================="
        echo "ğŸš€ Starting Keepalive for $NAME ($SSH_HOST) [AMD64]"
        echo "=========================================="
        
        # å»ºç«‹ Tunnel
        echo "Creating Cloudflare Tunnel..."
        cloudflared access tcp --hostname $SSH_HOST --url tcp://localhost:2222 > /dev/null 2>&1 &
        TUNNEL_PID=$!
        sleep 5
        
        # å‡†å¤‡è„šæœ¬
        cat > setup_env.sh << 'EOF'
        export LC_ALL=C.UTF-8
        export LANG=C.UTF-8
        # æ£€æŸ¥ python3
        if ! command -v python3 &> /dev/null; then
            echo "Installing Python3..."
            if command -v apt-get &> /dev/null; then
                sudo apt-get update && sudo apt-get install -y python3 python3-pip
            elif command -v yum &> /dev/null; then
                sudo yum install -y python3
            fi
        fi
        EOF
        
        # å‘é€å¹¶æ‰§è¡Œè„šæœ¬
        # æ³¨æ„ï¼šAMD64 å®ä¾‹å¼ºåˆ¶ä½¿ç”¨ AMD_SSH_USERNAME (é€šå¸¸ä¸º root)
        USER_NAME="${AMD_SSH_USERNAME:-root}"
        echo "Using SSH User: $USER_NAME"
        
        echo "Copying scripts to $NAME..."
        sshpass -p "$SSH_PASSWORD" scp -P 2222 -o UserKnownHostsFile=/dev/null -o StrictHostKeyChecking=no scripts/remote_keepalive.py $USER_NAME@localhost:~/
        
        echo "Executing remote keepalive..."
        # ä¼ é€’ GITHUB_TOKEN ç»™è¿œç¨‹è„šæœ¬
        sshpass -p "$SSH_PASSWORD" ssh -P 2222 -o UserKnownHostsFile=/dev/null -o StrictHostKeyChecking=no $USER_NAME@localhost \
            "export GITHUB_TOKEN='$GITHUB_TOKEN' && \
             export REPO_OWNER='$REPO_OWNER' && \
             export REPO_NAME='$REPO_NAME' && \
             python3 ~/remote_keepalive.py --hostname '$NAME'"
        
        # æ¸…ç† Tunnel
        kill $TUNNEL_PID
