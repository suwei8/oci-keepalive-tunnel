name: OCI Keepalive via Tunnel (AMD64)

on:
  schedule:
    - cron: "*/45 * * * *"
  workflow_dispatch:
    inputs:
      target_index:
        description: 'Target Host Index (0-29)'
        required: false
        default: ''

concurrency:
  group: keepalive-amd64
  cancel-in-progress: true

jobs:
  keepalive-matrix:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    strategy:
      fail-fast: false
      max-parallel: 3
      matrix: 
        host_id: [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29]

    steps:
      - name: Check Host Configuration
        id: host
        env:
          HOSTS_CONFIG: ${{ secrets.HOSTS_CONFIG }}
          TARGET_INDEX: ${{ inputs.target_index }}
          CURRENT_INDEX: ${{ matrix.host_id }}
        run: |
          # æå–ä¸»æœºä¿¡æ¯
          HOST_INFO=$(echo $HOSTS_CONFIG | jq -r --argjson idx $CURRENT_INDEX '.[$idx]')

          # æ£€æŸ¥æ˜¯å¦å­˜åœ¨
          if [ "$HOST_INFO" == "null" ] || [ -z "$HOST_INFO" ]; then
            echo "skip=true" >> $GITHUB_OUTPUT
            echo "No host config at index $CURRENT_INDEX"
            exit 0
          fi

          # æ£€æŸ¥æ˜¯å¦ä¸º AMD64
          CPU_TYPE=$(echo "$HOST_INFO" | jq -r '.cpu_type')
          if [ "${CPU_TYPE,,}" != "amd64" ]; then
            echo "skip=true" >> $GITHUB_OUTPUT
            echo "Skipping non-AMD64 host (Type: $CPU_TYPE) at index $CURRENT_INDEX"
            exit 0
          fi

          # æ£€æŸ¥æ˜¯å¦æŒ‡å®šäº† Target Index
          if [ -n "$TARGET_INDEX" ] && [ "$TARGET_INDEX" != "$CURRENT_INDEX" ]; then
            echo "skip=true" >> $GITHUB_OUTPUT
            echo "Skipping index $CURRENT_INDEX (Target is $TARGET_INDEX)"
            exit 0
          fi

          echo "skip=false" >> $GITHUB_OUTPUT
          echo "Found AMD64 host at index $CURRENT_INDEX"


      - name: Checkout
        if: steps.host.outputs.skip != 'true'
        uses: actions/checkout@v4

      - name: Set Random Delay
        if: steps.host.outputs.skip != 'true'
        run: |
          # AMD64 å®ä¾‹è¾ƒå°‘ï¼Œå‡å°‘å»¶è¿Ÿä»¥æé«˜æ•ˆç‡
          DELAY=$((RANDOM % 120 + 30))
          echo "Sleeping for ${DELAY} seconds..."
          sleep $DELAY

      - name: Install Dependencies
        if: steps.host.outputs.skip != 'true'
        run: |
          sudo apt-get update
          sudo apt-get install -y sshpass jq unzip
          
          # Install cloudflared from local bin
          sudo cp bin/cloudflared /usr/local/bin/cloudflared
          sudo chmod +x /usr/local/bin/cloudflared
          cloudflared --version
          
      - name: Setup SSH
        if: steps.host.outputs.skip != 'true'
        run: |
          mkdir -p ~/.ssh
          echo "StrictHostKeyChecking no" > ~/.ssh/config
          
      - name: Run Keepalive (Tunnel Mode)
        env:
          HOSTS_CONFIG: ${{ secrets.HOSTS_CONFIG }}
          SSH_KEY: ${{ secrets.SSH_KEY }}
          AMD_SSH_USERNAME: ${{ secrets.AMD_SSH_USERNAME }}
          SSH_PASSWORD: ${{ secrets.SSH_PASSWORD }}
          CURRENT_INDEX: ${{ matrix.host_id }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO_OWNER: ${{ github.repository_owner }}
          REPO_NAME: ${{ github.event.repository.name }}
        if: steps.host.outputs.skip != 'true'
        run: |
          # è§£æé…ç½®
          # No decoding needed for static matrix
          HOST_INFO=$(echo $HOSTS_CONFIG | jq -r --argjson idx $CURRENT_INDEX '.[$idx]')
          
          if [ "$HOST_INFO" == "null" ]; then
            echo "Host config not found for index $CURRENT_INDEX"
            exit 0
          fi

          NAME=$(echo $HOST_INFO | jq -r '.name')
          SSH_HOST=$(echo $HOST_INFO | jq -r '.ssh_host')
          # CPU_TYPE å·²åœ¨ define-matrix é˜¶æ®µè¿‡æ»¤ï¼Œæ­¤å¤„æ— éœ€å†æ¬¡æ£€æŸ¥
          
          echo "=========================================="
          echo "ğŸš€ Starting Keepalive for $NAME ($SSH_HOST) [AMD64]"
          echo "=========================================="
          
          # å»ºç«‹ Tunnel
          echo "Creating Cloudflare Tunnel..."
          cloudflared access tcp --hostname $SSH_HOST --url tcp://localhost:2222 > /dev/null 2>&1 &
          TUNNEL_PID=$!
          sleep 5
          
          # å‡†å¤‡è„šæœ¬
          cat > setup_env.sh << 'EOF'
          export LC_ALL=C.UTF-8
          export LANG=C.UTF-8
          # æ£€æŸ¥ python3 å’Œ unzip
          if ! command -v python3 &> /dev/null || ! command -v unzip &> /dev/null; then
              echo "Installing Dependencies..."
              if command -v apt-get &> /dev/null; then
                  sudo apt-get update && sudo apt-get install -y python3 python3-pip unzip
              elif command -v yum &> /dev/null; then
                  sudo yum install -y python3 unzip
              fi
          fi
          EOF
          
          # å‘é€å¹¶æ‰§è¡Œè„šæœ¬
          # æ³¨æ„ï¼šAMD64 å®ä¾‹å¼ºåˆ¶ä½¿ç”¨ AMD_SSH_USERNAME (é€šå¸¸ä¸º root)
          USER_NAME="${AMD_SSH_USERNAME:-root}"
          echo "Using SSH User: $USER_NAME"
          
          echo "Copying scripts to $NAME..."
          sshpass -p "$SSH_PASSWORD" scp -P 2222 -o UserKnownHostsFile=/dev/null -o StrictHostKeyChecking=no scripts/remote_keepalive.py $USER_NAME@localhost:~/
          
          echo "Executing remote keepalive..."
          # ä¼ é€’ GITHUB_TOKEN ç»™è¿œç¨‹è„šæœ¬
           sshpass -p "$SSH_PASSWORD" ssh -vvv -o PreferredAuthentications=password -o PubkeyAuthentication=no -P 2222 -o UserKnownHostsFile=/dev/null -o StrictHostKeyChecking=no $USER_NAME@localhost \
              "export GITHUB_TOKEN='$GITHUB_TOKEN' && \
               export REPO_OWNER='$REPO_OWNER' && \
               export REPO_NAME='$REPO_NAME' && \
               python3 ~/remote_keepalive.py --hostname '$NAME'"
          
          # æ¸…ç† Tunnel
          kill $TUNNEL_PID
