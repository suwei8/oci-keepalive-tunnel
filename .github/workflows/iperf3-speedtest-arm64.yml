name: iPerf3 Speedtest All Instances (ARM64)

on:
#   schedule:
#     # UTC 02:00 = åŒ—äº¬æ—¶é—´ 10:00
#     - cron: '0 2 * * *'
#     # UTC 11:00 = åŒ—äº¬æ—¶é—´ 19:00
#     - cron: '0 11 * * *'
  workflow_dispatch:
    inputs:
      test_duration:
        description: 'æµ‹é€Ÿæ—¶é•¿ (ç§’)'
        required: false
        default: '30'
      target_hosts:
        description: 'é€‰æ‹©æµ‹é€Ÿä¸»æœº (GitHubé™åˆ¶ä»…æ”¯æŒå•é€‰)'
        required: false
        default: 'ALL'
        type: choice
        options:
          - 'ALL'
          - 'å·´æ·¡å²›2'
          - 'å·´æ·¡å²›3'
          - 'å·´æ·¡å²›4'
          - 'è¿ªæ‹œ'
          - 'ä¸œäº¬1'
          - 'éƒ½çµ'
          - 'å‡¤å‡°åŸ'
          - 'å‡¤å‡°åŸ2-arm1'
          - 'å‡¤å‡°åŸ2-arm2'
          - 'é©¬å¾·é‡Œ3-3'
          - 'é©¬å¾·é‡Œ3-4'
          - 'é¦–å°”1'
          - 'é¦–å°”2'
          - 'æ‚‰å°¼'
          - 'æ–°åŠ å¡'
          - 'æ–°åŠ å¡3'
          - 'æ–°åŠ å¡è¥¿1'
          - 'æ–°åŠ å¡è¥¿2'
          - 'æ–°åŠ å¡è¥¿3'
          - 'æ–°åŠ å¡è¥¿4'
          - 'æ–°åŠ å¡è¥¿5'
          - 'æ–°åŠ å¡è¥¿6-arm1'
          - 'æ–°åŠ å¡è¥¿6-arm2'
          - 'æ–°åŠ å¡è¥¿7'
      speed_rank:
        description: 'ä¸ŠæœŸæµ‹é€Ÿæ’å (ä»…å½“ Target Hosts ä¸º ALL æ—¶ç”Ÿæ•ˆ)'
        required: false
        default: 'ALL'
        type: choice
        options:
          - 'ALL'
          - 'TOP5'
          - 'TOP10'

jobs:
  speedtest-loop:
    name: "Speedtest Loop"
    runs-on: ubuntu-latest
    timeout-minutes: 60  # å¢åŠ è¶…æ—¶æ—¶é—´ï¼Œå› ä¸ºæ˜¯ä¸²è¡Œè·‘æ‰€æœ‰
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install cloudflared
        run: |
          sudo cp bin/cloudflared /usr/local/bin/cloudflared
          cloudflared --version

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          cat >> ~/.ssh/config << 'EOF'
          Host *
            StrictHostKeyChecking no
            UserKnownHostsFile /dev/null
            LogLevel ERROR
          EOF
          sudo apt-get update -qq && sudo apt-get install -y -qq sshpass jq

      - name: Run Speedtest Loop
        id: speedtest
        env:
          HOSTS_CONFIG_URL: ${{ secrets.HOSTS_CONFIG_URL }}
          SSH_USERNAME: ${{ secrets.SSH_USERNAME }}
          SSH_PASSWORD: ${{ secrets.SSH_PASSWORD }}
          IPERF_CLIENT_HOST: ${{ secrets.IPERF_CLIENT_HOST }}
          IPERF_CLIENT_USER: ${{ secrets.IPERF_CLIENT_USER }}
          IPERF_CLIENT_PASS: ${{ secrets.IPERF_CLIENT_PASS }}
          TEST_DURATION: ${{ github.event.inputs.test_duration }}
          TARGET_HOSTS: ${{ github.event.inputs.target_hosts }}
          SPEED_RANK: ${{ github.event.inputs.speed_rank }}
        run: |
          # SSH å‚æ•°
          SSH_OPTS="-o ConnectTimeout=30 -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR -o ServerAliveInterval=30"
          
          # è·å–é…ç½®
          HOSTS_CONFIG=$(curl -s $HOSTS_CONFIG_URL) || true
          
          # 1. å»ºç«‹åˆ°å®¶åº­å®¢æˆ·æœºçš„ Tunnel (å…¨å±€æŒä¹…è¿æ¥, Port 2202)
          echo ">>> æ­£åœ¨è¿æ¥å®¶åº­æµ‹é€Ÿå®¢æˆ·æœº ($IPERF_CLIENT_HOST)..."
          cloudflared access ssh --hostname "$IPERF_CLIENT_HOST" --url "ssh://127.0.0.1:2202" &
          TUNNEL_HOME_PID=$!
          sleep 5
          
          if ! kill -0 $TUNNEL_HOME_PID 2>/dev/null; then
            echo "âŒ æ— æ³•è¿æ¥å®¶åº­å®¢æˆ·æœºï¼Œä»»åŠ¡ç»ˆæ­¢"
            exit 1
          fi
          echo "âœ… å®¶åº­å®¢æˆ·æœºè¿æ¥æˆåŠŸ"
          
          # 2. ç¡®å®šç›®æ ‡ä¸»æœºåˆ—è¡¨ (Target Selection Logic)
          CSV_FILE="csv/iperf3_results.csv"
          TARGET_LIST=""
          
          if [ "$TARGET_HOSTS" != "ALL" ] && [ -n "$TARGET_HOSTS" ]; then
              # ç”¨æˆ·æ˜ç¡®æŒ‡å®šäº†ä¸»æœº (Priority 1)
              echo "ğŸ¯ Mode: Single Host Selection"
              TARGET_LIST="$TARGET_HOSTS"
          elif [ "$SPEED_RANK" != "ALL" ] && [ -n "$SPEED_RANK" ]; then
              # ç”¨æˆ·é€‰æ‹©äº†æ’åç­›é€‰ (Priority 2)
              echo "ğŸ“Š Mode: Speed Rank Filter ($SPEED_RANK)"
              if [ -f "$CSV_FILE" ]; then
                  # è§£æ CSV å–å‡º Top N çš„åå­—
                  RANK_NUM=30
                  if [ "$SPEED_RANK" == "TOP5" ]; then RANK_NUM=5; fi
                  if [ "$SPEED_RANK" == "TOP10" ]; then RANK_NUM=10; fi
                  
                  # é€»è¾‘: è·³è¿‡è¡¨å¤´ -> æŒ‰ç¬¬2åˆ—æ•°å€¼é™åº -> å–å‰Nè¡Œ -> æå–ç¬¬1åˆ—åå­— -> æ›¿æ¢æ¢è¡Œä¸ºé€—å·
                  # æ³¨æ„: download_speed æ ¼å¼å¦‚ "12 Mbps", sort -n å¯ä»¥æ­£ç¡®å¤„ç†å¼€å¤´çš„æ•°å­—
                  LOG_LIST=$(tail -n +2 "$CSV_FILE" | sort -t',' -k2 -nr | head -n "$RANK_NUM")
                  TARGET_LIST=$(echo "$LOG_LIST" | cut -d',' -f1 | tr '\n' ',' | sed 's/,$//')
                  
                  echo "Found Top Hosts: $TARGET_LIST"
                  
                  if [ -z "$TARGET_LIST" ]; then
                     echo "âš ï¸ Warning: Could not find ranking data, falling back to ALL."
                  fi
              else
                  echo "âš ï¸ Warning: CSV file not found (first run?), falling back to ALL."
              fi
          fi
          
          # 3. å‡†å¤‡ CSV æ–‡ä»¶ (æ¯æ¬¡è¦†ç›–)
          # æ³¨æ„ï¼šå¿…é¡»åœ¨è¯»å–å®Œæ’ååæ‰æ¸…ç©ºæ–‡ä»¶
          mkdir -p csv
          echo "name,download_speed,upload_speed,timestamp" > "$CSV_FILE"
          
          # 4. å¾ªç¯éå†ä¸»æœº
          # å…ˆè·å–ä¸»æœºæ€»æ•°
          HOST_COUNT=$(echo "$HOSTS_CONFIG" | jq '. | length')
          MAX_INDEX=$((HOST_COUNT - 1))
          
          echo "Total hosts: $HOST_COUNT (Indices 0 to $MAX_INDEX)"
          
          for INDEX in $(seq 0 $MAX_INDEX); do
            # è·å–å½“å‰ä¸»æœºé…ç½®
            host_item=$(echo "$HOSTS_CONFIG" | jq -c ".[$INDEX]")
            HOST_NAME=$(echo "$host_item" | jq -r '.name')
            SSH_HOST=$(echo "$host_item" | jq -r '.ssh_host')
            CPU_TYPE=$(echo "$host_item" | jq -r '.cpu_type')
            
            if [ "$HOST_NAME" = "null" ] || [ -z "$HOST_NAME" ]; then
               continue
            fi
            
            # åªå¤„ç† arm64 ç±»å‹çš„ä¸»æœº
            if [ "$CPU_TYPE" != "arm64" ]; then
               continue
            fi

            # è¿‡æ»¤é€»è¾‘
            if [ -n "$TARGET_LIST" ]; then
                SHOULD_RUN=0
                # æ›¿æ¢ä¸­æ–‡é€—å·
                SANITIZED_TARGETS=$(echo "$TARGET_LIST" | tr 'ï¼Œ' ',')
                # é€—å·åˆ†éš”å¾ªç¯
                OLD_IFS="$IFS"
                IFS=','
                for KEYWORD in $SANITIZED_TARGETS; do
                    KEYWORD=$(echo "$KEYWORD" | xargs)
                    # ç²¾ç¡®åŒ¹é…åå­—ï¼Œé¿å…éƒ¨åˆ†åŒ¹é… (å› ä¸ºæ˜¯ä» CSV è¯»å–çš„å®Œæ•´åå­—)
                    if [ "$HOST_NAME" == "$KEYWORD" ]; then
                        SHOULD_RUN=1
                        echo "Target match: '$HOST_NAME'"
                        break
                    fi
                    # å…¼å®¹ä¹‹å‰çš„æ‰‹åŠ¨è¾“å…¥æ¨¡ç³ŠåŒ¹é…
                    if [[ "$HOST_NAME" == *"$KEYWORD"* ]]; then
                        SHOULD_RUN=1
                        break
                    fi
                done
                IFS="$OLD_IFS"
                
                if [ "$SHOULD_RUN" -eq 0 ]; then
                    continue
                fi
            fi
            
            echo ""
            echo "---------------------------------------------------"
            echo "Processing Host [$INDEX]: $HOST_NAME"
            echo "---------------------------------------------------"
            
            # --- å•ä¸ªä¸»æœºæµç¨‹å¼€å§‹ ---
            
            # 3.1 å»ºç«‹ OCI ä¸´æ—¶éš§é“ (Port 2222) - å¸¦é‡è¯•æœºåˆ¶
            TUNNEL_SUCCESS=0
            MAX_RETRIES=3
            
            for RETRY in $(seq 1 $MAX_RETRIES); do
              echo ">>> å°è¯•è¿æ¥ OCI Tunnel ($RETRY/$MAX_RETRIES)..."
              
              # æ¸…ç†å¯èƒ½æ®‹ç•™çš„æ—§éš§é“
              pkill -f "cloudflared.*2222" 2>/dev/null || true
              sleep 2
              
              cloudflared access ssh --hostname "$SSH_HOST" --url "ssh://127.0.0.1:2222" &
              TUNNEL_OCI_PID=$!
              sleep 5
              
              if kill -0 $TUNNEL_OCI_PID 2>/dev/null; then
                TUNNEL_SUCCESS=1
                echo "âœ… OCI Tunnel è¿æ¥æˆåŠŸ (ç¬¬ $RETRY æ¬¡å°è¯•)"
                break
              else
                echo "âš ï¸ OCI Tunnel è¿æ¥å¤±è´¥ (ç¬¬ $RETRY æ¬¡å°è¯•)"
                if [ $RETRY -lt $MAX_RETRIES ]; then
                  echo "   ç­‰å¾… 10 ç§’åé‡è¯•..."
                  sleep 10
                fi
              fi
            done
            
            if [ $TUNNEL_SUCCESS -eq 0 ]; then
              echo "âŒ OCI Tunnel å¤±è´¥ (å·²é‡è¯• $MAX_RETRIES æ¬¡): $HOST_NAME"
              echo "   è·³è¿‡æ­¤ä¸»æœºï¼Œç»§ç»­å¤„ç†ä¸‹ä¸€ä¸ª..."
              continue
            fi
            
            # 3.2 é…ç½® OCI (å®‰è£… iperf3 + è·å– IP + å¯åŠ¨ Server) - å¸¦é‡è¯•æœºåˆ¶
            echo ">>> é…ç½® OCI..."
            
            OCI_CONFIG_SUCCESS=0
            OCI_PUBLIC_IP=""
            SERVER_STATUS=""
            
            for SSH_RETRY in $(seq 1 3); do
              echo "    å°è¯• SSH è¿æ¥ ($SSH_RETRY/3)..."
              
              # å°è¯•è¿æ¥å¹¶æ‰§è¡Œå‘½ä»¤ (ä½¿ç”¨ || true é˜²æ­¢å¤±è´¥é€€å‡º)
              PREPARE_OUTPUT=$(sshpass -p "$SSH_PASSWORD" ssh $SSH_OPTS -n -p 2222 "${SSH_USERNAME}@127.0.0.1" '
                which iperf3 > /dev/null 2>&1 || (sudo apt-get update -qq && sudo apt-get install -y -qq iperf3)
                IP=$(curl -4 -s ip.sb)
                echo "PUBLIC_IP::$IP"
                sudo pkill -9 iperf3 2>/dev/null || true
                sudo iptables -I INPUT -p tcp --dport 5201 -j ACCEPT 2>/dev/null || true
                sudo netfilter-persistent save 2>/dev/null || true
                sudo nohup iperf3 -s -D > /dev/null 2>&1
                sleep 2
                pgrep -x iperf3 > /dev/null && echo "SERVER_STARTED" || echo "SERVER_FAILED"
              ' 2>&1) || true
              
              # è§£æè¾“å‡º
              OCI_PUBLIC_IP=$(echo "$PREPARE_OUTPUT" | grep "PUBLIC_IP::" | cut -d':' -f3 | tr -d '\r')
              SERVER_STATUS=$(echo "$PREPARE_OUTPUT" | grep "SERVER_STARTED")
              
              if [ -n "$OCI_PUBLIC_IP" ] && [ -n "$SERVER_STATUS" ]; then
                OCI_CONFIG_SUCCESS=1
                break
              else
                echo "    âš ï¸ SSH é…ç½®å¤±è´¥ (ç¬¬ $SSH_RETRY æ¬¡)"
                if [ $SSH_RETRY -lt 3 ]; then
                  echo "    ç­‰å¾… 5 ç§’åé‡è¯•..."
                  sleep 5
                fi
              fi
            done
            
            if [ $OCI_CONFIG_SUCCESS -eq 0 ]; then
               echo "âŒ OCI é…ç½®å¤±è´¥ (å·²é‡è¯• 3 æ¬¡): $HOST_NAME"
               echo "   è·³è¿‡æ­¤ä¸»æœºï¼Œç»§ç»­å¤„ç†ä¸‹ä¸€ä¸ª..."
               kill $TUNNEL_OCI_PID 2>/dev/null || true
               continue
            fi
            
            MASKED_IP=$(echo "$OCI_PUBLIC_IP" | awk -F. '{print $1"."$2"."$3".*"}')
            echo "âœ… OCI å°±ç»ª: $MASKED_IP"
            
            # 3.3 å®¢æˆ·æœºæµ‹é€Ÿ (Home -> OCI)
            echo ">>> å¼€å§‹æµ‹é€Ÿ..."
            
            UNSET_PROXY="unset http_proxy https_proxy ftp_proxy all_proxy HTTP_PROXY HTTPS_PROXY FTP_PROXY ALL_PROXY"
            
            # ä¸‹è½½ (Server sends to Client)
            IPERF_DL_RESULT=$(sshpass -p "$IPERF_CLIENT_PASS" ssh $SSH_OPTS -n -p 2202 "${IPERF_CLIENT_USER}@127.0.0.1" "
              $UNSET_PROXY
              which iperf3 > /dev/null 2>&1 || (apt-get update -qq && apt-get install -y -qq iperf3)
              iperf3 -c $OCI_PUBLIC_IP -R -t ${TEST_DURATION:-10} -J || echo '{\"error\": \"connection failed\"}'
            ")
            
            sleep 1
            
            # ä¸Šä¼  (Client sends to Server)
            IPERF_UL_RESULT=$(sshpass -p "$IPERF_CLIENT_PASS" ssh $SSH_OPTS -n -p 2202 "${IPERF_CLIENT_USER}@127.0.0.1" "
              $UNSET_PROXY
              iperf3 -c $OCI_PUBLIC_IP -t ${TEST_DURATION:-10} -J || echo '{\"error\": \"connection failed\"}'
            ")
            
            # 3.4 æ¸…ç† OCI
            sshpass -p "$SSH_PASSWORD" ssh $SSH_OPTS -n -p 2222 "${SSH_USERNAME}@127.0.0.1" 'sudo pkill -9 iperf3 2>/dev/null || true'
            kill $TUNNEL_OCI_PID 2>/dev/null || true
            
            # 3.5 è§£æç»“æœ & å†™å…¥ CSV
            get_speed_mbps() {
                local json=$1
                if echo "$json" | grep -q '"error"'; then
                    echo "N/A"
                else
                    local bits=$(echo "$json" | jq -r '.end.sum_received.bits_per_second // 0' 2>/dev/null)
                    if [ -z "$bits" ] || [ "$bits" = "0" ] || [ "$bits" = "null" ]; then
                        echo "N/A"
                    else
                        echo "scale=2; $bits / 1000000" | bc
                    fi
                fi
            }
            
            DL_VAL=$(get_speed_mbps "$IPERF_DL_RESULT")
            UL_VAL=$(get_speed_mbps "$IPERF_UL_RESULT")
            
            if [ "$DL_VAL" != "N/A" ]; then DL_STR="${DL_VAL} Mbps"; else DL_STR="N/A"; fi
            if [ "$UL_VAL" != "N/A" ]; then UL_STR="${UL_VAL} Mbps"; else UL_STR="N/A"; fi
            
            TIMESTAMP=$(date -u +"%Y-%m-%d %H:%M:%S")
            
            # å†™å…¥æ–‡ä»¶
            echo "${HOST_NAME},${DL_STR},${UL_STR},${TIMESTAMP}" >> "$CSV_FILE"
            echo "âœ… ç»“æœ: ä¸‹è½½ $DL_STR | ä¸Šä¼  $UL_STR"
            
            # --- å•ä¸ªä¸»æœºæµç¨‹ç»“æŸ ---
            
          done
          
          # ç»“æŸåæ¸…ç†å®¶åº­éš§é“
          kill $TUNNEL_HOME_PID 2>/dev/null || true
          echo "âœ… æ‰€æœ‰ä»»åŠ¡å®Œæˆ"
          
          # æ˜¾ç¤ºå½“å‰æ–‡ä»¶å†…å®¹ç”¨äºè°ƒè¯•
          echo "=== Final CSV Content ==="
          tail -20 "$CSV_FILE"

      - name: Commit results
        run: |
          CSV_FILE="csv/iperf3_results.csv"
          if [ -f "$CSV_FILE" ]; then
            # æŒ‰ä¸‹è½½é€Ÿåº¦é™åºæ’åº (ä¿ç•™è¡¨å¤´)
            echo ">>> æ’åº CSV æ–‡ä»¶ (æŒ‰ä¸‹è½½é€Ÿåº¦é™åº)..."
            head -1 "$CSV_FILE" > /tmp/csv_header.tmp
            # è·³è¿‡è¡¨å¤´ï¼Œæå–æ•°å­—éƒ¨åˆ†æ’åº (æ ¼å¼: "123.45 Mbps")
            tail -n +2 "$CSV_FILE" | sort -t',' -k2 -rn > /tmp/csv_body.tmp
            cat /tmp/csv_header.tmp /tmp/csv_body.tmp > "$CSV_FILE"
            rm -f /tmp/csv_header.tmp /tmp/csv_body.tmp
            echo "âœ… æ’åºå®Œæˆ"
            
            # æ˜¾ç¤ºæ’åºåå†…å®¹
            echo "=== æ’åºå CSV (Top 10) ==="
            head -11 "$CSV_FILE"
            
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git pull --rebase origin main || echo "Git pull failed"
            git add "$CSV_FILE"
            git diff --staged --quiet || git commit -m "Update iPerf3 speedtest results (Loop) $(date -u +%Y-%m-%d)"
            git push || echo "Nothing to push"
          fi

      - name: Summary
        run: |
          CSV_FILE="csv/iperf3_results.csv"
          TODAY=$(date -u +"%Y-%m-%d")
          
          echo "## ğŸš€ iPerf3 æµ‹é€Ÿç»“æœ (Single Loop)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### ğŸ† é€Ÿåº¦æ’å (Top 10)" >> $GITHUB_STEP_SUMMARY
          echo "| ä¸‹è½½é€Ÿåº¦ | ä¸Šä¼ é€Ÿåº¦ | å®ä¾‹åç§° |" >> $GITHUB_STEP_SUMMARY
          echo "| :--- | :--- | :--- |" >> $GITHUB_STEP_SUMMARY
          
          if [ -f "$CSV_FILE" ]; then
            grep "$TODAY" "$CSV_FILE" 2>/dev/null | grep -v "N/A" | \
              awk -F',' '{
                dl = $2; ul = $3;
                gsub(/ Mbps/, "", dl); gsub(/ Mbps/, "", ul);
                printf "| %s Mbps | %s Mbps | %s |\n", dl, ul, $1
              }' | sort -k2 -rn | head -10 >> $GITHUB_STEP_SUMMARY
          else
            echo "No results found." >> $GITHUB_STEP_SUMMARY
          fi

      - name: Send Telegram notification
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          CSV_FILE="csv/iperf3_results.csv"
          
          if [ -z "$TELEGRAM_BOT_TOKEN" ] || [ -z "$TELEGRAM_CHAT_ID" ]; then
            echo "âš ï¸ Telegram æœªé…ç½®ï¼Œè·³è¿‡é€šçŸ¥"
            exit 0
          fi
          
          if [ ! -f "$CSV_FILE" ]; then
            echo "âš ï¸ CSV æ–‡ä»¶ä¸å­˜åœ¨ï¼Œè·³è¿‡é€šçŸ¥"
            exit 0
          fi
          
          # æ„å»º TOP 10 åˆ—è¡¨
          TOP10_TEXT=$(tail -n +2 "$CSV_FILE" | grep -v "N/A" | head -10 | awk -F',' '{printf "%2d. %-12s %s\n", NR, $2, $1}')
          
          # æ„å»ºå®Œæ•´æ¶ˆæ¯ (ä½¿ç”¨ printf é¿å… heredoc)
          TIMESTAMP=$(date -u +'%Y-%m-%d %H:%M UTC')
          FINAL_MSG=$(printf "ğŸš€ *iPerf3 æµ‹é€Ÿå®Œæˆ*\n\nğŸ“… %s\n\nğŸ† *é€Ÿåº¦æ’å (Top 10)*\n\`\`\`\n%s\n\`\`\`" "$TIMESTAMP" "$TOP10_TEXT")
          
          # å‘é€ Telegram
          # æ”¯æŒå¤šä¸ª chat_id (é€—å·åˆ†éš”)
          IFS=',' read -ra CHAT_IDS <<< "$TELEGRAM_CHAT_ID"
          for chat_id in "${CHAT_IDS[@]}"; do
            chat_id=$(echo "$chat_id" | xargs)
            if [ -n "$chat_id" ]; then
              curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
                -d chat_id="${chat_id}" \
                -d parse_mode="Markdown" \
                --data-urlencode "text=${FINAL_MSG}" > /dev/null
            fi
          done
          
          echo "âœ… Telegram é€šçŸ¥å·²å‘é€"
