name: Deploy Rclone & Mount (ARM64)

on:
  workflow_dispatch:
    inputs:
      target_host:
        description: '指定主机 (留空=全部)'
        required: false
        default: ''
      force_remount:
        description: '强制重新挂载 (重启服务)'
        required: false
        default: 'false'
        type: choice
        options:
          - 'false'
          - 'true'

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false

jobs:
  deploy-rclone:
    name: "Deploy Rclone"
    runs-on: ubuntu-latest
    timeout-minutes: 60
    permissions:
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install cloudflared
        run: |
          sudo cp bin/cloudflared /usr/local/bin/cloudflared
          cloudflared --version

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          cat >> ~/.ssh/config << 'EOF'
          Host *
            StrictHostKeyChecking no
            UserKnownHostsFile /dev/null
            LogLevel ERROR
          EOF
          sudo apt-get update -qq && sudo apt-get install -y -qq sshpass jq

      - name: Deploy to all hosts
        id: deploy
        env:
          HOSTS_CONFIG: ${{ secrets.HOSTS_CONFIG }}
          SSH_USERNAME: ${{ secrets.SSH_USERNAME }}
          SSH_PASSWORD: ${{ secrets.SSH_PASSWORD }}
          RCLONE_CONF: ${{ secrets.RCLONE_CONF }}
          TARGET_HOST_INPUT: ${{ github.event.inputs.target_host }}
          FORCE_REMOUNT: ${{ github.event.inputs.force_remount }}
        run: |
          SSH_OPTS="-o ConnectTimeout=30 -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR -o ServerAliveInterval=30"
          
          # 检查必要 Secret
          if [ -z "$RCLONE_CONF" ]; then
             echo "❌ Error: Secret 'RCLONE_CONF' is missing!"
             exit 1
          fi
          
          # 获取主机列表
          HOST_COUNT=$(echo "$HOSTS_CONFIG" | jq '. | length')
          MAX_INDEX=$((HOST_COUNT - 1))
          
          echo "Total hosts: $HOST_COUNT"
          
          for INDEX in $(seq 0 $MAX_INDEX); do
            host_item=$(echo "$HOSTS_CONFIG" | jq -c ".[$INDEX]")
            HOST_NAME=$(echo "$host_item" | jq -r '.name')
            SSH_HOST=$(echo "$host_item" | jq -r '.ssh_host')
            CPU_TYPE=$(echo "$host_item" | jq -r '.cpu_type')
            
            if [ "$HOST_NAME" = "null" ] || [ -z "$HOST_NAME" ]; then continue; fi
            if [ "$CPU_TYPE" != "arm64" ]; then continue; fi
            
            if [ -n "$TARGET_HOST_INPUT" ] && [ "$HOST_NAME" != "$TARGET_HOST_INPUT" ]; then
                continue
            fi
            
            echo ""
            echo "==========================================="
            echo "Processing: $HOST_NAME"
            echo "==========================================="
            
            # --- SSH Tunnel ---
            pkill -f "cloudflared.*2222" 2>/dev/null || true
            sleep 2
            
            cloudflared access ssh --hostname "$SSH_HOST" --url "ssh://127.0.0.1:2222" &
            TUNNEL_PID=$!
            sleep 5
            
            if ! kill -0 $TUNNEL_PID 2>/dev/null; then
              echo "❌ Tunnel 连接失败"
              continue
            fi
            
            # --- 部署逻辑 ---
            echo ">>> 开始配置 Rclone..."
            
            sshpass -p "$SSH_PASSWORD" ssh $SSH_OPTS -n -p 2222 "${SSH_USERNAME}@127.0.0.1" "
              set -e
              
              # 0. 确保仓库存在并更新
              if [ ! -d 'oci-keepalive-tunnel' ]; then
                git clone https://github.com/suwei8/oci-keepalive-tunnel.git
              fi
              cd oci-keepalive-tunnel
              git pull --quiet 2>/dev/null || (git fetch --all && git reset --hard origin/main)
              
              # 1. 注入配置 (workflow 负责，因为脚本读取本地文件比较复杂)
              echo '  -> 写入配置...'
              sudo mkdir -p /etc/rclone
              echo \"$(echo "$RCLONE_CONF" | base64 -w 0)\" | base64 -d | sudo tee /etc/rclone/rclone.conf > /dev/null
              sudo chmod 600 /etc/rclone/rclone.conf
              
              # 2. 执行脚本 (传递 FORCE_REMOUNT 参数)
              echo '  -> 执行 setup_rclone.sh...'
              chmod +x scripts/setup_rclone.sh
              sudo ./scripts/setup_rclone.sh \"$FORCE_REMOUNT\"
            "
            
            kill $TUNNEL_PID 2>/dev/null || true
          done
          
          echo "All deployments finished."

      - name: Summary
        run: |
          echo "## ☁️ Rclone 部署结果" >> $GITHUB_STEP_SUMMARY
          echo "目标: ARM64 实例" >> $GITHUB_STEP_SUMMARY
