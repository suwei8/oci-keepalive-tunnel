name: Deploy Cloudflare Tunnel SSH

on:
  workflow_dispatch:
    inputs:
      ssh_ip:
        description: 'è¿œç¨‹å®ä¾‹ IP åœ°å€'
        required: true
      ssh_password:
        description: 'SSH å¯†ç '
        required: true
      tunnel_tag_name:
        description: 'éš§é“æ ‡ç­¾åç§° (å¦‚ singapore-West9)'
        required: true
      ssh_username:
        description: 'SSH ç”¨æˆ·å'
        required: false
        default: 'root'

jobs:
  deploy:
    name: Deploy CF Tunnel SSH
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup SSH and tools
        run: |
          sudo apt-get update -qq && sudo apt-get install -y -qq sshpass jq
          mkdir -p ~/.ssh
          cat >> ~/.ssh/config << 'EOF'
          Host *
            StrictHostKeyChecking no
            UserKnownHostsFile /dev/null
            LogLevel ERROR
          EOF

      - name: Install cloudflared on remote host
        env:
          SSH_IP: ${{ github.event.inputs.ssh_ip }}
          SSH_USERNAME: ${{ github.event.inputs.ssh_username }}
          SSH_PASSWORD: ${{ github.event.inputs.ssh_password }}
        run: |
          SSH_OPTS="-o ConnectTimeout=30 -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR -o ServerAliveInterval=30"
          
          # å±è”½æ•æ„Ÿä¿¡æ¯
          echo "::add-mask::$SSH_IP"
          echo "::add-mask::$SSH_PASSWORD"
          
          echo ">>> å®‰è£… cloudflared..."
          sshpass -p "$SSH_PASSWORD" ssh $SSH_OPTS ${SSH_USERNAME}@${SSH_IP} '
            # æ·»åŠ  Cloudflare GPG å¯†é’¥
            sudo mkdir -p --mode=0755 /usr/share/keyrings
            curl -fsSL https://pkg.cloudflare.com/cloudflare-public-v2.gpg | sudo tee /usr/share/keyrings/cloudflare-public-v2.gpg >/dev/null
            
            # æ·»åŠ  repo åˆ° apt æº
            echo "deb [signed-by=/usr/share/keyrings/cloudflare-public-v2.gpg] https://pkg.cloudflare.com/cloudflared any main" | sudo tee /etc/apt/sources.list.d/cloudflared.list
            
            # å®‰è£… cloudflared
            sudo apt-get update && sudo apt-get install -y cloudflared
            
            # éªŒè¯å®‰è£…
            cloudflared --version
          '
          echo "âœ… cloudflared å®‰è£…å®Œæˆ"

      - name: Create Tunnel via Cloudflare API
        id: tunnel
        env:
          CF_ACCOUNT_ID: ${{ secrets.CF_ACCOUNT_ID }}
          CF_API_EMAIL: ${{ secrets.CF_API_EMAIL }}
          CF_API_KEY: ${{ secrets.CF_API_KEY }}
          TUNNEL_TAG_NAME: ${{ github.event.inputs.tunnel_tag_name }}
          SSH_IP: ${{ github.event.inputs.ssh_ip }}
        run: |
          # å±è”½æ•æ„Ÿä¿¡æ¯
          echo "::add-mask::$CF_ACCOUNT_ID"
          echo "::add-mask::$CF_API_KEY"
          echo "::add-mask::$SSH_IP"
          
          # ç”Ÿæˆéš§é“åç§°: {tunnel_tag_name}-{ssh_ip}
          TUNNEL_NAME="${TUNNEL_TAG_NAME}-${SSH_IP}"
          echo ">>> åˆ›å»º Tunnel: $TUNNEL_NAME"
          
          # åˆ›å»ºéš§é“
          CREATE_RESULT=$(curl -s -X POST "https://api.cloudflare.com/client/v4/accounts/${CF_ACCOUNT_ID}/cfd_tunnel" \
            -H "X-Auth-Email: ${CF_API_EMAIL}" \
            -H "X-Auth-Key: ${CF_API_KEY}" \
            -H "Content-Type: application/json" \
            -d "{\"name\": \"${TUNNEL_NAME}\", \"config_src\": \"cloudflare\"}")
          
          if echo "$CREATE_RESULT" | jq -e '.success' > /dev/null; then
            TUNNEL_ID=$(echo "$CREATE_RESULT" | jq -r '.result.id')
            echo "âœ… Tunnel åˆ›å»ºæˆåŠŸ"
          else
            echo "âš ï¸ åˆ›å»ºå¤±è´¥ï¼Œå°è¯•è·å–å·²å­˜åœ¨çš„ Tunnel..."
            # æ£€æŸ¥æ˜¯å¦å› é‡åå¤±è´¥ï¼Œå°è¯•è·å–å·²å­˜åœ¨çš„éš§é“
            TUNNEL_ID=$(curl -s "https://api.cloudflare.com/client/v4/accounts/${CF_ACCOUNT_ID}/cfd_tunnel?name=${TUNNEL_NAME}" \
              -H "X-Auth-Email: ${CF_API_EMAIL}" \
              -H "X-Auth-Key: ${CF_API_KEY}" | jq -r '.result[0].id // empty')
            if [ -n "$TUNNEL_ID" ]; then
              echo "âœ… ä½¿ç”¨å·²å­˜åœ¨çš„ Tunnel"
            else
              echo "âŒ æ— æ³•åˆ›å»ºæˆ–è·å– Tunnel"
              echo "$CREATE_RESULT" | jq '.errors'
              exit 1
            fi
          fi
          
          echo "::add-mask::$TUNNEL_ID"
          echo "tunnel_id=$TUNNEL_ID" >> $GITHUB_OUTPUT
          echo "tunnel_name=$TUNNEL_NAME" >> $GITHUB_OUTPUT

      - name: Get Tunnel Token
        id: token
        env:
          CF_ACCOUNT_ID: ${{ secrets.CF_ACCOUNT_ID }}
          CF_API_EMAIL: ${{ secrets.CF_API_EMAIL }}
          CF_API_KEY: ${{ secrets.CF_API_KEY }}
          TUNNEL_ID: ${{ steps.tunnel.outputs.tunnel_id }}
        run: |
          echo "::add-mask::$TUNNEL_ID"
          
          echo ">>> è·å– Tunnel Token..."
          TOKEN_RESULT=$(curl -s "https://api.cloudflare.com/client/v4/accounts/${CF_ACCOUNT_ID}/cfd_tunnel/${TUNNEL_ID}/token" \
            -H "X-Auth-Email: ${CF_API_EMAIL}" \
            -H "X-Auth-Key: ${CF_API_KEY}")
          
          TUNNEL_TOKEN=$(echo "$TOKEN_RESULT" | jq -r '.result // empty')
          
          if [ -z "$TUNNEL_TOKEN" ]; then
            echo "âŒ è·å– Tunnel Token å¤±è´¥"
            echo "$TOKEN_RESULT" | jq '.errors'
            exit 1
          fi
          
          echo "::add-mask::$TUNNEL_TOKEN"
          echo "tunnel_token=$TUNNEL_TOKEN" >> $GITHUB_OUTPUT
          echo "âœ… Tunnel Token è·å–æˆåŠŸ"

      - name: Install Tunnel service on remote host
        env:
          SSH_IP: ${{ github.event.inputs.ssh_ip }}
          SSH_USERNAME: ${{ github.event.inputs.ssh_username }}
          SSH_PASSWORD: ${{ github.event.inputs.ssh_password }}
          TUNNEL_TOKEN: ${{ steps.token.outputs.tunnel_token }}
        run: |
          SSH_OPTS="-o ConnectTimeout=30 -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR -o ServerAliveInterval=30"
          
          echo "::add-mask::$SSH_IP"
          echo "::add-mask::$SSH_PASSWORD"
          echo "::add-mask::$TUNNEL_TOKEN"
          
          echo ">>> å®‰è£… Tunnel æœåŠ¡..."
          sshpass -p "$SSH_PASSWORD" ssh $SSH_OPTS ${SSH_USERNAME}@${SSH_IP} "
            # åœæ­¢å¹¶åˆ é™¤å¯èƒ½å­˜åœ¨çš„æ—§æœåŠ¡
            sudo cloudflared service uninstall 2>/dev/null || true
            
            # å®‰è£… Tunnel æœåŠ¡
            sudo cloudflared service install ${TUNNEL_TOKEN}
            
            # ç­‰å¾…æœåŠ¡å¯åŠ¨
            sleep 5
            
            # æ£€æŸ¥æœåŠ¡çŠ¶æ€
            sudo systemctl status cloudflared --no-pager || true
          "
          echo "âœ… Tunnel æœåŠ¡å®‰è£…å®Œæˆ"

      - name: Configure SSH Public Hostname and DNS
        env:
          CF_ACCOUNT_ID: ${{ secrets.CF_ACCOUNT_ID }}
          CF_API_EMAIL: ${{ secrets.CF_API_EMAIL }}
          CF_API_KEY: ${{ secrets.CF_API_KEY }}
          CF_ZONE_ID: ${{ secrets.CF_ZONE_ID }}
          TUNNEL_ID: ${{ steps.tunnel.outputs.tunnel_id }}
          TUNNEL_TAG_NAME: ${{ github.event.inputs.tunnel_tag_name }}
        run: |
          echo "::add-mask::$TUNNEL_ID"
          echo "::add-mask::$CF_ZONE_ID"
          
          # SSH hostname æ ¼å¼: {tunnel_tag_name}-ssh.hhwpxh.com
          SSH_HOSTNAME="${TUNNEL_TAG_NAME}-ssh"
          FULL_HOSTNAME="${SSH_HOSTNAME}.hhwpxh.com"
          echo "::add-mask::$FULL_HOSTNAME"
          echo ">>> é…ç½® SSH Hostname: $FULL_HOSTNAME"
          
          # é…ç½® Tunnel ingress è§„åˆ™
          CONFIG_RESULT=$(curl -s -X PUT "https://api.cloudflare.com/client/v4/accounts/${CF_ACCOUNT_ID}/cfd_tunnel/${TUNNEL_ID}/configurations" \
            -H "X-Auth-Email: ${CF_API_EMAIL}" \
            -H "X-Auth-Key: ${CF_API_KEY}" \
            -H "Content-Type: application/json" \
            -d "{
              \"config\": {
                \"ingress\": [
                  {
                    \"hostname\": \"${FULL_HOSTNAME}\",
                    \"service\": \"ssh://localhost:22\"
                  },
                  {
                    \"service\": \"http_status:404\"
                  }
                ]
              }
            }")
          
          if echo "$CONFIG_RESULT" | jq -e '.success' > /dev/null; then
            echo "âœ… Ingress é…ç½®æˆåŠŸ"
          else
            echo "âŒ Ingress é…ç½®å¤±è´¥:"
            echo "$CONFIG_RESULT" | jq '.errors'
            exit 1
          fi
          
          # åˆ›å»º DNS CNAME è®°å½• (æŒ‡å‘éš§é“)
          echo ">>> åˆ›å»º DNS CNAME è®°å½•..."
          DNS_RECORD=$(curl -s "https://api.cloudflare.com/client/v4/zones/${CF_ZONE_ID}/dns_records?name=${FULL_HOSTNAME}" \
            -H "X-Auth-Email: ${CF_API_EMAIL}" \
            -H "X-Auth-Key: ${CF_API_KEY}" | jq -r '.result[0].id // empty')
          
          CNAME_TARGET="${TUNNEL_ID}.cfargotunnel.com"
          
          if [ -z "$DNS_RECORD" ]; then
            # åˆ›å»ºæ–°è®°å½•
            DNS_RESULT=$(curl -s -X POST "https://api.cloudflare.com/client/v4/zones/${CF_ZONE_ID}/dns_records" \
              -H "X-Auth-Email: ${CF_API_EMAIL}" \
              -H "X-Auth-Key: ${CF_API_KEY}" \
              -H "Content-Type: application/json" \
              -d "{
                \"type\": \"CNAME\",
                \"name\": \"${SSH_HOSTNAME}\",
                \"content\": \"${CNAME_TARGET}\",
                \"proxied\": true,
                \"ttl\": 1
              }")
            if echo "$DNS_RESULT" | jq -e '.success' > /dev/null; then
              echo "âœ… DNS CNAME è®°å½•å·²åˆ›å»º"
            else
              echo "âš ï¸ DNS è®°å½•åˆ›å»ºå¤±è´¥ (å¯èƒ½å·²å­˜åœ¨):"
              echo "$DNS_RESULT" | jq '.errors'
            fi
          else
            # æ›´æ–°ç°æœ‰è®°å½•
            echo ">>> DNS è®°å½•å·²å­˜åœ¨ï¼Œæ›´æ–°..."
            curl -s -X PUT "https://api.cloudflare.com/client/v4/zones/${CF_ZONE_ID}/dns_records/${DNS_RECORD}" \
              -H "X-Auth-Email: ${CF_API_EMAIL}" \
              -H "X-Auth-Key: ${CF_API_KEY}" \
              -H "Content-Type: application/json" \
              -d "{
                \"type\": \"CNAME\",
                \"name\": \"${SSH_HOSTNAME}\",
                \"content\": \"${CNAME_TARGET}\",
                \"proxied\": true,
                \"ttl\": 1
              }" > /dev/null
            echo "âœ… DNS CNAME è®°å½•å·²æ›´æ–°"
          fi
          
          # ç­‰å¾… DNS ä¼ æ’­å’Œé…ç½®ç”Ÿæ•ˆ
          echo ">>> ç­‰å¾…éš§é“è¿æ¥å»ºç«‹å’Œ DNS ä¼ æ’­..."
          sleep 15

      - name: Test Tunnel SSH Connection
        id: test
        env:
          SSH_USERNAME: ${{ github.event.inputs.ssh_username }}
          SSH_PASSWORD: ${{ github.event.inputs.ssh_password }}
          TUNNEL_TAG_NAME: ${{ github.event.inputs.tunnel_tag_name }}
        run: |
          echo "::add-mask::$SSH_PASSWORD"
          
          FULL_HOSTNAME="${TUNNEL_TAG_NAME}-ssh.hhwpxh.com"
          echo "::add-mask::$FULL_HOSTNAME"
          SSH_OPTS="-o ConnectTimeout=30 -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR"
          
          # å®‰è£… cloudflared
          sudo cp bin/cloudflared /usr/local/bin/cloudflared 2>/dev/null || \
            (curl -fsSL https://pkg.cloudflare.com/cloudflared-linux-amd64 -o /tmp/cloudflared && \
             chmod +x /tmp/cloudflared && sudo mv /tmp/cloudflared /usr/local/bin/cloudflared)
          
          echo ">>> æµ‹è¯•éš§é“ SSH è¿æ¥: $FULL_HOSTNAME"
          
          # å¯åŠ¨æœ¬åœ° SSH éš§é“
          cloudflared access ssh --hostname "$FULL_HOSTNAME" --url ssh://127.0.0.1:2202 &
          TUNNEL_PID=$!
          sleep 5
          
          # æµ‹è¯• SSH è¿æ¥
          if sshpass -p "$SSH_PASSWORD" ssh $SSH_OPTS -p 2202 ${SSH_USERNAME}@127.0.0.1 "echo 'SSH via Tunnel OK'"; then
            echo "âœ… éš§é“ SSH è¿æ¥æµ‹è¯•æˆåŠŸ"
            echo "connection_ok=true" >> $GITHUB_OUTPUT
          else
            echo "âŒ éš§é“ SSH è¿æ¥æµ‹è¯•å¤±è´¥"
            echo "connection_ok=false" >> $GITHUB_OUTPUT
          fi
          
          # æ¸…ç†éš§é“
          kill $TUNNEL_PID 2>/dev/null || true

      - name: Create regular user
        if: steps.test.outputs.connection_ok == 'true'
        env:
          SSH_IP: ${{ github.event.inputs.ssh_ip }}
          ROOT_USERNAME: ${{ github.event.inputs.ssh_username }}
          ROOT_PASSWORD: ${{ github.event.inputs.ssh_password }}
          NEW_USERNAME: ${{ secrets.SSH_USERNAME }}
          NEW_PASSWORD: ${{ secrets.SSH_PASSWORD }}
        run: |
          SSH_OPTS="-o ConnectTimeout=30 -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR"
          
          echo "::add-mask::$SSH_IP"
          echo "::add-mask::$ROOT_PASSWORD"
          echo "::add-mask::$NEW_PASSWORD"
          
          echo ">>> åˆ›å»ºæ™®é€šç”¨æˆ·: $NEW_USERNAME"
          sshpass -p "$ROOT_PASSWORD" ssh $SSH_OPTS ${ROOT_USERNAME}@${SSH_IP} "
            # æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å­˜åœ¨
            if id '${NEW_USERNAME}' &>/dev/null; then
              echo 'ç”¨æˆ· ${NEW_USERNAME} å·²å­˜åœ¨'
            else
              # åˆ›å»ºç”¨æˆ·
              sudo useradd -m -s /bin/bash '${NEW_USERNAME}'
              echo '${NEW_USERNAME}:${NEW_PASSWORD}' | sudo chpasswd
              echo 'âœ… ç”¨æˆ· ${NEW_USERNAME} å·²åˆ›å»º'
            fi
            
            # é…ç½®å…å¯† sudo
            echo '${NEW_USERNAME} ALL=(ALL) NOPASSWD:ALL' | sudo tee /etc/sudoers.d/${NEW_USERNAME}
            sudo chmod 440 /etc/sudoers.d/${NEW_USERNAME}
            echo 'âœ… å·²é…ç½®å…å¯† sudo'
          "

      - name: Send Telegram notification
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          SSH_IP: ${{ github.event.inputs.ssh_ip }}
          TUNNEL_TAG_NAME: ${{ github.event.inputs.tunnel_tag_name }}
          TUNNEL_NAME: ${{ steps.tunnel.outputs.tunnel_name }}
          NEW_USERNAME: ${{ secrets.SSH_USERNAME }}
          CONNECTION_OK: ${{ steps.test.outputs.connection_ok }}
        run: |
          if [ -z "$TELEGRAM_BOT_TOKEN" ] || [ -z "$TELEGRAM_CHAT_ID" ]; then
            echo "âš ï¸ Telegram æœªé…ç½®"
            exit 0
          fi
          
          echo "::add-mask::$SSH_IP"
          
          TIMESTAMP=$(date -u +'%Y-%m-%d %H:%M UTC')
          FULL_HOSTNAME="${TUNNEL_TAG_NAME}-ssh.hhwpxh.com"
          echo "::add-mask::$FULL_HOSTNAME"
          
          if [ "$CONNECTION_OK" = "true" ]; then
            STATUS_EMOJI="âœ…"
            STATUS_TEXT="æˆåŠŸ"
          else
            STATUS_EMOJI="âŒ"
            STATUS_TEXT="å¤±è´¥"
          fi
          
          MSG=$(printf "${STATUS_EMOJI} *Cloudflare Tunnel éƒ¨ç½²${STATUS_TEXT}*\n\nğŸ“… %s\nğŸ·ï¸ éš§é“åç§°: \`%s\`\nğŸŒ SSH Hostname: \`%s\`\n\nğŸ“ *è¿æ¥æ–¹å¼:*\n\`\`\`\ncloudflared access ssh --hostname %s --url ssh://127.0.0.1:2202\nssh -p 2202 %s@127.0.0.1\n\`\`\`" \
            "$TIMESTAMP" \
            "$TUNNEL_NAME" \
            "$FULL_HOSTNAME" \
            "$FULL_HOSTNAME" \
            "$NEW_USERNAME")
          
          # æ”¯æŒå¤šä¸ª chat_id (é€—å·åˆ†éš”)
          IFS=',' read -ra CHAT_IDS <<< "$TELEGRAM_CHAT_ID"
          for chat_id in "${CHAT_IDS[@]}"; do
            chat_id=$(echo "$chat_id" | xargs)
            if [ -n "$chat_id" ]; then
              curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
                -d chat_id="${chat_id}" \
                -d parse_mode="Markdown" \
                --data-urlencode "text=${MSG}" > /dev/null
            fi
          done
          
          echo "âœ… Telegram é€šçŸ¥å·²å‘é€"

      - name: Summary
        env:
          TUNNEL_NAME: ${{ steps.tunnel.outputs.tunnel_name }}
          TUNNEL_TAG_NAME: ${{ github.event.inputs.tunnel_tag_name }}
          CONNECTION_OK: ${{ steps.test.outputs.connection_ok }}
        run: |
          FULL_HOSTNAME="${TUNNEL_TAG_NAME}-ssh.hhwpxh.com"
          
          echo "## ğŸš€ Cloudflare Tunnel SSH éƒ¨ç½²ç»“æœ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "$CONNECTION_OK" = "true" ]; then
            echo "### âœ… éƒ¨ç½²æˆåŠŸ" >> $GITHUB_STEP_SUMMARY
          else
            echo "### âŒ éƒ¨ç½²å¤±è´¥æˆ–è¿æ¥æµ‹è¯•æœªé€šè¿‡" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| é¡¹ç›® | å€¼ |" >> $GITHUB_STEP_SUMMARY
          echo "|------|-----|" >> $GITHUB_STEP_SUMMARY
          echo "| éš§é“åç§° | \`$TUNNEL_NAME\` |" >> $GITHUB_STEP_SUMMARY
          echo "| SSH Hostname | \`$FULL_HOSTNAME\` |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### è¿æ¥æ–¹å¼" >> $GITHUB_STEP_SUMMARY
          echo '```bash' >> $GITHUB_STEP_SUMMARY
          echo "cloudflared access ssh --hostname $FULL_HOSTNAME --url ssh://127.0.0.1:2202" >> $GITHUB_STEP_SUMMARY
          echo "ssh -p 2202 <username>@127.0.0.1" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
