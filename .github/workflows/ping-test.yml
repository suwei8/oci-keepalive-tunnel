name: Ping Test All Instances

on:
  workflow_dispatch:
    inputs:
      ping_ip:
        description: '要 ping 的目标 IP 地址'
        required: true
        default: '1.1.1.1'

jobs:
  ping-test:
    name: "Host ${{ matrix.index }}"
    runs-on: ubuntu-latest
    timeout-minutes: 5
    strategy:
      fail-fast: false
      max-parallel: 10
      matrix:
        index: [0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29]

    steps:
      - name: Get host info from secrets
        id: host
        env:
          HOSTS_CONFIG_URL: ${{ secrets.HOSTS_CONFIG_URL }}
          HOST_INDEX: ${{ matrix.index }}
        run: |
          HOSTS_CONFIG=$(curl -s $HOSTS_CONFIG_URL) || true
          HOST_NAME=$(echo "$HOSTS_CONFIG" | jq -r ".[$HOST_INDEX].name")
          SSH_HOST=$(echo "$HOSTS_CONFIG" | jq -r ".[$HOST_INDEX].ssh_host")
          
          if [ "$HOST_NAME" = "null" ] || [ -z "$HOST_NAME" ]; then
            echo "skip=true" >> $GITHUB_OUTPUT
            echo "No host at index $HOST_INDEX"
            exit 0
          fi
          
          echo "skip=false" >> $GITHUB_OUTPUT
          echo "name=$HOST_NAME" >> $GITHUB_OUTPUT
          echo "ssh_host=$SSH_HOST" >> $GITHUB_OUTPUT
          echo "Host: $HOST_NAME ($SSH_HOST)"

      - name: Checkout repository
        if: steps.host.outputs.skip != 'true'
        uses: actions/checkout@v4

      - name: Install cloudflared
        if: steps.host.outputs.skip != 'true'
        run: |
          curl -sL https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64 -o /tmp/cloudflared
          chmod +x /tmp/cloudflared
          sudo mv /tmp/cloudflared /usr/local/bin/cloudflared

      - name: Setup SSH
        if: steps.host.outputs.skip != 'true'
        run: |
          mkdir -p ~/.ssh
          cat >> ~/.ssh/config << 'EOF'
          Host *
            StrictHostKeyChecking no
            UserKnownHostsFile /dev/null
            LogLevel ERROR
          EOF
          sudo apt-get update -qq && sudo apt-get install -y -qq sshpass

      - name: Run ping test
        if: steps.host.outputs.skip != 'true'
        id: ping
        env:
          SSH_USERNAME: ${{ secrets.SSH_USERNAME }}
          SSH_PASSWORD: ${{ secrets.SSH_PASSWORD }}
          HOST_NAME: ${{ steps.host.outputs.name }}
          SSH_HOST: ${{ steps.host.outputs.ssh_host }}
          PING_IP: ${{ github.event.inputs.ping_ip }}
        run: |
          echo "==========================================="
          echo "Ping test for: $HOST_NAME -> $PING_IP"
          echo "==========================================="
          
          SSH_OPTS="-o ConnectTimeout=30 -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR"
          
          # 启动 Cloudflare Tunnel
          cloudflared access ssh --hostname "$SSH_HOST" --url "ssh://127.0.0.1:2222" &
          TUNNEL_PID=$!
          sleep 5
          
          if ! kill -0 $TUNNEL_PID 2>/dev/null; then
            echo "❌ Tunnel failed"
            exit 1
          fi
          echo "✅ Tunnel established"
          
          # 执行 ping 测试 (10秒)
          PING_RESULT=$(sshpass -p "$SSH_PASSWORD" ssh $SSH_OPTS -p 2222 "${SSH_USERNAME}@127.0.0.1" \
            "ping -c 10 -W 1 $PING_IP 2>/dev/null | tail -1 | awk -F'/' '{print \$5}'" || echo "timeout")
          
          kill $TUNNEL_PID 2>/dev/null || true
          
          if [ -z "$PING_RESULT" ] || [ "$PING_RESULT" = "timeout" ]; then
            PING_RESULT="N/A"
          else
            PING_RESULT="${PING_RESULT}ms"
          fi
          
          echo "ping_result=$PING_RESULT" >> $GITHUB_OUTPUT
          echo "✅ Ping result: $PING_RESULT"

      - name: Save result to file
        if: steps.host.outputs.skip != 'true'
        env:
          HOST_NAME: ${{ steps.host.outputs.name }}
          PING_IP: ${{ github.event.inputs.ping_ip }}
          PING_RESULT: ${{ steps.ping.outputs.ping_result }}
        run: |
          mkdir -p ping_results
          SAFE_NAME=$(echo "$HOST_NAME" | tr ' ' '_')
          TIMESTAMP=$(date -u +"%Y-%m-%d %H:%M:%S")
          echo "${HOST_NAME},${PING_IP},${PING_RESULT},${TIMESTAMP}" > "ping_results/${SAFE_NAME}.txt"

      - name: Upload ping result artifact
        if: steps.host.outputs.skip != 'true'
        uses: actions/upload-artifact@v4
        with:
          name: ping-result-${{ matrix.index }}
          path: ping_results/*.txt
          if-no-files-found: ignore
          retention-days: 1

  # 收集所有 ping 结果
  collect:
    name: Collect Ping Results
    needs: ping-test
    if: always()
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download all ping result artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          pattern: ping-result-*
        continue-on-error: true

      - name: Merge results to CSV
        env:
          PING_IP: ${{ github.event.inputs.ping_ip }}
        run: |
          CSV_FILE="csv/ping_results.csv"
          mkdir -p csv
          
          # 创建 CSV 头 (如果不存在)
          if [ ! -f "$CSV_FILE" ]; then
            echo "name,ping-ip,time,timestamp" > "$CSV_FILE"
          fi
          
          # 合并所有结果
          if [ -d artifacts ]; then
            find artifacts -name "*.txt" -type f | while read result_file; do
              if [ -f "$result_file" ]; then
                cat "$result_file" >> "$CSV_FILE"
                echo "Added: $(cat "$result_file")"
              fi
            done
          fi
          
          echo ""
          echo "=== 最新结果 ==="
          tail -10 "$CSV_FILE"

      - name: Commit results
        run: |
          if [ -f csv/ping_results.csv ]; then
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git add csv/ping_results.csv
            git diff --staged --quiet || git commit -m "Update ping results $(date -u +%Y-%m-%d)"
            git push || echo "Nothing to push"
          fi

      - name: Summary
        env:
          PING_IP: ${{ github.event.inputs.ping_ip }}
        run: |
          echo "## Ping Test Results (Target: $PING_IP)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -f csv/ping_results.csv ]; then
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "name,ping-ip,time,timestamp" >> $GITHUB_STEP_SUMMARY
            tail -30 csv/ping_results.csv | grep "$PING_IP" | head -30 >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi
